<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ğŸ  é¦–é¡µ / Kubernetes / Prometheus
Prometheus # Intro # æ˜¯ä¸€ä¸ªé¢å‘äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„å¼€æºçš„ç›‘æ§&æŠ¥è­¦å·¥å…·ã€‚
å¼€æºï¼šç»§Kubernetesä¹‹åçš„ç¬¬äºŒä¸ªCNCFå¼€æºé¡¹ç›®ï¼ŒGoè¯­è¨€å¼€å‘ ç›‘æ§ï¼šé€šè¿‡HTTPæœåŠ¡å®šæ—¶ä»é…ç½®çš„ç›®æ ‡æ”¶é›†æŒ‡æ ‡æ•°æ®ï¼Œè¯†åˆ«æ•°æ®å±•ç¤ºè§„åˆ™ï¼Œå±•ç¤ºç›‘æ§ç³»ç»Ÿå’ŒæœåŠ¡æŒ‡æ ‡æ•°æ® æŠ¥è­¦ï¼šç›‘æ§åˆ°çš„æŒ‡æ ‡æ•°æ®è¾¾åˆ°æŸä¸€è®¾å®šå¥½çš„æ¡ä»¶æ—¶ï¼Œè§¦å‘æŠ¥è­¦æœºåˆ¶ æ—¶é—´åºåˆ—æ•°æ®åº“ï¼š æ—¶é—´åºåˆ—æ˜¯ç”±å”¯ä¸€çš„æŒ‡æ ‡åç§°ï¼ˆMetricsï¼‰å’Œä¸€ç»„æ ‡ç­¾ï¼ˆkey=valueï¼‰çš„å½¢å¼ç»„æˆ PromeQLï¼šåŸºäºPrometheusæ—¶é—´åºåˆ—æ•°æ®åº“çš„ä¸€ä¸ªçµæ´»çš„æŸ¥è¯¢è¯­è¨€ Prometheusçš„ç›‘æ§å¯¹è±¡ # èµ„æºç›‘æ§ï¼š
æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œåˆ™å¯ä»¥åšåˆ°å¯¹Kubernetes Nodeã€ Deployment ã€Podçš„èµ„æºåˆ©ç”¨ä»¥åŠapiserverï¼Œcontroller-managerï¼Œetcdç­‰ç»„ä»¶çš„ç›‘æ§ã€‚
åº”ç”¨ç›‘æ§ï¼š
ä¸šåŠ¡åº”ç”¨æš´éœ²ç«¯å£ä¾›Prometheusè°ƒç”¨å®ç°ç›‘æµ‹ï¼Œæ¯”å¦‚å®æ—¶çš„ç”¨æˆ·åœ¨çº¿äººæ•°ï¼Œæ•°æ®åº“çš„å½“å‰è¿æ¥æ•°ç­‰ã€‚
Prometheusä¼˜åŠ¿ # æ”¯æŒæœºå™¨èµ„æºå’ŒåŠ¨æ€é…ç½®çš„åº”ç”¨ç›‘æ§ï¼› å¤šç»´æ•°æ®æ”¶é›†å’ŒæŸ¥è¯¢ï¼› æœåŠ¡ç‹¬ç«‹ï¼Œå°‘ä¾èµ–ã€‚ Prometheusç»„ä»¶ # Prometheus Serverï¼šé‡‡é›†ç›‘æ§æ•°æ®ï¼Œå­˜å‚¨æ—¶åºæŒ‡æ ‡ï¼Œæä¾›æ•°æ®æŸ¥è¯¢ï¼› Prometheus Client SDKï¼šå¯¹æ¥å¼€å‘å·¥å…·åŒ…ï¼Œæä¾›è‡ªå®šä¹‰çš„æŒ‡æ ‡æ•°æ®ç­‰ï¼› Push Gatewayï¼šæ¨é€æŒ‡æ ‡æ•°æ®çš„ç½‘å…³ç»„ä»¶ï¼› Third-part Exporterï¼šå¤–éƒ¨æŒ‡æ ‡é‡‡é›†ç³»ç»Ÿï¼Œæš´éœ²æ¥å£ä¾›Prometheusé‡‡é›†ï¼› AlertManagerï¼šæŒ‡æ ‡æ•°æ®çš„åˆ†æå‘Šè­¦ç®¡ç†å™¨ï¼› Architecture overview # ä¸Šå›¾æ¥æºäºå®˜ç½‘ï¼š
å¤„ç†æµç¨‹ï¼š é…ç½®èµ„æºç›®æ ‡æˆ–åº”ç”¨æŠ“å–ï¼› æŠ“å–èµ„æºæˆ–åº”ç”¨æŒ‡æ ‡æ•°æ®ï¼› åˆ¶å®šæŠ¥è­¦è§„åˆ™ï¼Œæ¨é€æŠ¥è­¦ï¼› çµæ´»æŸ¥è¯¢è¯­è¨€ï¼Œç»“åˆGrafanaå±•ç¤º Installation & Start Up # 1. ä»¥æœåŠ¡è¿›ç¨‹è¿è¡ŒPrometheus # â€‹ åœ¨ubuntuç³»ç»Ÿä¸Šå®‰è£…Prometheusï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼
ç¬¬ä¸€ç§ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š
wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz tar xvfz prometheus-2.13.1.linux-amd64.tar.gz # å¯åŠ¨Prometheus cd prometheus-2."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/kubernetes/prometheus/"><meta property="og:site_name" content="ç§‹æ²³è½å¶"><meta property="og:title" content="ç§‹æ²³è½å¶"><meta property="og:description" content="ğŸ  é¦–é¡µ / Kubernetes / Prometheus
Prometheus # Intro # æ˜¯ä¸€ä¸ªé¢å‘äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„å¼€æºçš„ç›‘æ§&æŠ¥è­¦å·¥å…·ã€‚
å¼€æºï¼šç»§Kubernetesä¹‹åçš„ç¬¬äºŒä¸ªCNCFå¼€æºé¡¹ç›®ï¼ŒGoè¯­è¨€å¼€å‘ ç›‘æ§ï¼šé€šè¿‡HTTPæœåŠ¡å®šæ—¶ä»é…ç½®çš„ç›®æ ‡æ”¶é›†æŒ‡æ ‡æ•°æ®ï¼Œè¯†åˆ«æ•°æ®å±•ç¤ºè§„åˆ™ï¼Œå±•ç¤ºç›‘æ§ç³»ç»Ÿå’ŒæœåŠ¡æŒ‡æ ‡æ•°æ® æŠ¥è­¦ï¼šç›‘æ§åˆ°çš„æŒ‡æ ‡æ•°æ®è¾¾åˆ°æŸä¸€è®¾å®šå¥½çš„æ¡ä»¶æ—¶ï¼Œè§¦å‘æŠ¥è­¦æœºåˆ¶ æ—¶é—´åºåˆ—æ•°æ®åº“ï¼š æ—¶é—´åºåˆ—æ˜¯ç”±å”¯ä¸€çš„æŒ‡æ ‡åç§°ï¼ˆMetricsï¼‰å’Œä¸€ç»„æ ‡ç­¾ï¼ˆkey=valueï¼‰çš„å½¢å¼ç»„æˆ PromeQLï¼šåŸºäºPrometheusæ—¶é—´åºåˆ—æ•°æ®åº“çš„ä¸€ä¸ªçµæ´»çš„æŸ¥è¯¢è¯­è¨€ Prometheusçš„ç›‘æ§å¯¹è±¡ # èµ„æºç›‘æ§ï¼š
æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œåˆ™å¯ä»¥åšåˆ°å¯¹Kubernetes Nodeã€ Deployment ã€Podçš„èµ„æºåˆ©ç”¨ä»¥åŠapiserverï¼Œcontroller-managerï¼Œetcdç­‰ç»„ä»¶çš„ç›‘æ§ã€‚
åº”ç”¨ç›‘æ§ï¼š
ä¸šåŠ¡åº”ç”¨æš´éœ²ç«¯å£ä¾›Prometheusè°ƒç”¨å®ç°ç›‘æµ‹ï¼Œæ¯”å¦‚å®æ—¶çš„ç”¨æˆ·åœ¨çº¿äººæ•°ï¼Œæ•°æ®åº“çš„å½“å‰è¿æ¥æ•°ç­‰ã€‚
Prometheusä¼˜åŠ¿ # æ”¯æŒæœºå™¨èµ„æºå’ŒåŠ¨æ€é…ç½®çš„åº”ç”¨ç›‘æ§ï¼› å¤šç»´æ•°æ®æ”¶é›†å’ŒæŸ¥è¯¢ï¼› æœåŠ¡ç‹¬ç«‹ï¼Œå°‘ä¾èµ–ã€‚ Prometheusç»„ä»¶ # Prometheus Serverï¼šé‡‡é›†ç›‘æ§æ•°æ®ï¼Œå­˜å‚¨æ—¶åºæŒ‡æ ‡ï¼Œæä¾›æ•°æ®æŸ¥è¯¢ï¼› Prometheus Client SDKï¼šå¯¹æ¥å¼€å‘å·¥å…·åŒ…ï¼Œæä¾›è‡ªå®šä¹‰çš„æŒ‡æ ‡æ•°æ®ç­‰ï¼› Push Gatewayï¼šæ¨é€æŒ‡æ ‡æ•°æ®çš„ç½‘å…³ç»„ä»¶ï¼› Third-part Exporterï¼šå¤–éƒ¨æŒ‡æ ‡é‡‡é›†ç³»ç»Ÿï¼Œæš´éœ²æ¥å£ä¾›Prometheusé‡‡é›†ï¼› AlertManagerï¼šæŒ‡æ ‡æ•°æ®çš„åˆ†æå‘Šè­¦ç®¡ç†å™¨ï¼› Architecture overview # ä¸Šå›¾æ¥æºäºå®˜ç½‘ï¼š
å¤„ç†æµç¨‹ï¼š é…ç½®èµ„æºç›®æ ‡æˆ–åº”ç”¨æŠ“å–ï¼› æŠ“å–èµ„æºæˆ–åº”ç”¨æŒ‡æ ‡æ•°æ®ï¼› åˆ¶å®šæŠ¥è­¦è§„åˆ™ï¼Œæ¨é€æŠ¥è­¦ï¼› çµæ´»æŸ¥è¯¢è¯­è¨€ï¼Œç»“åˆGrafanaå±•ç¤º Installation & Start Up # 1. ä»¥æœåŠ¡è¿›ç¨‹è¿è¡ŒPrometheus # â€‹ åœ¨ubuntuç³»ç»Ÿä¸Šå®‰è£…Prometheusï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼
ç¬¬ä¸€ç§ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š
wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz tar xvfz prometheus-2.13.1.linux-amd64.tar.gz # å¯åŠ¨Prometheus cd prometheus-2."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="kubernetes"><meta property="article:modified_time" content="2024-06-13T15:37:18+08:00"><title>Prometheus | ç§‹æ²³è½å¶</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/kubernetes/prometheus/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.ce762fb68932f0feadf888de2ad0427787e1c69332520ee843401bdef2bb940d.js integrity="sha256-znYvtoky8P6t+IjeKtBCd4fhxpMyUg7oQ0Ab3vK7lA0=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script><link rel=stylesheet href=/css/syntax.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>ç§‹æ²³è½å¶</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=æœç´¢ aria-label=æœç´¢ maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><p>ğŸ¦‰ é›†ä¸­èµ·æ¥çš„æ„å¿—å¯ä»¥å‡»ç©¿é¡½çŸ³ã€‚</p><hr><ul><li><p><a href=/><strong>ğŸ  é¦–é¡µ</strong></a></p></li><li><p><strong>ğŸ“Œ ç½®é¡¶æ–‡ç« </strong></p><ul><li><a href=/git/common-usage/>Git å¸¸ç”¨</a></li><li><a href=/kubernetes/kubeadm-install-k8s-docker/>å®‰è£… Kubernetes (Docker)</a></li></ul></li><li><p><strong>ğŸ“Œ ç½®é¡¶åˆ†ç±»</strong></p><ul><li><a href=/go/>Golang ç¼–ç¨‹</a></li><li><a href=/kubernetes/>Kubernetes</a></li><li><a href=/rust/>Rust ç¼–ç¨‹</a></li><li><a href=/git/>Git</a></li></ul></li></ul><hr><ul><li><strong>ğŸ—ƒï¸ å¼€æºé¡¹ç›®</strong><ul><li><a href=https://github.com/ketches/registry-proxy>registry-proxy</a></li><li><a href=https://github.com/poneding/mdi>mdi</a></li></ul></li></ul><hr><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>ğŸ™ GitHub</a></li><li><a href=mailto:poneding@gmail.com target=_blank rel=noopener>ğŸ“¬ é‚®ç®±</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Prometheus</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#prometheusçš„ç›‘æ§å¯¹è±¡>Prometheusçš„ç›‘æ§å¯¹è±¡</a></li><li><a href=#prometheusä¼˜åŠ¿>Prometheusä¼˜åŠ¿</a></li><li><a href=#prometheusç»„ä»¶>Prometheusç»„ä»¶</a></li></ul></li><li><a href=#architecture-overview>Architecture overview</a></li><li><a href=#installation--start-up>Installation & Start Up</a><ul><li><a href=#1-ä»¥æœåŠ¡è¿›ç¨‹è¿è¡Œprometheus>1. ä»¥æœåŠ¡è¿›ç¨‹è¿è¡ŒPrometheus</a></li><li><a href=#2dockerå¯åŠ¨prometheus>2.Dockerå¯åŠ¨Prometheus</a></li><li><a href=#3-kubernetesè¿è¡Œprometheus>3. Kubernetesè¿è¡ŒPrometheus</a></li><li><a href=#4å®˜æ–¹kubernetsè¿è¡Œprometheus>4.å®˜æ–¹kubernetsè¿è¡ŒPrometheus</a></li><li><a href=#5kuberneteséƒ¨ç½²prometheusgrafana>5.Kuberneteséƒ¨ç½²Prometheus+Grafana</a></li></ul></li><li><a href=#configuring-prometheus>Configuring Prometheus</a></li><li><a href=#concepts>Concepts</a><ul><li><a href=#metrics>Metrics</a></li></ul></li><li><a href=#å­˜å‚¨>å­˜å‚¨</a><ul><li><a href=#æœ¬åœ°å­˜å‚¨>æœ¬åœ°å­˜å‚¨</a></li><li><a href=#è¿œç¨‹å­˜å‚¨>è¿œç¨‹å­˜å‚¨</a></li></ul></li><li><a href=#è”é‚¦é›†ç¾¤>è”é‚¦é›†ç¾¤</a><ul><li><a href=#ä½¿ç”¨åœºæ™¯>ä½¿ç”¨åœºæ™¯</a></li><li><a href=#åˆ†å±‚è”é‚¦>åˆ†å±‚è”é‚¦</a></li><li><a href=#è·¨æœåŠ¡è”é‚¦>è·¨æœåŠ¡è”é‚¦</a></li><li><a href=#é…ç½®è”é‚¦>é…ç½®è”é‚¦</a></li></ul></li><li><a href=#monitor-app>Monitor App</a><ul><li><a href=#mssql>MSSQL</a></li></ul></li><li><a href=#solved>solved</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>ğŸ  é¦–é¡µ</a> /
<a href=/kubernetes/>Kubernetes</a> / Prometheus</p><h1 id=prometheus>Prometheus
<a class=anchor href=#prometheus>#</a></h1><h2 id=intro>Intro
<a class=anchor href=#intro>#</a></h2><p>æ˜¯ä¸€ä¸ªé¢å‘äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„å¼€æºçš„<strong>ç›‘æ§</strong>&<strong>æŠ¥è­¦</strong>å·¥å…·ã€‚</p><blockquote><ul><li>å¼€æºï¼šç»§Kubernetesä¹‹åçš„ç¬¬äºŒä¸ªCNCFå¼€æºé¡¹ç›®ï¼ŒGoè¯­è¨€å¼€å‘</li><li>ç›‘æ§ï¼šé€šè¿‡HTTPæœåŠ¡å®šæ—¶ä»é…ç½®çš„ç›®æ ‡æ”¶é›†æŒ‡æ ‡æ•°æ®ï¼Œè¯†åˆ«æ•°æ®å±•ç¤ºè§„åˆ™ï¼Œå±•ç¤ºç›‘æ§ç³»ç»Ÿå’ŒæœåŠ¡æŒ‡æ ‡æ•°æ®</li><li>æŠ¥è­¦ï¼šç›‘æ§åˆ°çš„æŒ‡æ ‡æ•°æ®è¾¾åˆ°æŸä¸€è®¾å®šå¥½çš„æ¡ä»¶æ—¶ï¼Œè§¦å‘æŠ¥è­¦æœºåˆ¶</li><li>æ—¶é—´åºåˆ—æ•°æ®åº“ï¼š æ—¶é—´åºåˆ—æ˜¯ç”±å”¯ä¸€çš„æŒ‡æ ‡åç§°ï¼ˆMetricsï¼‰å’Œä¸€ç»„æ ‡ç­¾ï¼ˆkey=valueï¼‰çš„å½¢å¼ç»„æˆ</li><li>PromeQLï¼šåŸºäºPrometheusæ—¶é—´åºåˆ—æ•°æ®åº“çš„ä¸€ä¸ªçµæ´»çš„æŸ¥è¯¢è¯­è¨€</li></ul></blockquote><h3 id=prometheusçš„ç›‘æ§å¯¹è±¡>Prometheusçš„ç›‘æ§å¯¹è±¡
<a class=anchor href=#prometheus%e7%9a%84%e7%9b%91%e6%8e%a7%e5%af%b9%e8%b1%a1>#</a></h3><ul><li><p><strong>èµ„æºç›‘æ§</strong>ï¼š</p><p>æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œåˆ™å¯ä»¥åšåˆ°å¯¹Kubernetes Nodeã€ Deployment ã€Podçš„èµ„æºåˆ©ç”¨ä»¥åŠapiserverï¼Œcontroller-managerï¼Œetcdç­‰ç»„ä»¶çš„ç›‘æ§ã€‚</p></li><li><p><strong>åº”ç”¨ç›‘æ§</strong>ï¼š</p><p>ä¸šåŠ¡åº”ç”¨æš´éœ²ç«¯å£ä¾›Prometheusè°ƒç”¨å®ç°ç›‘æµ‹ï¼Œæ¯”å¦‚å®æ—¶çš„ç”¨æˆ·åœ¨çº¿äººæ•°ï¼Œæ•°æ®åº“çš„å½“å‰è¿æ¥æ•°ç­‰ã€‚</p></li></ul><h3 id=prometheusä¼˜åŠ¿>Prometheusä¼˜åŠ¿
<a class=anchor href=#prometheus%e4%bc%98%e5%8a%bf>#</a></h3><ul><li>æ”¯æŒæœºå™¨èµ„æºå’ŒåŠ¨æ€é…ç½®çš„åº”ç”¨ç›‘æ§ï¼›</li><li>å¤šç»´æ•°æ®æ”¶é›†å’ŒæŸ¥è¯¢ï¼›</li><li>æœåŠ¡ç‹¬ç«‹ï¼Œå°‘ä¾èµ–ã€‚</li></ul><h3 id=prometheusç»„ä»¶>Prometheusç»„ä»¶
<a class=anchor href=#prometheus%e7%bb%84%e4%bb%b6>#</a></h3><ul><li><strong>Prometheus Server</strong>ï¼šé‡‡é›†ç›‘æ§æ•°æ®ï¼Œå­˜å‚¨æ—¶åºæŒ‡æ ‡ï¼Œæä¾›æ•°æ®æŸ¥è¯¢ï¼›</li><li><strong>Prometheus Client SDK</strong>ï¼šå¯¹æ¥å¼€å‘å·¥å…·åŒ…ï¼Œæä¾›è‡ªå®šä¹‰çš„æŒ‡æ ‡æ•°æ®ç­‰ï¼›</li><li><strong>Push Gateway</strong>ï¼šæ¨é€æŒ‡æ ‡æ•°æ®çš„ç½‘å…³ç»„ä»¶ï¼›</li><li><strong>Third-part Exporter</strong>ï¼šå¤–éƒ¨æŒ‡æ ‡é‡‡é›†ç³»ç»Ÿï¼Œæš´éœ²æ¥å£ä¾›Prometheusé‡‡é›†ï¼›</li><li><strong>AlertManager</strong>ï¼šæŒ‡æ ‡æ•°æ®çš„åˆ†æå‘Šè­¦ç®¡ç†å™¨ï¼›</li></ul><h2 id=architecture-overview>Architecture overview
<a class=anchor href=#architecture-overview>#</a></h2><p><img src=https://fs.poneding.com/images/architecture.png alt="Prometheus architecture"></p><p><em>ä¸Šå›¾æ¥æºäºå®˜ç½‘</em>ï¼š</p><ul><li><strong>å¤„ç†æµç¨‹</strong>ï¼š<ol><li>é…ç½®èµ„æºç›®æ ‡æˆ–åº”ç”¨æŠ“å–ï¼›</li><li>æŠ“å–èµ„æºæˆ–åº”ç”¨æŒ‡æ ‡æ•°æ®ï¼›</li><li>åˆ¶å®šæŠ¥è­¦è§„åˆ™ï¼Œæ¨é€æŠ¥è­¦ï¼›</li><li>çµæ´»æŸ¥è¯¢è¯­è¨€ï¼Œç»“åˆGrafanaå±•ç¤º</li></ol></li></ul><h2 id=installation--start-up>Installation & Start Up
<a class=anchor href=#installation--start-up>#</a></h2><h3 id=1-ä»¥æœåŠ¡è¿›ç¨‹è¿è¡Œprometheus>1. ä»¥æœåŠ¡è¿›ç¨‹è¿è¡ŒPrometheus
<a class=anchor href=#1-%e4%bb%a5%e6%9c%8d%e5%8a%a1%e8%bf%9b%e7%a8%8b%e8%bf%90%e8%a1%8cprometheus>#</a></h3><p>â€‹ åœ¨ubuntuç³»ç»Ÿä¸Šå®‰è£…Prometheusï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼</p><ul><li><p>ç¬¬ä¸€ç§ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz
</span></span><span class=line><span class=cl>tar xvfz prometheus-2.13.1.linux-amd64.tar.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨Prometheus</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> prometheus-2.13.1.linux-amd64
</span></span><span class=line><span class=cl>./prometheus
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœæ­¢Prometheus</span>
</span></span><span class=line><span class=cl>ps -ef <span class=p>|</span> grep prometheus <span class=c1># å®šä½Prometheusè¿›ç¨‹çš„pid</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -s <span class=m>9</span> <span class=o>[</span>pid<span class=o>]</span>
</span></span></code></pre></div></li><li><p>ç¬¬äºŒç§ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼ˆubuntuç³»ç»Ÿï¼‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://s3-eu-west-1.amazonaws.com/deb.robustperception.io/41EFC99D.gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl>sudo apt-get update -y
</span></span><span class=line><span class=cl>sudo apt-get install prometheus prometheus-node-exporter prometheus-pushgateway prometheus-alertmanager -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨Prometheus</span>
</span></span><span class=line><span class=cl>sudo systemctl start prometheus
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> prometheus
</span></span><span class=line><span class=cl>sudo systemctl status prometheus
</span></span></code></pre></div></li></ul><h4 id=service-proxy><strong>Service Proxy</strong>
<a class=anchor href=#service-proxy>#</a></h4><p>é»˜è®¤Prometheusçš„è®¿é—®æ–¹å¼æ˜¯http://{ip/domain-name}:9090ï¼Œè€ŒæœåŠ¡å™¨ä¸€èˆ¬çš„æ˜¯ä¸ä¼šæš´éœ²9090ç«¯å£çš„ï¼Œè€Œæ˜¯æš´éœ²80ç«¯å£ï¼Œå…¶ä»–ç«¯å£ä»¥nginxä»£ç†è®¿é—®ã€‚</p><p>ä¸‹é¢çš„æ­¥éª¤ä¾¿æ˜¯å°†http://{ip/domain-name}:9090ä»£ç†ä¸ºhttp://{ip/domain-name}/prometheus</p><ul><li><p>â€‹ <strong>Step 1 é…ç½®prometheus</strong>ï¼š</p><ul><li><p>é…ç½®&ndash;web.external-url</p><p><strong>å¦‚æœæ˜¯ç¬¬ä¸€ç§æ–¹å¼å®‰è£…çš„Prometheus</strong>ï¼Œåˆ™å¯åŠ¨Prometheusçš„å‘½ä»¤è¡Œéœ€è¦é™„å¸¦&ndash;web.external-url=prometheusï¼Œå®Œæ•´å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./prometheus --web.external-url<span class=o>=</span>prometheus
</span></span></code></pre></div><p><strong>å¦‚æœæ˜¯ç¬¬äºŒç§æ–¹å¼å®‰è£…çš„Prometheus</strong>ï¼Œåˆ™éœ€è¦åœ¨/etc/default/prometheusæ–‡ä»¶åœ¨<code>ARGS=""</code>ä¸­æ·»åŠ å‚æ•°<code>--web.external-url=prometheus</code>ï¼Œæ·»åŠ å®Œä¹‹åï¼Œæ–‡ä»¶åº”è¯¥æ˜¯åƒä¸‹é¢è¿™æ ·çš„ï¼š</p><p><img src=https://fs.poneding.com/images/image-20191115102431554.png alt=image-20191115102431554></p></li><li><p>é‡å¯prometheus</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart prometheus
</span></span></code></pre></div><p>é‡å¯ä¹‹åï¼Œhttp://{ip/domain-name}:9090/prometheuså¯ä»¥è®¿é—®ã€‚</p></li></ul></li><li><p>â€‹ <strong>Step 2 é…ç½®nginx</strong>ï¼š</p><p>é»˜è®¤æœåŠ¡å™¨å·²ç»å®‰è£…äº†nginxã€‚</p><ul><li><p>nginx.confæ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ä»¥ä¸‹è¡Œï¼š</p><p><code>#include /etc/nginx/sites-enabled/*;</code></p></li><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/nginx/conf.d/prometheus.conf
</span></span></code></pre></div><p>åœ¨æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    location /prometheus <span class=o>{</span>
</span></span><span class=line><span class=cl>        proxy_set_header X-Forwarded-For <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        proxy_set_header Host <span class=nv>$http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        proxy_redirect off<span class=p>;</span>
</span></span><span class=line><span class=cl>        proxy_pass   http://172.31.23.19:9090/prometheus<span class=p>;</span>
</span></span><span class=line><span class=cl>        break<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></li><li><p>é‡å¯nginx</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart nginx.service
</span></span></code></pre></div><p>é‡å¯ä¹‹åï¼Œhttp://{ip/domain-name}/prometheuså¯ä»¥è®¿é—®ã€‚</p></li></ul></li></ul><h4 id=åœæ­¢prometheus>åœæ­¢Prometheus
<a class=anchor href=#%e5%81%9c%e6%ad%a2prometheus>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl stop prometheus
</span></span></code></pre></div><h3 id=2dockerå¯åŠ¨prometheus>2.Dockerå¯åŠ¨Prometheus
<a class=anchor href=#2docker%e5%90%af%e5%8a%a8prometheus>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run --name prometheus -d -p 127.0.0.1:9090:9090 prom/prometheus
</span></span></code></pre></div><h3 id=3-kubernetesè¿è¡Œprometheus>3. Kubernetesè¿è¡ŒPrometheus
<a class=anchor href=#3-kubernetes%e8%bf%90%e8%a1%8cprometheus>#</a></h3><h4 id=configmap>ConfigMap
<a class=anchor href=#configmap>#</a></h4><p>Prometheusçš„é…ç½®æ–‡ä»¶</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ns-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global: 
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_timeout: 15s
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;prometheus&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - targets: [&#39;localhost:9090&#39;]</span><span class=w>    
</span></span></span></code></pre></div><h4 id=deployment>Deployment
<a class=anchor href=#deployment>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>app/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ns-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;--config.file=/etc/prometheus/prometheus.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;--storage.tsdb.path=/prometheus&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;--storage.tsdb.retention=7d&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;--web.enable-admin-api&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;--web.enable-lifecycle&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/prometheus&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/prometheus&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span></code></pre></div><h4 id=persistentvolumeclaim>PersistentVolumeClaim
<a class=anchor href=#persistentvolumeclaim>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ns-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;rook-ceph-block&#34;</span><span class=w>
</span></span></span></code></pre></div><h4 id=serviceaccount>ServiceAccount
<a class=anchor href=#serviceaccount>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ns-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span></code></pre></div><h4 id=service>Service
<a class=anchor href=#service>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ns-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span></code></pre></div><h4 id=apply>Apply
<a class=anchor href=#apply>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get svc -o wide -n ns-prometheus
</span></span></code></pre></div><h3 id=4å®˜æ–¹kubernetsè¿è¡Œprometheus>4.å®˜æ–¹kubernetsè¿è¡ŒPrometheus
<a class=anchor href=#4%e5%ae%98%e6%96%b9kubernets%e8%bf%90%e8%a1%8cprometheus>#</a></h3><p>å‚è€ƒï¼š
<a href=https://github.com/coreos/kube-prometheus>https://github.com/coreos/kube-prometheus</a></p><h3 id=5kuberneteséƒ¨ç½²prometheusgrafana>5.Kuberneteséƒ¨ç½²Prometheus+Grafana
<a class=anchor href=#5kubernetes%e9%83%a8%e7%bd%b2prometheusgrafana>#</a></h3><ul><li>ä¸‹è½½ç›¸å…³k8sèµ„æºæ–‡ä»¶</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone https://github.com/coreos/kube-prometheus.git
</span></span></code></pre></div><ul><li><p>ä¿®æ”¹æ–‡ä»¶kube-prometheus/manifests/prometheus-prometheus.yamlï¼Œåšè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºprometheusçš„è®¿é—®åˆ†é…å­è·¯å¾„ï¼Œè®¿é—®æ–¹å¼ä¸ºhttp(s)://xxx/prometheus</p><p>åœ¨prometheus.specä¸‹æ·»åŠ </p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>externalUrl</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>routePrefix</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span></code></pre></div><ul><li><p>ä¿®æ”¹æ–‡ä»¶kube-prometheus/manifests/grafana-deployment.yamlï¼Œåšè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºgrafanaçš„è®¿é—®åˆ†é…å­è·¯å¾„ï¼Œè®¿é—®æ–¹å¼ä¸ºï¼šhttp(s)://xxx/grafana</p><p>åœ¨deployment.spec.template.spec.container[0]ä¸‹æ·»åŠ </p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SERVER_ROOT_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://localhost:3000/grafana&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SERVER_SERVE_FROM_SUB_PATH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span></code></pre></div><ul><li>Apply k8sèµ„æº</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># å¯èƒ½éœ€è¦è¿è¡Œå¤šæ¬¡ä»¥ä¸‹å‘½ä»¤ï¼Œç¡®ä¿k8sèµ„æºéƒ½åˆ›å»º</span>
</span></span><span class=line><span class=cl>kubectl create -f manifests/setup -f manifests
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># !å¦‚æœè¦åˆ é™¤ä»¥ä¸Šåˆ›å»ºçš„k8sèµ„æºï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤</span>
</span></span><span class=line><span class=cl>kubectl delete --ignore-not-found<span class=o>=</span><span class=nb>true</span> -f manifests/ -f manifests/setup
</span></span></code></pre></div><ul><li>Ingressè½¬å‘</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiVersion: extensions/v1beta1
</span></span><span class=line><span class=cl>kind: Ingress
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: prometheus
</span></span><span class=line><span class=cl>  namespace: monitoring
</span></span><span class=line><span class=cl>spec: 
</span></span><span class=line><span class=cl>  rules:
</span></span><span class=line><span class=cl>  - host: dp.example.tech
</span></span><span class=line><span class=cl>    http:
</span></span><span class=line><span class=cl>      paths:
</span></span><span class=line><span class=cl>      - path: /prometheus
</span></span><span class=line><span class=cl>        backend:
</span></span><span class=line><span class=cl>          serviceName: prometheus-k8s
</span></span><span class=line><span class=cl>          servicePort: <span class=m>9090</span>
</span></span><span class=line><span class=cl>      - path: /grafana
</span></span><span class=line><span class=cl>        backend:
</span></span><span class=line><span class=cl>          serviceName: grafana
</span></span><span class=line><span class=cl>          servicePort: <span class=m>3000</span>
</span></span><span class=line><span class=cl>      - path: /alertmanager
</span></span><span class=line><span class=cl>        backend:
</span></span><span class=line><span class=cl>          serviceName: alertmanager-main
</span></span><span class=line><span class=cl>          servicePort: <span class=m>9093</span>
</span></span></code></pre></div><ul><li><ul><li></li></ul></li></ul><h2 id=configuring-prometheus>Configuring Prometheus
<a class=anchor href=#configuring-prometheus>#</a></h2><p>â€‹ é…ç½®æ–‡ä»¶ä¸ºprometheus.ymlï¼Œæ–‡ä»¶æ ¼å¼ä¸ºyamlã€‚</p><h2 id=concepts>Concepts
<a class=anchor href=#concepts>#</a></h2><h3 id=metrics>Metrics
<a class=anchor href=#metrics>#</a></h3><h2 id=å­˜å‚¨>å­˜å‚¨
<a class=anchor href=#%e5%ad%98%e5%82%a8>#</a></h2><p>Prometheus 2.x é»˜è®¤å°†æ—¶é—´åºåˆ—æ•°æ®åº“ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜ä¸­ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°ä»»æ„ç¬¬ä¸‰æ–¹çš„å­˜å‚¨æœåŠ¡ä¸­ã€‚</p><h3 id=æœ¬åœ°å­˜å‚¨>æœ¬åœ°å­˜å‚¨
<a class=anchor href=#%e6%9c%ac%e5%9c%b0%e5%ad%98%e5%82%a8>#</a></h3><p>Prometheus é‡‡ç”¨è‡ªå®šä¹‰çš„å­˜å‚¨æ ¼å¼å°†æ ·æœ¬æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜å½“ä¸­ã€‚</p><h4 id=å­˜å‚¨æ ¼å¼>å­˜å‚¨æ ¼å¼
<a class=anchor href=#%e5%ad%98%e5%82%a8%e6%a0%bc%e5%bc%8f>#</a></h4><p>Prometheus æŒ‰ç…§ä¸¤ä¸ªå°æ—¶ä¸ºä¸€ä¸ªæ—¶é—´çª—å£ï¼Œå°†ä¸¤å°æ—¶å†…äº§ç”Ÿçš„æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªå—ï¼ˆBlockï¼‰ä¸­ã€‚æ¯ä¸ªå—éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç›®å½•ï¼Œé‡Œé¢å«è¯¥æ—¶é—´çª—å£å†…çš„æ‰€æœ‰æ ·æœ¬æ•°æ®ï¼ˆchunksï¼‰ï¼Œå…ƒæ•°æ®æ–‡ä»¶ï¼ˆmeta.jsonï¼‰ä»¥åŠç´¢å¼•æ–‡ä»¶ï¼ˆindexï¼‰ã€‚å…¶ä¸­ç´¢å¼•æ–‡ä»¶ä¼šå°†æŒ‡æ ‡åç§°å’Œæ ‡ç­¾ç´¢å¼•åˆ°æ ·æ¿æ•°æ®çš„æ—¶é—´åºåˆ—ä¸­ã€‚æ­¤æœŸé—´å¦‚æœé€šè¿‡ API åˆ é™¤æ—¶é—´åºåˆ—ï¼Œåˆ é™¤è®°å½•ä¼šä¿å­˜åœ¨å•ç‹¬çš„é€»è¾‘æ–‡ä»¶ <code>tombstone</code> å½“ä¸­ã€‚</p><p>å½“å‰æ ·æœ¬æ•°æ®æ‰€åœ¨çš„å—ä¼šè¢«ç›´æ¥ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚ä¸ºäº†ç¡®ä¿ Prometheus å‘ç”Ÿå´©æºƒæˆ–é‡å¯æ—¶èƒ½å¤Ÿæ¢å¤æ•°æ®ï¼ŒPrometheus å¯åŠ¨æ—¶ä¼šé€šè¿‡é¢„å†™æ—¥å¿—ï¼ˆwrite-ahead-log(WAL)ï¼‰é‡æ–°è®°å½•ï¼Œä»è€Œæ¢å¤æ•°æ®ã€‚é¢„å†™æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ <code>wal</code> ç›®å½•ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶å¤§å°ä¸º <code>128MB</code>ã€‚wal æ–‡ä»¶åŒ…æ‹¬è¿˜æ²¡æœ‰è¢«å‹ç¼©çš„åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥æ¯”å¸¸è§„çš„å—æ–‡ä»¶å¤§å¾—å¤šã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPrometheus ä¼šä¿ç•™ä¸‰ä¸ª wal æ–‡ä»¶ï¼Œä½†å¦‚æœæœ‰äº›é«˜è´Ÿè½½æœåŠ¡å™¨éœ€è¦ä¿å­˜ä¸¤ä¸ªå°æ—¶ä»¥ä¸Šçš„åŸå§‹æ•°æ®ï¼Œwal æ–‡ä»¶çš„æ•°é‡å°±ä¼šå¤§äº 3 ä¸ªã€‚</p><p>Prometheusä¿å­˜å—æ•°æ®çš„ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>rometheus æä¾›äº†å‡ ä¸ªå‚æ•°æ¥ä¿®æ”¹æœ¬åœ°å­˜å‚¨çš„é…ç½®ï¼Œæœ€ä¸»è¦çš„æœ‰ï¼š
</span></span><span class=line><span class=cl>å¯åŠ¨å‚æ•°
</span></span><span class=line><span class=cl>é»˜è®¤å€¼
</span></span><span class=line><span class=cl>å«ä¹‰
</span></span><span class=line><span class=cl>--storage.tsdb.path
</span></span><span class=line><span class=cl>/data
</span></span><span class=line><span class=cl>æ•°æ®å­˜å‚¨è·¯å¾„
</span></span><span class=line><span class=cl>--storage.tsdb.retention.time
</span></span><span class=line><span class=cl>15d
</span></span><span class=line><span class=cl>æ ·æœ¬æ•°æ®åœ¨å­˜å‚¨ä¸­ä¿å­˜çš„æ—¶é—´ã€‚è¶…è¿‡è¯¥æ—¶é—´é™åˆ¶çš„æ•°æ®å°±ä¼šè¢«åˆ é™¤ã€‚
</span></span><span class=line><span class=cl>--storage.tsdb.retention.size
</span></span><span class=line><span class=cl>0
</span></span><span class=line><span class=cl>æ¯ä¸ªå—çš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆä¸åŒ…æ‹¬ wal æ–‡ä»¶ï¼‰ã€‚å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œæœ€æ—©çš„æ ·æœ¬æ•°æ®ä¼šè¢«ä¼˜å…ˆåˆ é™¤ã€‚æ”¯æŒçš„å•ä½æœ‰ KB, MB, GB, PBï¼Œä¾‹å¦‚ï¼šâ€œ512MBâ€ã€‚è¯¥å‚æ•°åªæ˜¯è¯•éªŒæ€§çš„ï¼Œå¯èƒ½ä¼šåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­è¢«ç§»é™¤ã€‚
</span></span><span class=line><span class=cl>--storage.tsdb.retention
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>è¯¥å‚æ•°ä» 2.7 ç‰ˆæœ¬å¼€å§‹å·²ç»è¢«å¼ƒç”¨ï¼Œä½¿ç”¨ --storage.tsdb.retention.time å‚æ•°æ›¿ä»£
</span></span><span class=line><span class=cl>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPrometheus ä¸­å­˜å‚¨çš„æ¯ä¸€ä¸ªæ ·æœ¬å¤§æ¦‚å ç”¨1-2å­—èŠ‚å¤§å°ã€‚å¦‚æœéœ€è¦å¯¹ Prometheus Server çš„æœ¬åœ°ç£ç›˜ç©ºé—´åšå®¹é‡è§„åˆ’æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š./data 
</span></span><span class=line><span class=cl>   |- 01BKGV7JBM69T2G1BGBGM6KB12 # å—
</span></span><span class=line><span class=cl>      |- meta.json  # å…ƒæ•°æ®
</span></span><span class=line><span class=cl>      |- wal        # å†™å…¥æ—¥å¿—
</span></span><span class=line><span class=cl>        |- 000002
</span></span><span class=line><span class=cl>        |- 000001
</span></span><span class=line><span class=cl>   |- 01BKGTZQ1SYQJTR4PB43C8PD98  # å—
</span></span><span class=line><span class=cl>      |- meta.json  #å…ƒæ•°æ®
</span></span><span class=line><span class=cl>      |- index   # ç´¢å¼•æ–‡ä»¶
</span></span><span class=line><span class=cl>      |- chunks  # æ ·æœ¬æ•°æ®
</span></span><span class=line><span class=cl>        |- 000001
</span></span><span class=line><span class=cl>      |- tombstones # é€»è¾‘æ•°æ®
</span></span><span class=line><span class=cl>   |- 01BKGTZQ1HHWHV8FBJXW1Y3W0K
</span></span><span class=line><span class=cl>      |- meta.json
</span></span><span class=line><span class=cl>      |- wal
</span></span><span class=line><span class=cl>        |-000001
</span></span></code></pre></div><p>æœ€åˆä¸¤ä¸ªå°æ—¶çš„å—æœ€ç»ˆä¼šåœ¨åå°è¢«å‹ç¼©æˆæ›´é•¿çš„å—ã€‚</p><blockquote><p><strong>[info] æ³¨æ„</strong>ï¼š</p><p>æœ¬åœ°å­˜å‚¨ä¸å¯å¤åˆ¶ï¼Œæ— æ³•æ„å»ºé›†ç¾¤ï¼Œå¦‚æœæœ¬åœ°ç£ç›˜æˆ–èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œå­˜å‚¨å°†æ— æ³•æ‰©å±•å’Œè¿ç§»ã€‚å› æ­¤æˆ‘ä»¬åªèƒ½æŠŠæœ¬åœ°å­˜å‚¨è§†ä¸ºè¿‘æœŸæ•°æ®çš„çŸ­æš‚æ»‘åŠ¨çª—å£ã€‚å¦‚æœä½ å¯¹æ•°æ®æŒä¹…åŒ–çš„è¦æ±‚ä¸æ˜¯å¾ˆä¸¥æ ¼ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç£ç›˜å­˜å‚¨å¤šè¾¾æ•°å¹´çš„æ•°æ®ã€‚</p></blockquote><p>å…³äºå­˜å‚¨æ ¼å¼çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒ
<a href=https://github.com/prometheus/tsdb/blob/master/docs/format/README.md>TSDB æ ¼å¼</a></p><h4 id=æœ¬åœ°å­˜å‚¨é…ç½®>æœ¬åœ°å­˜å‚¨é…ç½®
<a class=anchor href=#%e6%9c%ac%e5%9c%b0%e5%ad%98%e5%82%a8%e9%85%8d%e7%bd%ae>#</a></h4><p>rometheus æä¾›äº†å‡ ä¸ªå‚æ•°æ¥ä¿®æ”¹æœ¬åœ°å­˜å‚¨çš„é…ç½®ï¼Œæœ€ä¸»è¦çš„æœ‰ï¼š</p><table><thead><tr><th>å¯åŠ¨å‚æ•°</th><th>é»˜è®¤å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>&ndash;storage.tsdb.path</td><td>/data</td><td>æ•°æ®å­˜å‚¨è·¯å¾„</td></tr><tr><td>&ndash;storage.tsdb.retention.time</td><td>15d</td><td>æ ·æœ¬æ•°æ®åœ¨å­˜å‚¨ä¸­ä¿å­˜çš„æ—¶é—´ã€‚è¶…è¿‡è¯¥æ—¶é—´é™åˆ¶çš„æ•°æ®å°±ä¼šè¢«åˆ é™¤ã€‚</td></tr><tr><td>&ndash;storage.tsdb.retention.size</td><td>0</td><td>æ¯ä¸ªå—çš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆä¸åŒ…æ‹¬ wal æ–‡ä»¶ï¼‰ã€‚å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œæœ€æ—©çš„æ ·æœ¬æ•°æ®ä¼šè¢«ä¼˜å…ˆåˆ é™¤ã€‚æ”¯æŒçš„å•ä½æœ‰ KB, MB, GB, PBï¼Œä¾‹å¦‚ï¼šâ€œ512MBâ€ã€‚è¯¥å‚æ•°åªæ˜¯è¯•éªŒæ€§çš„ï¼Œå¯èƒ½ä¼šåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­è¢«ç§»é™¤ã€‚</td></tr><tr><td>&ndash;storage.tsdb.retention</td><td></td><td>è¯¥å‚æ•°ä» 2.7 ç‰ˆæœ¬å¼€å§‹å·²ç»è¢«å¼ƒç”¨ï¼Œä½¿ç”¨ &ndash;storage.tsdb.retention.time å‚æ•°æ›¿ä»£</td></tr></tbody></table><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPrometheus ä¸­å­˜å‚¨çš„æ¯ä¸€ä¸ªæ ·æœ¬å¤§æ¦‚å ç”¨1-2å­—èŠ‚å¤§å°ã€‚å¦‚æœéœ€è¦å¯¹ Prometheus Server çš„æœ¬åœ°ç£ç›˜ç©ºé—´åšå®¹é‡è§„åˆ’æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample
</span></span></code></pre></div><p>ä»ä¸Šé¢å…¬å¼ä¸­å¯ä»¥çœ‹å‡ºåœ¨ä¿ç•™æ—¶é—´ï¼ˆretention_time_secondsï¼‰å’Œæ ·æœ¬å¤§å°ï¼ˆbytes_per_sampleï¼‰ä¸å˜çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæƒ³å‡å°‘æœ¬åœ°ç£ç›˜çš„å®¹é‡éœ€æ±‚ï¼Œåªèƒ½é€šè¿‡å‡å°‘æ¯ç§’è·å–æ ·æœ¬æ•°ï¼ˆingested_samples_per_secondï¼‰çš„æ–¹å¼ã€‚å› æ­¤æœ‰ä¸¤ç§æ‰‹æ®µï¼Œä¸€æ˜¯å‡å°‘æ—¶é—´åºåˆ—çš„æ•°é‡ï¼ŒäºŒæ˜¯å¢åŠ é‡‡é›†æ ·æœ¬çš„æ—¶é—´é—´éš”ã€‚è€ƒè™‘åˆ° Prometheus ä¼šå¯¹æ—¶é—´åºåˆ—è¿›è¡Œå‹ç¼©æ•ˆç‡ï¼Œå‡å°‘æ—¶é—´åºåˆ—çš„æ•°é‡æ•ˆæœæ›´æ˜æ˜¾ã€‚</p><p>å¦‚æœä½ çš„æœ¬åœ°å­˜å‚¨å‡ºç°æ•…éšœï¼Œæœ€å¥½çš„åŠæ³•æ˜¯åœæ­¢è¿è¡Œ Prometheus å¹¶åˆ é™¤æ•´ä¸ªå­˜å‚¨ç›®å½•ã€‚å› ä¸º Prometheus çš„æœ¬åœ°å­˜å‚¨ä¸æ”¯æŒé POSIX å…¼å®¹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€æ—¦å‘ç”ŸæŸåï¼Œå°†æ— æ³•æ¢å¤ã€‚NFS åªæœ‰éƒ¨åˆ†å…¼å®¹ POSIXï¼Œå¤§éƒ¨åˆ†å®ç°éƒ½ä¸å…¼å®¹ POSIXã€‚</p><p>é™¤äº†åˆ é™¤æ•´ä¸ªç›®å½•ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥å°è¯•åˆ é™¤ä¸ªåˆ«å—ç›®å½•æ¥è§£å†³é—®é¢˜ã€‚åˆ é™¤æ¯ä¸ªå—ç›®å½•å°†ä¼šä¸¢å¤±å¤§çº¦ä¸¤ä¸ªå°æ—¶æ—¶é—´çª—å£çš„æ ·æœ¬æ•°æ®ã€‚æ‰€ä»¥ï¼Œ<strong>Prometheus çš„æœ¬åœ°å­˜å‚¨å¹¶ä¸èƒ½å®ç°é•¿æœŸçš„æŒä¹…åŒ–å­˜å‚¨ã€‚</strong>ï¼š</p><p>å¦‚æœåŒæ—¶æŒ‡å®šäº†æ ·æœ¬æ•°æ®åœ¨å­˜å‚¨ä¸­ä¿å­˜çš„æ—¶é—´å’Œå¤§å°ï¼Œåˆ™å“ªä¸€ä¸ªå‚æ•°çš„é™åˆ¶å…ˆè§¦å‘ï¼Œå°±æ‰§è¡Œå“ªä¸ªå‚æ•°çš„ç­–ç•¥ã€‚</p><h3 id=è¿œç¨‹å­˜å‚¨>è¿œç¨‹å­˜å‚¨
<a class=anchor href=#%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8>#</a></h3><p>Prometheus çš„æœ¬åœ°å­˜å‚¨æ— æ³•æŒä¹…åŒ–æ•°æ®ï¼Œæ— æ³•çµæ´»æ‰©å±•ã€‚ä¸ºäº†ä¿æŒPrometheusçš„ç®€å•æ€§ï¼ŒPrometheuså¹¶æ²¡æœ‰å°è¯•åœ¨è‡ªèº«ä¸­è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰ä¸¤ä¸ªæ ‡å‡†æ¥å£ï¼ˆremote_write/remote_readï¼‰ï¼Œè®©ç”¨æˆ·å¯ä»¥åŸºäºè¿™ä¸¤ä¸ªæ¥å£å¯¹æ¥å°†æ•°æ®ä¿å­˜åˆ°ä»»æ„ç¬¬ä¸‰æ–¹çš„å­˜å‚¨æœåŠ¡ä¸­ï¼Œè¿™ç§æ–¹å¼åœ¨ Promthues ä¸­ç§°ä¸º Remote Storageã€‚</p><p>Prometheus å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥é›†æˆè¿œç¨‹å­˜å‚¨ã€‚</p><h4 id=remote-write>Remote Write
<a class=anchor href=#remote-write>#</a></h4><p>ç”¨æˆ·å¯ä»¥åœ¨ Prometheus é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š Remote Writeï¼ˆè¿œç¨‹å†™ï¼‰çš„ URL åœ°å€ï¼Œä¸€æ—¦è®¾ç½®äº†è¯¥é…ç½®é¡¹ï¼ŒPrometheus å°†é‡‡é›†åˆ°çš„æ ·æœ¬æ•°æ®é€šè¿‡ HTTP çš„å½¢å¼å‘é€ç»™é€‚é…å™¨ï¼ˆAdaptorï¼‰ã€‚è€Œç”¨æˆ·åˆ™å¯ä»¥åœ¨é€‚é…å™¨ä¸­å¯¹æ¥å¤–éƒ¨ä»»æ„çš„æœåŠ¡ã€‚å¤–éƒ¨æœåŠ¡å¯ä»¥æ˜¯çœŸæ­£çš„å­˜å‚¨ç³»ç»Ÿï¼Œå…¬æœ‰äº‘çš„å­˜å‚¨æœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ç­‰ä»»æ„å½¢å¼ã€‚</p><p><img src=https://fs.poneding.com/images/IA5eOL.jpg alt=img></p><h4 id=remote-read>Remote Read
<a class=anchor href=#remote-read>#</a></h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒPromthues çš„ Remote Readï¼ˆè¿œç¨‹è¯»ï¼‰ä¹Ÿé€šè¿‡äº†ä¸€ä¸ªé€‚é…å™¨å®ç°ã€‚åœ¨è¿œç¨‹è¯»çš„æµç¨‹å½“ä¸­ï¼Œå½“ç”¨æˆ·å‘èµ·æŸ¥è¯¢è¯·æ±‚åï¼ŒPromthues å°†å‘ remote_read ä¸­é…ç½®çš„ URL å‘èµ·æŸ¥è¯¢è¯·æ±‚ï¼ˆmatchers,rangesï¼‰ï¼Œ<code>Adaptor</code> æ ¹æ®è¯·æ±‚æ¡ä»¶ä»ç¬¬ä¸‰æ–¹å­˜å‚¨æœåŠ¡ä¸­è·å–å“åº”çš„æ•°æ®ã€‚åŒæ—¶å°†æ•°æ®è½¬æ¢ä¸º Promthues çš„åŸå§‹æ ·æœ¬æ•°æ®è¿”å›ç»™ Prometheus Serverã€‚</p><p>å½“è·å–åˆ°æ ·æœ¬æ•°æ®åï¼ŒPromthues åœ¨æœ¬åœ°ä½¿ç”¨ PromQL å¯¹æ ·æœ¬æ•°æ®è¿›è¡ŒäºŒæ¬¡å¤„ç†ã€‚</p><blockquote><p><strong>[info] æ³¨æ„</strong>ï¼š</p><p>å¯ç”¨è¿œç¨‹è¯»è®¾ç½®åï¼ŒPrometheus ä»…ä»è¿œç¨‹å­˜å‚¨è¯»å–ä¸€ç»„æ—¶åºæ ·æœ¬æ•°æ®ï¼ˆæ ¹æ®æ ‡ç­¾é€‰æ‹©å™¨å’Œæ—¶é—´èŒƒå›´ï¼‰ï¼Œå¯¹äºè§„åˆ™æ–‡ä»¶çš„å¤„ç†ï¼Œä»¥åŠ Metadata API çš„å¤„ç†éƒ½åªåŸºäº Prometheus æœ¬åœ°å­˜å‚¨å®Œæˆã€‚è¿™ä¹Ÿå°±æ„å‘³ç€è¿œç¨‹è¯»åœ¨æ‰©å±•æ€§ä¸Šæœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå› ä¸ºæ‰€æœ‰çš„æ ·æœ¬æ•°æ®éƒ½è¦é¦–å…ˆåŠ è½½åˆ° Prometheus Serverï¼Œç„¶åå†è¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥ Prometheus æš‚æ—¶ä¸æ”¯æŒå®Œå…¨åˆ†å¸ƒå¼å¤„ç†ã€‚</p></blockquote><p><img src=https://fs.poneding.com/images/0irUuL.jpg alt=image></p><p>è¿œç¨‹è¯»å’Œè¿œç¨‹å†™åè®®éƒ½ä½¿ç”¨äº†åŸºäº HTTP çš„ snappy å‹ç¼©åè®®çš„ç¼“å†²åŒºç¼–ç ï¼Œç›®å‰è¿˜ä¸ç¨³å®šï¼Œåœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šè¢«æ›¿æ¢æˆåŸºäº HTTP/2 çš„ <code>gRPC</code> åè®®ï¼Œå‰ææ˜¯ Prometheus å’Œè¿œç¨‹å­˜å‚¨ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½æ”¯æŒ HTTP/2ã€‚</p><h4 id=é…ç½®æ–‡ä»¶>é…ç½®æ–‡ä»¶
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6>#</a></h4><p>æƒ³çŸ¥é“å¦‚ä½•åœ¨ Prometheus ä¸­æ·»åŠ è¿œç¨‹å­˜å‚¨çš„é…ç½®ï¼Œè¯·å‚è€ƒå‰é¢çš„ç« èŠ‚ï¼š
<a href=https://www.yangcs.net/prometheus/3-prometheus/configuration.html#remote_write>é…ç½®è¿œç¨‹å†™</a> å’Œ
<a href=https://www.yangcs.net/prometheus/3-prometheus/configuration.html#remote_read>é…ç½®è¿œç¨‹è¯»</a>ã€‚</p><p>å…³äºè¯·æ±‚ä¸å“åº”æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹è¿œç¨‹å­˜å‚¨ç›¸å…³åè®®çš„ proto æ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>prometheus</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;prompb&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;types.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;gogoproto/gogo.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>WriteRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>prometheus.TimeSeries</span> <span class=n>timeseries</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[(</span><span class=n>gogoproto.nullable</span><span class=p>)</span> <span class=o>=</span> <span class=kc>false</span><span class=p>];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>ReadRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>Query</span> <span class=n>queries</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>ReadResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// In same order as the request&#39;s queries.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=n>QueryResult</span> <span class=n>results</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Query</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>start_timestamp_ms</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>end_timestamp_ms</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>prometheus.LabelMatcher</span> <span class=n>matchers</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>prometheus.ReadHints</span> <span class=n>hints</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>QueryResult</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// Samples within a time series must be ordered by time.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=n>prometheus.TimeSeries</span> <span class=n>timeseries</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><h4 id=æ”¯æŒçš„è¿œç¨‹å­˜å‚¨>æ”¯æŒçš„è¿œç¨‹å­˜å‚¨
<a class=anchor href=#%e6%94%af%e6%8c%81%e7%9a%84%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8>#</a></h4><p>ç›®å‰ Prometheus ç¤¾åŒºä¹Ÿæä¾›äº†éƒ¨åˆ†å¯¹äºç¬¬ä¸‰æ–¹æ•°æ®åº“çš„ Remote Storage æ”¯æŒï¼š</p><table><thead><tr><th>å­˜å‚¨æœåŠ¡</th><th>æ”¯æŒæ¨¡å¼</th></tr></thead><tbody><tr><td><a href=https://github.com/solarwinds/prometheus2appoptics>AppOptics</a></td><td>write</td></tr><tr><td><a href=https://github.com/ChronixDB/chronix.ingester>Chronix</a></td><td>write</td></tr><tr><td><a href=https://github.com/cortexproject/cortex>Cortex</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/crate/crate_adapter>CrateDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/infonova/prometheusbeat>Elasticsearch</a></td><td>write</td></tr><tr><td><a href=https://gnocchi.xyz/prometheus.html>Gnocchi</a></td><td>write</td></tr><tr><td><a href=https://github.com/prometheus/prometheus/tree/master/documentation/examples/remote_storage/remote_storage_adapter>Graphite</a></td><td>write</td></tr><tr><td><a href=https://docs.influxdata.com/influxdb/latest/supported_protocols/prometheus>InfluxDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/circonus-labs/irondb-prometheus-adapter>IRONdb</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/Telefonica/prometheus-kafka-adapter>Kafka</a></td><td>write</td></tr><tr><td><a href=https://m3db.github.io/m3/integrations/prometheus>M3DB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/prometheus/prometheus/tree/master/documentation/examples/remote_storage/remote_storage_adapter>OpenTSDB</a></td><td>write</td></tr><tr><td><a href=https://github.com/timescale/prometheus-postgresql-adapter>PostgreSQL/TimescaleDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/signalfx/metricproxy#prometheus>SignalFx</a></td><td>write</td></tr><tr><td><a href=https://github.com/lukemonahan/splunk_modinput_prometheus#prometheus-remote-write>Splunk</a></td><td>write</td></tr><tr><td><a href=https://github.com/bragfoo/TiPrometheus>TiKV</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/VictoriaMetrics/VictoriaMetrics>VictoriaMetrics</a></td><td>write</td></tr><tr><td><a href=https://github.com/wavefrontHQ/prometheus-storage-adapter>Wavefront</a></td><td>write</td></tr></tbody></table><h2 id=è”é‚¦é›†ç¾¤>è”é‚¦é›†ç¾¤
<a class=anchor href=#%e8%81%94%e9%82%a6%e9%9b%86%e7%be%a4>#</a></h2><p>è”é‚¦ä½¿å¾—ä¸€ä¸ª Prometheus æœåŠ¡å™¨å¯ä»¥ä»å¦ä¸€ä¸ª Prometheus æœåŠ¡å™¨æå–é€‰å®šçš„æ—¶åºã€‚</p><h3 id=ä½¿ç”¨åœºæ™¯>ä½¿ç”¨åœºæ™¯
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h3><p>Prometheus è”é‚¦æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚é€šå¸¸ï¼Œè”é‚¦è¢«ç”¨æ¥å®ç°å¯æ‰©å±•çš„ Prometheus ç›‘æ§è®¾ç½®ï¼Œæˆ–è€…å°†ç›¸å…³çš„æŒ‡æ ‡ä»ä¸€ä¸ªæœåŠ¡çš„ Prometheus æ‹‰å–åˆ°å¦ä¸€ä¸ª Prometheus ä¸­ã€‚</p><h3 id=åˆ†å±‚è”é‚¦>åˆ†å±‚è”é‚¦
<a class=anchor href=#%e5%88%86%e5%b1%82%e8%81%94%e9%82%a6>#</a></h3><p>åˆ†å±‚è”é‚¦å…è®¸ Prometheus èƒ½å¤Ÿæ‰©å±•åˆ°åå‡ ä¸ªæ•°æ®ä¸­å¿ƒå’Œä¸Šç™¾ä¸‡çš„èŠ‚ç‚¹ã€‚åœ¨æ­¤åœºæ™¯ä¸‹ï¼Œè”é‚¦æ‹“æ‰‘ç±»ä¼¼ä¸€ä¸ªæ ‘å½¢æ‹“æ‰‘ç»“æ„ï¼Œä¸Šå±‚çš„ Prometheus æœåŠ¡å™¨ä»å¤§é‡çš„ä¸‹å±‚ Prometheus æœåŠ¡å™¨ä¸­æ”¶é›†å’Œæ±‡èšçš„æ—¶åºæ•°æ®ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªè”é‚¦è®¾ç½®å¯èƒ½ç”±å¤šä¸ªæ•°æ®ä¸­å¿ƒä¸­çš„ Prometheus æœåŠ¡å™¨å’Œä¸€å¥—å…¨å±€ Prometheus æœåŠ¡å™¨ç»„æˆã€‚æ¯ä¸ªæ•°æ®ä¸­å¿ƒä¸­éƒ¨ç½²çš„ Prometheus æœåŠ¡å™¨è´Ÿè´£æ”¶é›†æœ¬åŒºåŸŸå†…ç»†ç²’åº¦çš„æ•°æ®ï¼ˆå®ä¾‹çº§åˆ«ï¼‰ï¼Œå…¨å±€ Prometheus æœåŠ¡å™¨ä»è¿™äº›ä¸‹å±‚ Prometheus æœåŠ¡å™¨ä¸­æ”¶é›†å’Œæ±‡èšæ•°æ®ï¼ˆä»»åŠ¡çº§åˆ«ï¼‰ï¼Œå¹¶å­˜å‚¨èšåˆåçš„æ•°æ®ã€‚è¿™æ ·å°±æä¾›äº†ä¸€ä¸ªèšåˆçš„å…¨å±€è§†è§’å’Œè¯¦ç»†çš„æœ¬åœ°è§†è§’ã€‚</p><h3 id=è·¨æœåŠ¡è”é‚¦>è·¨æœåŠ¡è”é‚¦
<a class=anchor href=#%e8%b7%a8%e6%9c%8d%e5%8a%a1%e8%81%94%e9%82%a6>#</a></h3><p>åœ¨è·¨æœåŠ¡è”é‚¦ä¸­ï¼Œä¸€ä¸ªæœåŠ¡çš„ Prometheus æœåŠ¡å™¨è¢«é…ç½®æ¥æå–æ¥è‡ªå…¶ä»–æœåŠ¡çš„ Prometheus æœåŠ¡å™¨çš„æŒ‡å®šçš„æ•°æ®ï¼Œä»¥ä¾¿åœ¨ä¸€ä¸ª Prometheus æœåŠ¡å™¨ä¸­å¯¹ä¸¤ä¸ªæ•°æ®é›†å¯ç”¨å‘Šè­¦å’ŒæŸ¥è¯¢ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªè¿è¡Œå¤šç§æœåŠ¡çš„é›†ç¾¤è°ƒåº¦å™¨å¯ä»¥æš´éœ²åœ¨é›†ç¾¤ä¸Šè¿è¡Œçš„æœåŠ¡å®ä¾‹çš„èµ„æºä½¿ç”¨ä¿¡æ¯ï¼ˆä¾‹å¦‚å†…å­˜å’Œ CPU ä½¿ç”¨ç‡ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿è¡Œåœ¨é›†ç¾¤ä¸Šçš„æœåŠ¡åªéœ€è¦æš´éœ²æŒ‡å®šåº”ç”¨ç¨‹åºçº§åˆ«çš„æœåŠ¡æŒ‡æ ‡ã€‚é€šå¸¸ï¼Œè¿™ä¸¤ç§æŒ‡æ ‡é›†åˆ†åˆ«è¢«ä¸åŒçš„ Prometheus æœåŠ¡å™¨æŠ“å–ã€‚åˆ©ç”¨è”é‚¦ï¼Œç›‘æ§æœåŠ¡çº§åˆ«æŒ‡æ ‡çš„ Prometheus æœåŠ¡å™¨ä¹Ÿå¯ä»¥ä»é›†ç¾¤ä¸­ Prometheus æœåŠ¡å™¨æ‹‰å–å…¶ç‰¹å®šæœåŠ¡çš„é›†ç¾¤èµ„æºä½¿ç”¨ç‡æŒ‡æ ‡ï¼Œä»¥ä¾¿å¯ä»¥åœ¨è¯¥ Prometheus æœåŠ¡å™¨ä¸­ä½¿ç”¨è¿™ä¸¤ç»„æŒ‡æ ‡é›†ã€‚</p><h3 id=é…ç½®è”é‚¦>é…ç½®è”é‚¦
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e8%81%94%e9%82%a6>#</a></h3><p>åœ¨ Prometheus æœåŠ¡å™¨ä¸­ï¼Œ<code>/federate</code> èŠ‚ç‚¹å…è®¸è·å–æœåŠ¡ä¸­è¢«é€‰ä¸­çš„æ—¶é—´åºåˆ—é›†åˆçš„å€¼ã€‚è‡³å°‘ä¸€ä¸ª <code>match[]</code> URL å‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºè¦æš´éœ²çš„åºåˆ—ã€‚æ¯ä¸ª <code>match[]</code> å˜é‡éœ€è¦è¢«æŒ‡å®šä¸ºä¸€ä¸ª
<a href=https://prometheus.io/docs/prometheus/latest/querying/basics/#instant-vector-selectors>ä¸å˜çš„ç»´åº¦é€‰æ‹©å™¨</a>åƒ <code>up</code> æˆ–è€… <code>{job="api-server"}</code>ã€‚å¦‚æœæœ‰å¤šä¸ª <code>match[]</code> å‚æ•°ï¼Œåˆ™æ‰€æœ‰ç¬¦åˆçš„æ—¶åºæ•°æ®çš„é›†åˆéƒ½ä¼šè¢«é€‰æ‹©ã€‚</p><p>ä»ä¸€ä¸ª Prometheus æœåŠ¡å™¨è”é‚¦æŒ‡æ ‡åˆ°å¦ä¸€ä¸ª Prometheus æœåŠ¡å™¨ï¼Œé…ç½®ä½ çš„ç›®æ ‡ Prometheus æœåŠ¡å™¨ä»æºæœåŠ¡å™¨çš„ <code>/federate</code> èŠ‚ç‚¹æŠ“å–æŒ‡æ ‡æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿä½¿ç”¨ <code>honor_lables</code> æŠ“å–é€‰é¡¹ï¼ˆä¸é‡å†™æº Prometheus æœåŠ¡æš´éœ²çš„æ ‡ç­¾ï¼‰å¹¶ä¸”ä¼ é€’éœ€è¦çš„ <code>match[]</code> å‚æ•°ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ <code>scrape_configs</code> è”é‚¦ <code>source-prometheus-{1,2,3}:9090</code> ä¸‰å° Prometheus æœåŠ¡å™¨ï¼Œä¸Šå±‚ Prometheus æŠ“å–å¹¶æ±‡æ€»ä»–ä»¬æš´éœ²çš„ä»»ä½•å¸¦ <code>job="prometheus"</code> æ ‡ç­¾çš„åºåˆ—æˆ–åç§°ä»¥ <code>job:</code> å¼€å¤´çš„æŒ‡æ ‡ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;federate&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/federate&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&#39;match[]&#39;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;{job=&#34;prometheus&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;{__name__=~&#34;job:.*&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;source-prometheus-1:9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;source-prometheus-2:9090&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;source-prometheus-3:9090&#39;</span><span class=w>
</span></span></span></code></pre></div><h2 id=monitor-app>Monitor App
<a class=anchor href=#monitor-app>#</a></h2><h3 id=mssql>MSSQL
<a class=anchor href=#mssql>#</a></h3><p><a href=https://prometheus.io/docs/instrumenting/exporters/>å‚è€ƒ</a></p><ul><li><p>ç›‘æ§Mssqlåº”ç”¨</p><p>åœ¨ä¸€å°å®‰è£…äº†Dockerçš„æœåŠ¡å™¨ä¸Šè¿è¡Œmssql-exporter</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MSSQL_PASS</span><span class=o>=</span><span class=s1>&#39;xxx&#39;</span>
</span></span><span class=line><span class=cl>sudo docker run -e <span class=nv>SERVER</span><span class=o>=</span>db-dev-ms01.example.com -e <span class=nv>USERNAME</span><span class=o>=</span>starlightdba -e <span class=nv>PASSWORD</span><span class=o>=</span><span class=nv>$DEV_MSSQL_PASS</span> -e <span class=nv>DEBUG</span><span class=o>=</span>app --rm -d -p 4000:4000 --name dev-mssql awaragi/prometheus-mssql-exporter
</span></span></code></pre></div><blockquote><p>æ³¨æ„ï¼šMssqlè´¦å·éœ€è¦æœ‰ç®¡ç†å‘˜æƒé™ã€‚</p></blockquote><p>prometheus.yamlæ–°å¢ç›‘æ§ çš„é…ç½®</p><ul><li>ç›‘æ§MssqlæœåŠ¡å™¨</li></ul><h2 id=solved>solved
<a class=anchor href=#solved>#</a></h2><hr><p><a href=/kubernetes/prometheus-collect-kong-metrics/>Â« Prometheus-ç›‘æ§Kongå®Œæ•´æ“ä½œ</a></p><p><a href=/kubernetes/pvc-expansion/>Â» PVC æ‰©å®¹</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/5faa4f1be5d4525c49e513962394eae7c15fb6f2 title='æœ€åä¿®æ”¹è€… poneding | 2024/06/13' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/13</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/kubernetes/prometheus.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>ç¼–è¾‘æœ¬é¡µ</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#prometheusçš„ç›‘æ§å¯¹è±¡>Prometheusçš„ç›‘æ§å¯¹è±¡</a></li><li><a href=#prometheusä¼˜åŠ¿>Prometheusä¼˜åŠ¿</a></li><li><a href=#prometheusç»„ä»¶>Prometheusç»„ä»¶</a></li></ul></li><li><a href=#architecture-overview>Architecture overview</a></li><li><a href=#installation--start-up>Installation & Start Up</a><ul><li><a href=#1-ä»¥æœåŠ¡è¿›ç¨‹è¿è¡Œprometheus>1. ä»¥æœåŠ¡è¿›ç¨‹è¿è¡ŒPrometheus</a></li><li><a href=#2dockerå¯åŠ¨prometheus>2.Dockerå¯åŠ¨Prometheus</a></li><li><a href=#3-kubernetesè¿è¡Œprometheus>3. Kubernetesè¿è¡ŒPrometheus</a></li><li><a href=#4å®˜æ–¹kubernetsè¿è¡Œprometheus>4.å®˜æ–¹kubernetsè¿è¡ŒPrometheus</a></li><li><a href=#5kuberneteséƒ¨ç½²prometheusgrafana>5.Kuberneteséƒ¨ç½²Prometheus+Grafana</a></li></ul></li><li><a href=#configuring-prometheus>Configuring Prometheus</a></li><li><a href=#concepts>Concepts</a><ul><li><a href=#metrics>Metrics</a></li></ul></li><li><a href=#å­˜å‚¨>å­˜å‚¨</a><ul><li><a href=#æœ¬åœ°å­˜å‚¨>æœ¬åœ°å­˜å‚¨</a></li><li><a href=#è¿œç¨‹å­˜å‚¨>è¿œç¨‹å­˜å‚¨</a></li></ul></li><li><a href=#è”é‚¦é›†ç¾¤>è”é‚¦é›†ç¾¤</a><ul><li><a href=#ä½¿ç”¨åœºæ™¯>ä½¿ç”¨åœºæ™¯</a></li><li><a href=#åˆ†å±‚è”é‚¦>åˆ†å±‚è”é‚¦</a></li><li><a href=#è·¨æœåŠ¡è”é‚¦>è·¨æœåŠ¡è”é‚¦</a></li><li><a href=#é…ç½®è”é‚¦>é…ç½®è”é‚¦</a></li></ul></li><li><a href=#monitor-app>Monitor App</a><ul><li><a href=#mssql>MSSQL</a></li></ul></li><li><a href=#solved>solved</a></li></ul></nav></div></aside></main></body></html>