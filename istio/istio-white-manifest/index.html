<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='ğŸ  é¦–é¡µ / Istio / åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå•
åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå• # éœ€æ±‚ # ä¸¤ä¸ªåº”ç”¨ï¼Œfoo å’Œ barï¼Œåº”ç”¨ foo åªå…è®¸ IP åœ°å€ä¸º 1.2.3.4 è®¿é—®ï¼Œåº”ç”¨ bar åªå…è®¸ IP åœ°å€ä¸º 5.6.7.8 è®¿é—®ã€‚
å®ç° # åŸºäº istio çš„ AuthorizationPolicy å®ç°ã€‚
å‡è®¾ï¼Œç°åœ¨ K8s é›†ç¾¤ä¸­å·²ç»å®‰è£… istioï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œç€çš„ istio-ingressgateway è½¬å‘åº”ç”¨ foo å’Œ barï¼š
é€šè¿‡ï¼š https://www.example.com/foo è®¿é—® foo;
é€šè¿‡ï¼š https://www.example.com/bar è®¿é—® bar;
æ’æ›² # æŒ‰ç…§ istio å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ AuthorizationPolicy å³å¯å®ç°åŸºäºåº”ç”¨å±‚çº§çš„è®¿é—®ç™½åå•è®¾ç½®ï¼š
apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: foo spec: selector: matchLabels: app: foo action: ALLOW rules: - from: - source: ipBlocks: ["1.'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/istio/istio-white-manifest/"><meta property="og:site_name" content="ç§‹æ²³è½å¶"><meta property="og:title" content="ç§‹æ²³è½å¶"><meta property="og:description" content='ğŸ  é¦–é¡µ / Istio / åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå•
åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå• # éœ€æ±‚ # ä¸¤ä¸ªåº”ç”¨ï¼Œfoo å’Œ barï¼Œåº”ç”¨ foo åªå…è®¸ IP åœ°å€ä¸º 1.2.3.4 è®¿é—®ï¼Œåº”ç”¨ bar åªå…è®¸ IP åœ°å€ä¸º 5.6.7.8 è®¿é—®ã€‚
å®ç° # åŸºäº istio çš„ AuthorizationPolicy å®ç°ã€‚
å‡è®¾ï¼Œç°åœ¨ K8s é›†ç¾¤ä¸­å·²ç»å®‰è£… istioï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œç€çš„ istio-ingressgateway è½¬å‘åº”ç”¨ foo å’Œ barï¼š
é€šè¿‡ï¼š https://www.example.com/foo è®¿é—® foo;
é€šè¿‡ï¼š https://www.example.com/bar è®¿é—® bar;
æ’æ›² # æŒ‰ç…§ istio å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ AuthorizationPolicy å³å¯å®ç°åŸºäºåº”ç”¨å±‚çº§çš„è®¿é—®ç™½åå•è®¾ç½®ï¼š
apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: foo spec: selector: matchLabels: app: foo action: ALLOW rules: - from: - source: ipBlocks: ["1.'><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="istio"><meta property="article:modified_time" content="2024-06-13T15:37:18+08:00"><title>Istio White Manifest | ç§‹æ²³è½å¶</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/istio/istio-white-manifest/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.9567048e84c000297031014ca4f90d353916f49994437d395abd10b41e9e0e7b.js integrity="sha256-lWcEjoTAAClwMQFMpPkNNTkW9JmUQ305Wr0QtB6eDns=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script><link rel=stylesheet href=/css/syntax.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>ç§‹æ²³è½å¶</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=æœç´¢ aria-label=æœç´¢ maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><p>ğŸ¦‰ é›†ä¸­èµ·æ¥çš„æ„å¿—å¯ä»¥å‡»ç©¿é¡½çŸ³ã€‚</p><hr><ul><li><p><a href=/><strong>ğŸ  é¦–é¡µ</strong></a></p></li><li><p><strong>ğŸ“Œ ç½®é¡¶æ–‡ç« </strong></p><ul><li><a href=/git/common-usage/>Git å¸¸ç”¨</a></li><li><a href=/kubernetes/kubeadm-install-k8s-docker/>å®‰è£… Kubernetes (Docker)</a></li></ul></li><li><p><strong>ğŸ“Œ ç½®é¡¶åˆ†ç±»</strong></p><ul><li><a href=/go/>Golang ç¼–ç¨‹</a></li><li><a href=/kubernetes/>Kubernetes</a></li><li><a href=/rust/>Rust ç¼–ç¨‹</a></li><li><a href=/git/>Git</a></li></ul></li></ul><hr><ul><li><strong>ğŸ—ƒï¸ å¼€æºé¡¹ç›®</strong><ul><li><a href=https://github.com/ketches/registry-proxy>registry-proxy</a></li><li><a href=https://github.com/poneding/mdi>mdi</a></li></ul></li></ul><hr><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>ğŸ™ GitHub</a></li><li><a href=mailto:poneding@gmail.com target=_blank rel=noopener>ğŸ“¬ é‚®ç®±</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Istio White Manifest</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#éœ€æ±‚>éœ€æ±‚</a></li><li><a href=#å®ç°>å®ç°</a><ul><li><a href=#æ’æ›²>æ’æ›²</a></li><li><a href=#æœ€ç»ˆæ–¹æ¡ˆ>æœ€ç»ˆæ–¹æ¡ˆ</a></li></ul></li><li><a href=#é™„å½•>é™„å½•</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>ğŸ  é¦–é¡µ</a> /
<a href=/istio/>Istio</a> / åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå•</p><h1 id=åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå•>åº”ç”¨å±‚çº§è®¾ç½®è®¿é—®ç™½åå•
<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%b1%82%e7%ba%a7%e8%ae%be%e7%bd%ae%e8%ae%bf%e9%97%ae%e7%99%bd%e5%90%8d%e5%8d%95>#</a></h1><h2 id=éœ€æ±‚>éœ€æ±‚
<a class=anchor href=#%e9%9c%80%e6%b1%82>#</a></h2><p>ä¸¤ä¸ªåº”ç”¨ï¼Œ<code>foo</code> å’Œ <code>bar</code>ï¼Œåº”ç”¨ <code>foo</code> åªå…è®¸ <code>IP</code> åœ°å€ä¸º <code>1.2.3.4</code> è®¿é—®ï¼Œåº”ç”¨ <code>bar</code> åªå…è®¸ <code>IP</code> åœ°å€ä¸º <code>5.6.7.8</code> è®¿é—®ã€‚</p><h2 id=å®ç°>å®ç°
<a class=anchor href=#%e5%ae%9e%e7%8e%b0>#</a></h2><p>åŸºäº <code>istio</code> çš„ <code>AuthorizationPolicy</code> å®ç°ã€‚</p><p>å‡è®¾ï¼Œç°åœ¨ <code>K8s</code> é›†ç¾¤ä¸­å·²ç»å®‰è£… <code>istio</code>ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œç€çš„ <code>istio-ingressgateway</code> è½¬å‘åº”ç”¨ <code>foo</code> å’Œ <code>bar</code>ï¼š</p><blockquote><p>é€šè¿‡ï¼š
<a href=https://www.example.com/foo>https://www.example.com/foo</a> è®¿é—® <code>foo</code>;</p><p>é€šè¿‡ï¼š
<a href=https://www.example.com/bar>https://www.example.com/bar</a> è®¿é—® <code>bar</code>;</p></blockquote><h3 id=æ’æ›²>æ’æ›²
<a class=anchor href=#%e6%8f%92%e6%9b%b2>#</a></h3><p>æŒ‰ç…§ <code>istio</code> å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ <code>AuthorizationPolicy</code> å³å¯å®ç°åŸºäºåº”ç”¨å±‚çº§çš„è®¿é—®ç™½åå•è®¾ç½®ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>ALLOW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ipBlocks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;1.2.3.4&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>æƒ³è®©ä»¥ä¸ŠAuthorizationPolicyç”Ÿæ•ˆï¼Œéœ€è¦åœ¨ <code>foo</code> å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„å‘½åç©ºé—´æ³¨å…¥ <code>istio-proxy</code>ï¼Œé€šè¿‡ç»™å‘½åç©ºé—´æ·»åŠ  labelï¼Œæ·»åŠ  lable åï¼Œå·¥ä½œè´Ÿè½½å¯åŠ¨æ–°çš„ Pod ä¼šè‡ªåŠ¨æ³¨å…¥ <code>istio-proxy</code> å®¹å™¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl label namespace default istio-injection<span class=o>=</span>enabled
</span></span></code></pre></div></blockquote><p>ä½†æ˜¯ï¼Œä½ ä¼šå‘ç°ä½ ä½¿ç”¨ <code>https://www.example.com/foo</code> ä¸€ç›´è¿”å›çš„ä¿¡æ¯éƒ½æ˜¯ <code>RBAC: access denied</code>ã€‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p><p>å¦‚æœä½ åœ¨ <code>ipBlocks</code> ä¸­åŠ å…¥ <code>istio-ingressgateway</code>ï¼ˆæ˜¯ä¸€ä¸ª Deploymentï¼‰Pod çš„ IPï¼Œä½ ä¼šå‘ç°è¿™æ—¶å€™æ˜¯å¯ä»¥æˆåŠŸè®¿é—®çš„ã€‚</p><p>åˆ†ææµé‡çš„è½¬å‘è·¯å¾„åº”è¯¥å°±èƒ½çŸ¥é“ï¼Œå®é™…ä¸Šåˆ°è¾¾ç›®æ ‡åº”ç”¨ <code>foo</code> çš„è¯·æ±‚ï¼Œéƒ½ç”±<code>istio-ingressgateway</code>è½¬å‘äº†ï¼Œæ‰€ä»¥æº IP éƒ½ä¼šæ˜¯ <code>istio-ingressgateway</code> Pod çš„ IPï¼Œä»è€Œå¯¼è‡´å¤–éƒ¨è®¿é—® IP çš„ç™½åå•è®¾ç½®æ— æ³•ç”Ÿæ•ˆã€‚</p><p>é‚£ä¹ˆå¦‚æœè·å–å¤–éƒ¨IPå‘¢ã€‚</p><h3 id=æœ€ç»ˆæ–¹æ¡ˆ>æœ€ç»ˆæ–¹æ¡ˆ
<a class=anchor href=#%e6%9c%80%e7%bb%88%e6%96%b9%e6%a1%88>#</a></h3><p><strong>Step 0: è·å–å®¢æˆ·ç«¯æºIP</strong>ï¼š</p><blockquote><p>å¦‚æœä½¿ç”¨ AWS-EKS åˆ›å»º <code>istio-ingressgateway</code> æœåŠ¡æ—¶é»˜è®¤åˆ›å»ºçš„ <code>classic</code> ç±»å‹çš„ LoadBalancerï¼Œéœ€è¦ä¿®æ”¹æˆ <code>network</code>ç±»å‹ï¼š</p><p>é€šè¿‡å‘ istio-ingressgateway Service æ·»åŠ  annotationï¼š<code>service.beta.kubernetes.io/aws-load-balancer-type: nlb</code></p></blockquote><p>æ›´æ–° <code>istio-gateway</code> Serviceï¼š<code>spec.externalTrafficPolicy: Local</code>ï¼Œç°åœ¨è®¿é—®å·¥ä½œè´Ÿè½½å¯ä»¥è·å–åˆ°æº IPï¼Œè¿™å°±ä¸ºæˆ‘ä»¬è®¾ç½® IP ç™½åå•é€ å°±äº†æ¡ä»¶ã€‚</p><p>ç°åœ¨åªéœ€è¦ä¸ºè¿™ä¸ª <code>istio-ingressgateway</code> åº”ç”¨ä¸Š <code>AuthorizationPolicy</code> å³å¯ï¼š</p><p><strong>Step 1: é»˜è®¤å…è®¸æ‰€æœ‰ <code>IP</code> è®¿é—® <code>istio-ingressgateway</code></strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>allow-all-for-istio-ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>ALLOW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ipBlocks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>é»˜è®¤æ˜¯å…è®¸æ‰€æœ‰ <code>IP</code> éƒ½å¯ä»¥è®¿é—® <code>istio-ingressgateway</code> ä¸‹è½¬å‘çš„æœåŠ¡çš„ï¼Œå¦‚æœæœ‰æœåŠ¡ä¾‹å¦‚ <code>foo</code> å’Œ <code>bar</code> éœ€è¦å•ç‹¬æ·»åŠ  <code>IP</code> è®¿é—®ç™¾åå•åˆ™ç»§ç»­å‚è€ƒä¸‹é¢çš„æ­¥éª¤ã€‚</p></blockquote><p><strong>Step 2: åªå…è®¸ IP <code>1.2.3.4</code> è®¿é—® <code>foo</code></strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>DENY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>notIpBlocks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;1.2.3.4&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>www.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/foo/*</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>ç”±äºé»˜è®¤æ˜¯å…è®¸æ‰€æœ‰ <code>IP</code> éƒ½å¯ä»¥è®¿é—® <code>istio-ingressgateway</code> ä¸‹è½¬å‘çš„æœåŠ¡ï¼Œæ‰€ä»¥ä¸ºå•ç‹¬åº”ç”¨è®¾ç½®è®¿é—®ç™¾åçš„æ—¶å€™ä½¿ç”¨ <code>DENY</code> + <code>notIpBlocks</code> æ¥å®Œæˆã€‚</p><p><code>ipBlocks</code> å’Œ <code>notIpBlocks</code> å…è®¸é…ç½®IPå’ŒIPçš„CIDRï¼Œä¾‹å¦‚ï¼š<code>1.2.3.4</code> æˆ– <code>1.2.3.4/24</code>ã€‚</p></blockquote><p><strong>Step 3: åªå…è®¸ IP <code>5.6.7.8</code> è®¿é—® <code>bar</code></strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>DENY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>notIpBlocks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;5.6.7.8&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>www.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/bar/*</span><span class=w>
</span></span></span></code></pre></div><h2 id=é™„å½•>é™„å½•
<a class=anchor href=#%e9%99%84%e5%bd%95>#</a></h2><p>å¦‚æœç›¸åŒçš„ LoadBalancer ä¸‹çš„æœåŠ¡éƒ½æ˜¯ç”¨åŒä¸€ç™½åå•è®¾ç½®çš„è¯ï¼Œåˆ™æ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„è®¾ç½® <code>AuthorizationPolicy</code> äº†ï¼Œåªéœ€è¦ä¸º Service è®¾ç½®å‚æ•°å³å¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadBalancerSourceRanges</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;1.2.3.4/24&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><hr><p><a href=/istio/istio-timeout/>Â« ä½¿ç”¨ Istio å®ç°æœåŠ¡è¶…æ—¶</a></p><p><a href=/istio/tls-transform/>Â» å®ç° Https åè®®çš„è½¬å‘</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/5faa4f1be5d4525c49e513962394eae7c15fb6f2 title='æœ€åä¿®æ”¹è€… poneding | 2024/06/13' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/13</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/istio/istio-white-manifest.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>ç¼–è¾‘æœ¬é¡µ</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#éœ€æ±‚>éœ€æ±‚</a></li><li><a href=#å®ç°>å®ç°</a><ul><li><a href=#æ’æ›²>æ’æ›²</a></li><li><a href=#æœ€ç»ˆæ–¹æ¡ˆ>æœ€ç»ˆæ–¹æ¡ˆ</a></li></ul></li><li><a href=#é™„å½•>é™„å½•</a></li></ul></nav></div></aside></main></body></html>