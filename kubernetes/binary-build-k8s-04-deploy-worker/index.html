<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我的博客 / Kubernetes / 二进制搭建 K8s - 4 部署 Node
二进制搭建 K8s - 4 部署 Node # 写在前面 # 记录和分享使用二进制搭建 K8s 集群的详细过程，由于操作比较冗长，大概会分四篇写完：
机器准备： 部署 etcd 集群： 部署 Master： 部署 Node： K8s 的 Node 上需要运行 kubelet 和 kube-proxy。本篇介绍在 Node 机器安装这两个组件，除此之外，安装通信需要的 cni 插件。
本篇的执行命令需要在准备的两台Node机器上执行。
安装 docker # 可以参照官网： https://docs.docker.com/engine/install/
# 卸载老版本或重装 docker 时执行第一行 yum remove docker \ docker-client \ docker-client-latest \ docker-common \ docker-latest \ docker-latest-logrotate \ docker-logrotate \ docker-engine -y # 安装 docker yum install -y yum-utils yum-config-manager \ --add-repo \ https://download."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/kubernetes/binary-build-k8s-04-deploy-worker/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content="我的博客 / Kubernetes / 二进制搭建 K8s - 4 部署 Node
二进制搭建 K8s - 4 部署 Node # 写在前面 # 记录和分享使用二进制搭建 K8s 集群的详细过程，由于操作比较冗长，大概会分四篇写完：
机器准备： 部署 etcd 集群： 部署 Master： 部署 Node： K8s 的 Node 上需要运行 kubelet 和 kube-proxy。本篇介绍在 Node 机器安装这两个组件，除此之外，安装通信需要的 cni 插件。
本篇的执行命令需要在准备的两台Node机器上执行。
安装 docker # 可以参照官网： https://docs.docker.com/engine/install/
# 卸载老版本或重装 docker 时执行第一行 yum remove docker \ docker-client \ docker-client-latest \ docker-common \ docker-latest \ docker-latest-logrotate \ docker-logrotate \ docker-engine -y # 安装 docker yum install -y yum-utils yum-config-manager \ --add-repo \ https://download."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="kubernetes"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Binary Build K8s 04 Deploy Worker | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/kubernetes/binary-build-k8s-04-deploy-worker/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.ffd7553d42e9860dbcfbc6775c0f6c9895736a50f5383929cc725dc0a9b61715.js integrity="sha256-/9dVPULphg28+8Z3XA9smJVzalD1ODkpzHJdwKm2FxU=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Binary Build K8s 04 Deploy Worker</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#写在前面>写在前面</a></li><li><a href=#安装-docker>安装 docker</a></li><li><a href=#安装-kubelet>安装 kubelet</a></li><li><a href=#安装-kube-proxy>安装 kube-proxy</a></li><li><a href=#部署-cni-网络插件>部署 cni 网络插件</a></li><li><a href=#部署-flannel-集群网络>部署 Flannel 集群网络</a></li><li><a href=#k8s-集群测试>K8s 集群测试</a></li><li><a href=#结束语>结束语</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/kubernetes/>Kubernetes</a> / 二进制搭建 K8s - 4 部署 Node</p><h1 id=二进制搭建-k8s---4-部署-node>二进制搭建 K8s - 4 部署 Node
<a class=anchor href=#%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%90%ad%e5%bb%ba-k8s---4-%e9%83%a8%e7%bd%b2-node>#</a></h1><h2 id=写在前面>写在前面
<a class=anchor href=#%e5%86%99%e5%9c%a8%e5%89%8d%e9%9d%a2>#</a></h2><p>记录和分享使用二进制搭建 K8s 集群的详细过程，由于操作比较冗长，大概会分四篇写完：</p><ol><li><strong><a href=/kubernetes/binary-build-k8s-01-prepare-nodes/>机器准备</a></strong>：</li><li><strong><a href=/kubernetes/binary-build-k8s-02-deploy-etcd/>部署 etcd 集群</a></strong>：</li><li><strong><a href=/kubernetes/binary-build-k8s-03-deploy-master/>部署 Master</a></strong>：</li><li><strong><a href=/kubernetes/binary-build-k8s-04-deploy-worker/>部署 Node</a></strong>：</li></ol><p>K8s 的 Node 上需要运行 kubelet 和 kube-proxy。本篇介绍在 Node 机器安装这两个组件，除此之外，安装通信需要的 cni 插件。</p><p>本篇的执行命令需要在准备的两台Node机器上执行。</p><h2 id=安装-docker>安装 docker
<a class=anchor href=#%e5%ae%89%e8%a3%85-docker>#</a></h2><p>可以参照官网：
<a href=https://docs.docker.com/engine/install/>https://docs.docker.com/engine/install/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 卸载老版本或重装 docker 时执行第一行</span>
</span></span><span class=line><span class=cl>yum remove docker <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-client <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-client-latest <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-common <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-latest <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-latest-logrotate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-logrotate <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  docker-engine -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 docker</span>
</span></span><span class=line><span class=cl>yum install -y yum-utils
</span></span><span class=line><span class=cl>yum-config-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --add-repo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span class=line><span class=cl>yum install docker-ce docker-ce-cli containerd.io -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 Docker 版本</span>
</span></span><span class=line><span class=cl>docker version
</span></span></code></pre></div><p>启动 Docker</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl <span class=nb>enable</span> docker
</span></span><span class=line><span class=cl>systemctl start docker
</span></span></code></pre></div><h2 id=安装-kubelet>安装 kubelet
<a class=anchor href=#%e5%ae%89%e8%a3%85-kubelet>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> /root/kubernetes/resources
</span></span><span class=line><span class=cl>tar -zxvf ./kubernetes-node-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>mkdir /etc/kubernetes/<span class=o>{</span>ssl,bin<span class=o>}</span> -p
</span></span><span class=line><span class=cl>cp kubernetes/node/bin/kubelet ./kubernetes/node/bin/kube-proxy /etc/kubernetes/bin
</span></span><span class=line><span class=cl><span class=nb>cd</span> /etc/kubernetes
</span></span></code></pre></div><p>准备 kubelet 配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim kubelet
</span></span></code></pre></div><p>执行上行命令，在 k8s-node01 写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBELET_ARGS</span><span class=o>=</span><span class=s2>&#34;--logtostderr=false \
</span></span></span><span class=line><span class=cl><span class=s2>--v=2 \
</span></span></span><span class=line><span class=cl><span class=s2>--log-dir=/var/log/kubernetes  \
</span></span></span><span class=line><span class=cl><span class=s2>--enable-server=true \
</span></span></span><span class=line><span class=cl><span class=s2>--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s2>--hostname-override=k8s-node01 \
</span></span></span><span class=line><span class=cl><span class=s2>--network-plugin=cni \
</span></span></span><span class=line><span class=cl><span class=s2>--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s2>--config=/etc/kubernetes/kubelet-config.yml \
</span></span></span><span class=line><span class=cl><span class=s2>--cert-dir=/etc/kubernetes/ssl&#34;</span>
</span></span></code></pre></div><p>在 k8s-node02 写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBELET_ARGS</span><span class=o>=</span><span class=s2>&#34;--logtostderr=false \
</span></span></span><span class=line><span class=cl><span class=s2>--v=2 \
</span></span></span><span class=line><span class=cl><span class=s2>--log-dir=/var/log/kubernetes  \
</span></span></span><span class=line><span class=cl><span class=s2>--enable-server=true \
</span></span></span><span class=line><span class=cl><span class=s2>--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s2>--hostname-override=k8s-node02 \
</span></span></span><span class=line><span class=cl><span class=s2>--network-plugin=cni \
</span></span></span><span class=line><span class=cl><span class=s2>--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s2>--config=/etc/kubernetes/kubelet-config.yml \
</span></span></span><span class=line><span class=cl><span class=s2>--cert-dir=/etc/kubernetes/ssl&#34;</span>
</span></span></code></pre></div><p>准备 bootstrap.kubeconfig 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/kubernetes/bootstrap.kubeconfig
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/ca.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://192.168.115.131:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>d5c5d767b64db39db132b433e9c45fbc</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>注意：token 的值需要替换为 master 生成的 token.csv 中所用的 token。</p></blockquote><p>准备 kubelet-config.yml 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim kubelet-config.yml
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kind: KubeletConfiguration
</span></span><span class=line><span class=cl>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span class=line><span class=cl>address: 0.0.0.0
</span></span><span class=line><span class=cl>port: <span class=m>10250</span>
</span></span><span class=line><span class=cl>readOnlyPort: <span class=m>10255</span>
</span></span><span class=line><span class=cl>cgroupDriver: cgroupfs
</span></span><span class=line><span class=cl>clusterDNS:
</span></span><span class=line><span class=cl>- 10.0.0.2
</span></span><span class=line><span class=cl>clusterDomain: cluster.local 
</span></span><span class=line><span class=cl>failSwapOn: <span class=nb>false</span>
</span></span><span class=line><span class=cl>authentication:
</span></span><span class=line><span class=cl>  anonymous:
</span></span><span class=line><span class=cl>    enabled: <span class=nb>false</span>
</span></span><span class=line><span class=cl>  webhook:
</span></span><span class=line><span class=cl>    cacheTTL: 2m0s
</span></span><span class=line><span class=cl>    enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  x509:
</span></span><span class=line><span class=cl>    clientCAFile: /etc/kubernetes/ssl/ca.pem 
</span></span><span class=line><span class=cl>authorization:
</span></span><span class=line><span class=cl>  mode: Webhook
</span></span><span class=line><span class=cl>  webhook:
</span></span><span class=line><span class=cl>    cacheAuthorizedTTL: 5m0s
</span></span><span class=line><span class=cl>    cacheUnauthorizedTTL: 30s
</span></span><span class=line><span class=cl>evictionHard:
</span></span><span class=line><span class=cl>  imagefs.available: 15%
</span></span><span class=line><span class=cl>  memory.available: 100Mi
</span></span><span class=line><span class=cl>  nodefs.available: 10%
</span></span><span class=line><span class=cl>  nodefs.inodesFree: 5%
</span></span><span class=line><span class=cl>maxOpenFiles: <span class=m>1000000</span>
</span></span><span class=line><span class=cl>maxPods: <span class=m>110</span>
</span></span></code></pre></div><p>准备 kubelet.kubeconfig 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim kubelet.kubeconfig
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>kubelet.kubeconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/ca.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://192.168.115.131:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>default-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>default-context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-certificate</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/kubelet-client-current.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-key</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/kubelet-client-current.pem</span><span class=w>
</span></span></span></code></pre></div><p>准备kubelet服务配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /usr/lib/systemd/system/kubelet.service
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Kubelet</span>
</span></span><span class=line><span class=cl><span class=na>Documentation</span><span class=o>=</span><span class=s>https://github.com/GoogleCloudPlatform/kubernetes</span>
</span></span><span class=line><span class=cl><span class=na>After</span><span class=o>=</span><span class=s>docker.service</span>
</span></span><span class=line><span class=cl><span class=na>Requires</span><span class=o>=</span><span class=s>docker.service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>EnvironmentFile</span><span class=o>=</span><span class=s>/etc/kubernetes/kubelet</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/etc/kubernetes/bin/kubelet $KUBELET_ARGS</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>on-failure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><p>启动 kubelet：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start kubelet
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> kubelet
</span></span><span class=line><span class=cl>systemctl status kubelet
</span></span></code></pre></div><p>给 Node 颁发证书，在 Master 上执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get csr
</span></span><span class=line><span class=cl><span class=c1># 输出如下</span>
</span></span><span class=line><span class=cl>NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span class=line><span class=cl>node-csr-a-BmW9xMglOXlUdwBjD2QQphXLdu4iwtamEIIbhJKcY   10m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span class=line><span class=cl>node-csr-zDDrVyKH7ug8fTUcDjdvDgh-f9rVCyoHuLMGaWbykAQ   10m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span></code></pre></div><p>得到证书的 NAME，给其 Approve：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl certificate approve node-csr-a-BmW9xMglOXlUdwBjD2QQphXLdu4iwtamEIIbhJKcY
</span></span><span class=line><span class=cl>kubectl certificate approve node-csr-zDDrVyKH7ug8fTUcDjdvDgh-f9rVCyoHuLMGaWbykAQ 
</span></span></code></pre></div><p>再次查看证书，证书的 CONDITION 就会更新了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get csr
</span></span><span class=line><span class=cl><span class=c1># 输出如下</span>
</span></span><span class=line><span class=cl>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span class=line><span class=cl>node-csr-a-BmW9xMglOXlUdwBjD2QQphXLdu4iwtamEIIbhJKcY   10m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span><span class=line><span class=cl>node-csr-zDDrVyKH7ug8fTUcDjdvDgh-f9rVCyoHuLMGaWbykAQ   10m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued
</span></span></code></pre></div><p>接下来使用查看 Node 的命令，应该可以获取到 Node 信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get node
</span></span><span class=line><span class=cl><span class=c1># 输出如下</span>
</span></span><span class=line><span class=cl>NAME         STATUS     ROLES    AGE     VERSION
</span></span><span class=line><span class=cl>k8s-node01   NotReady   &lt;none&gt;   50s   v1.18.3
</span></span><span class=line><span class=cl>k8s-node02   NotReady   &lt;none&gt;   56s   v1.18.3
</span></span></code></pre></div><h2 id=安装-kube-proxy>安装 kube-proxy
<a class=anchor href=#%e5%ae%89%e8%a3%85-kube-proxy>#</a></h2><p>准备 kube-proxy 配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim kube-proxy
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>KUBE<span class=nb>_</span>PROXY<span class=nb>_</span>ARGS=&#34;--logtostderr=false <span class=k>\</span>
</span></span><span class=line><span class=cl>--v=2 <span class=k>\</span>
</span></span><span class=line><span class=cl>--log-dir=/var/log/kubernetes <span class=k>\</span>
</span></span><span class=line><span class=cl>--config=/etc/kubernetes/kube-proxy-config.yml&#34;
</span></span></code></pre></div><p>准备 kube-proxy-config.yml 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/kubernetes/kube-proxy-config.yml
</span></span></code></pre></div><p>执行上行命令，在 k8s-node01 写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kind: KubeProxyConfiguration
</span></span><span class=line><span class=cl>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span class=line><span class=cl>address: 0.0.0.0
</span></span><span class=line><span class=cl>metricsBindAddress: 0.0.0.0:10249
</span></span><span class=line><span class=cl>iclientConnection:
</span></span><span class=line><span class=cl>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>hostnameOverride: k8s-node01
</span></span><span class=line><span class=cl>clusterCIDR: 10.0.0.0/24
</span></span><span class=line><span class=cl>mode: ipvs
</span></span><span class=line><span class=cl>ipvs:
</span></span><span class=line><span class=cl>  scheduler: <span class=s2>&#34;rr&#34;</span>
</span></span><span class=line><span class=cl>iptables:
</span></span><span class=line><span class=cl>  masqueradeAll: <span class=nb>true</span>
</span></span></code></pre></div><p>在 k8s-node02 写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeProxyConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeproxy.config.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metricsBindAddress</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>10249</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clientConnection</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/kube-proxy.kubeconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>hostnameOverride</span><span class=p>:</span><span class=w> </span><span class=l>k8s-node02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterCIDR</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>ipvs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ipvs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;rr&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>iptables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>masqueradeAll</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>准备 kube-proxy.kubeconfig 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/kubernetes/kube-proxy.kubeconfig
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/ca.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://192.168.115.131:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>kube-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-certificate</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/kube-proxy.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-key</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/ssl/kube-proxy-key.pem</span><span class=w>
</span></span></span></code></pre></div><p>准备 kube-proxy 服务配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /usr/lib/systemd/system/kube-proxy.service
</span></span></code></pre></div><p>执行上行命令，写入文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Kube-Proxy</span>
</span></span><span class=line><span class=cl><span class=na>Documentation</span><span class=o>=</span><span class=s>https://github.com/GoogleCloudPlatform/kubernetes</span>
</span></span><span class=line><span class=cl><span class=na>After</span><span class=o>=</span><span class=s>network.target</span>
</span></span><span class=line><span class=cl><span class=na>Requires</span><span class=o>=</span><span class=s>network.target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>EnvironmentFile</span><span class=o>=</span><span class=s>/etc/kubernetes/kube-proxy</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/etc/kubernetes/bin/kube-proxy $KUBE_PROXY_ARGS</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>on-failure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><p>启动 kubelet：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start kube-proxy
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> kube-proxy
</span></span><span class=line><span class=cl>systemctl status kube-proxy
</span></span></code></pre></div><h2 id=部署-cni-网络插件>部署 cni 网络插件
<a class=anchor href=#%e9%83%a8%e7%bd%b2-cni-%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /root/kubernetes/resources
</span></span><span class=line><span class=cl>mkdir -p /opt/cni/bin /etc/cni/net.d
</span></span><span class=line><span class=cl>tar -zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</span></span></code></pre></div><h2 id=部署-flannel-集群网络>部署 Flannel 集群网络
<a class=anchor href=#%e9%83%a8%e7%bd%b2-flannel-%e9%9b%86%e7%be%a4%e7%bd%91%e7%bb%9c>#</a></h2><p>需要在 Master 机器上执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /root/kubernetes/resources
</span></span><span class=line><span class=cl>kubectl apply -f kube-flannel.yml
</span></span></code></pre></div><p>创建角色绑定</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole<span class=o>=</span>system:kubelet-api-admin --user kubernetes
</span></span></code></pre></div><h2 id=k8s-集群测试>K8s 集群测试
<a class=anchor href=#k8s-%e9%9b%86%e7%be%a4%e6%b5%8b%e8%af%95>#</a></h2><p>部署一个 nginx 的 deployment：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create deployment nginx --image<span class=o>=</span>nginx
</span></span><span class=line><span class=cl><span class=c1># 在等待几秒后，获取 deployment</span>
</span></span><span class=line><span class=cl>kubectl get deployment
</span></span><span class=line><span class=cl>ifconfig cni0
</span></span><span class=line><span class=cl>kubectl expose deployment nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort
</span></span><span class=line><span class=cl>kubectl get svc
</span></span></code></pre></div><p>可以看到 nginx 已经启动成功。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>nginx   1/1     <span class=m>1</span>            <span class=m>1</span>           7m7s
</span></span></code></pre></div><blockquote><p>注意：如果启动失败，可能是由于网络原因拉取镜像失败导致。可以通过 <code>kubectl describe pod &lt;pod-name></code> 查看。</p></blockquote><p>使用 service 暴露 K8s 集群内部 Pod 服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl expose deployment nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort
</span></span><span class=line><span class=cl><span class=c1># 获取 service</span>
</span></span><span class=line><span class=cl>kubectl get svc
</span></span></code></pre></div><p>可以看到，service 将 nginx 的服务转发到了 31839 端口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
</span></span><span class=line><span class=cl>kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP        10h
</span></span><span class=line><span class=cl>nginx        NodePort    10.0.0.101   &lt;none&gt;        80:31839/TCP   10s
</span></span></code></pre></div><p>此时，我们在 Node 机器上使用该端口访问 nginx，可以看到成功访问。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>[root@k8s-node01]# curl 192.168.115.132:31839
</span></span><span class=line><span class=cl>&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class=line><span class=cl>&lt;style&gt;
</span></span><span class=line><span class=cl>    body <span class=nb>{</span>
</span></span><span class=line><span class=cl>        width: 35em;
</span></span><span class=line><span class=cl>        margin: 0 auto;
</span></span><span class=line><span class=cl>        font-family: Tahoma, Verdana, Arial, sans-serif;
</span></span><span class=line><span class=cl>    <span class=nb>}</span>
</span></span><span class=line><span class=cl>&lt;/style&gt;
</span></span><span class=line><span class=cl>&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class=line><span class=cl>working. Further configuration is required.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;For online documentation and support please refer to
</span></span><span class=line><span class=cl>&lt;a href=&#34;http://nginx.org/&#34;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class=line><span class=cl>Commercial support is available at
</span></span><span class=line><span class=cl>&lt;a href=&#34;http://nginx.com/&#34;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></div><p>好了，至此第四段落<strong>部署 Node</strong>也顺利结束。</p><h2 id=结束语>结束语
<a class=anchor href=#%e7%bb%93%e6%9d%9f%e8%af%ad>#</a></h2><p>在使用二进制搭建 K8s 集群的过程中，搭建的过程参考了很多园友的博客。由于我是使用最新的 K8s、etcd 版本搭建的，遇到了很多的问题，但没有关系，好事多磨。</p><p>在遇到问题的时候，几乎都是通过查看 K8s 中组件的运行状态和日志来寻找问题根源和解决方案的。</p><p>大部分问题都是出在配置方面，或是文件路径配置问题，或是新版本的配置不兼容问题。</p><hr><p><a href=/kubernetes/binary-build-k8s-03-deploy-master/>« 二进制搭建 K8s - 3 部署 Master</a></p><p><a href=/kubernetes/cloud-native-understood/>» Kubernetes 0-1 尝试理解云原生</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/kubernetes/binary-build-k8s-04-deploy-worker.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#写在前面>写在前面</a></li><li><a href=#安装-docker>安装 docker</a></li><li><a href=#安装-kubelet>安装 kubelet</a></li><li><a href=#安装-kube-proxy>安装 kube-proxy</a></li><li><a href=#部署-cni-网络插件>部署 cni 网络插件</a></li><li><a href=#部署-flannel-集群网络>部署 Flannel 集群网络</a></li><li><a href=#k8s-集群测试>K8s 集群测试</a></li><li><a href=#结束语>结束语</a></li></ul></nav></div></aside></main></body></html>