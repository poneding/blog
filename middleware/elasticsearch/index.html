<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='我的博客 / 数据中间件 / Elasticsearch
Elasticsearch # 全文搜索
API # 题外话：
幂等性：多次执行同样的请求，资源只能创建或修改一次
POST 请求不是幂等性的，同样的数据请求，会造成不同的影响
PUT 是幂等性的，同样的请求造成的影响是一样的
创建索引 # PUT /users 查询索引 # 获取单个索引
GET /users 获取所有索引
GET /_cat/indices?v 删除索引 # DELETE /users 创建文档 # 这个操作是在单个索引下的
POST /users/_doc # 一定需要body，否则报错 body: { "name": "dp", "age": 18 } 上面这个文档创建时会生成随机 ID（返回结果中的 _id），不便维护，使用下面的方法自定义文档 ID，此时由于 ID 自定义了，就要求幂等，所以可以使用 PUT 方法
POST | PUT /users/_doc/1002 PUT /users/_create/1003 # 一定需要body，否则报错 body: { "name": "dp", "age": 18 } 查询文档 # 获取单个文档'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/middleware/elasticsearch/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content='我的博客 / 数据中间件 / Elasticsearch
Elasticsearch # 全文搜索
API # 题外话：
幂等性：多次执行同样的请求，资源只能创建或修改一次
POST 请求不是幂等性的，同样的数据请求，会造成不同的影响
PUT 是幂等性的，同样的请求造成的影响是一样的
创建索引 # PUT /users 查询索引 # 获取单个索引
GET /users 获取所有索引
GET /_cat/indices?v 删除索引 # DELETE /users 创建文档 # 这个操作是在单个索引下的
POST /users/_doc # 一定需要body，否则报错 body: { "name": "dp", "age": 18 } 上面这个文档创建时会生成随机 ID（返回结果中的 _id），不便维护，使用下面的方法自定义文档 ID，此时由于 ID 自定义了，就要求幂等，所以可以使用 PUT 方法
POST | PUT /users/_doc/1002 PUT /users/_create/1003 # 一定需要body，否则报错 body: { "name": "dp", "age": 18 } 查询文档 # 获取单个文档'><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="middleware"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Elasticsearch | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/middleware/elasticsearch/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.ffd7553d42e9860dbcfbc6775c0f6c9895736a50f5383929cc725dc0a9b61715.js integrity="sha256-/9dVPULphg28+8Z3XA9smJVzalD1ODkpzHJdwKm2FxU=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Elasticsearch</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#api>API</a><ul><li><a href=#创建索引>创建索引</a></li><li><a href=#查询索引>查询索引</a></li><li><a href=#删除索引>删除索引</a></li><li><a href=#创建文档>创建文档</a></li><li><a href=#查询文档>查询文档</a></li><li><a href=#修改文档>修改文档</a></li><li><a href=#删除文档>删除文档</a></li></ul></li><li><a href=#复杂查询>复杂查询</a><ul><li><a href=#条件查询>条件查询</a></li><li><a href=#多条件查询>多条件查询</a></li><li><a href=#聚合查询>聚合查询</a></li></ul></li><li><a href=#设置>设置</a><ul><li><a href=#设置集群最大索引数>设置集群最大索引数</a></li><li><a href=#设置删除权限>设置删除权限</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/middleware/>数据中间件</a> / Elasticsearch</p><h1 id=elasticsearch>Elasticsearch
<a class=anchor href=#elasticsearch>#</a></h1><p>全文搜索</p><h2 id=api>API
<a class=anchor href=#api>#</a></h2><p>题外话：</p><p>幂等性：多次执行同样的请求，资源只能创建或修改一次</p><p>POST 请求不是幂等性的，同样的数据请求，会造成不同的影响</p><p>PUT 是幂等性的，同样的请求造成的影响是一样的</p><h3 id=创建索引>创建索引
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>PUT
/users
</code></pre><h3 id=查询索引>查询索引
<a class=anchor href=#%e6%9f%a5%e8%af%a2%e7%b4%a2%e5%bc%95>#</a></h3><p>获取单个索引</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users
</code></pre><p>获取所有索引</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/_cat/indices?v
</code></pre><h3 id=删除索引>删除索引
<a class=anchor href=#%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>DELETE
/users
</code></pre><h3 id=创建文档>创建文档
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e6%96%87%e6%a1%a3>#</a></h3><p>这个操作是在单个索引下的</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>POST
/users/_doc
# 一定需要body，否则报错
body:
{
  &#34;name&#34;: &#34;dp&#34;,
  &#34;age&#34;: 18
}
</code></pre><p>上面这个文档创建时会生成随机 ID（返回结果中的 _id），不便维护，使用下面的方法自定义文档 ID，此时由于 ID 自定义了，就要求幂等，所以可以使用 PUT 方法</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>POST | PUT
/users/_doc/1002
PUT
/users/_create/1003
# 一定需要body，否则报错
body:
{
  &#34;name&#34;: &#34;dp&#34;,
  &#34;age&#34;: 18
}
</code></pre><h3 id=查询文档>查询文档
<a class=anchor href=#%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3>#</a></h3><p>获取单个文档</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users/_doc/1001
</code></pre><p>获取所有文档</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users/_search
</code></pre><h3 id=修改文档>修改文档
<a class=anchor href=#%e4%bf%ae%e6%94%b9%e6%96%87%e6%a1%a3>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>PUT
/users/_doc/1001
body:
{
  &#34;name&#34;: &#34;dp&#34;,
  &#34;age&#34;: 28
}
</code></pre><p>你可能发现了，PUT 既可以创建也可以修改。</p><p>修改特定字段（非幂等）</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>POST
/users/_update/1001
body:
{
  &#34;doc&#34;: {
    &#34;age&#34;: 29
  }
}
</code></pre><h3 id=删除文档>删除文档
<a class=anchor href=#%e5%88%a0%e9%99%a4%e6%96%87%e6%a1%a3>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>DELETE
/users/_doc/1001
</code></pre><h2 id=复杂查询>复杂查询
<a class=anchor href=#%e5%a4%8d%e6%9d%82%e6%9f%a5%e8%af%a2>#</a></h2><h3 id=条件查询>条件查询
<a class=anchor href=#%e6%9d%a1%e4%bb%b6%e6%9f%a5%e8%af%a2>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users/_search?q=name:dp
</code></pre><p>或者通过请求体查询</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users/_search
{
 &#34;query&#34;: {
  // &#34;match&#34;: {
  //  &#34;name&#34;: &#34;dp&#34;
  // }
  // 查询所有
  &#34;match_all&#34;: {
   
  }
 }
 // 分页
 &#34;from&#34;: 0,
 &#34;size&#34;: 10,
 // 过滤字段
 &#34;_source&#34;: [&#34;name&#34;, &#34;age&#34;]
 // 排序
 &#34;sort&#34;: {
  &#34;age&#34;: {
   &#34;order&#34;: &#34;asc|desc&#34;
  }
 },
 &#34;highlight&#34;: {
  &#34;fields&#34;: {
   &#34;name&#34;: {}
  }
 }
}
</code></pre><blockquote><p>使用 match，如果查询条件是 &ldquo;name&rdquo;: &ldquo;Hello World&rdquo;，查询结果会是 Hello，World 分别查询的结果集合，因为 ES 会将查询关键词拆解，每个单词都单独匹配索引。</p><p>如果香要完全匹配，使用 match_phrase。</p></blockquote><h3 id=多条件查询>多条件查询
<a class=anchor href=#%e5%a4%9a%e6%9d%a1%e4%bb%b6%e6%9f%a5%e8%af%a2>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>GET
/users/_search
{
 &#34;query&#34;: {
  &#34;bool&#34;: {
   // must =&gt; and; should =&gt; or
   &#34;must&#34;: [
    {
     &#34;match&#34;: {
      &#34;name&#34;: &#34;dp&#34;
     }
    },
    {
     &#34;match&#34;: {
      &#34;age&#34;: 28
     }
    }
   ],
   &#34;filter&#34;: {
    &#34;range&#34;: {
     &#34;age&#34;: {
      &#34;gt&#34;: 18
     }
    }
   }
  }
 }
}
</code></pre><h3 id=聚合查询>聚合查询
<a class=anchor href=#%e8%81%9a%e5%90%88%e6%9f%a5%e8%af%a2>#</a></h3><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>{
 &#34;aggs&#34;: { // 聚合操作
  &#34;age_group&#34;: { // 名称，随意命名
   &#34;terms&#34;: { // 分组
    &#34;field&#34;: &#34;age&#34; // 分组字段
   },
   &#34;avg&#34;: { // 平均值
    &#34;field&#34;: &#34;age&#34; // 分组字段
   }
   // 此外还有 max, min
  }
 },
 &#34;size&#34;: 0 //不显示原始数据
}
</code></pre><h2 id=设置>设置
<a class=anchor href=#%e8%ae%be%e7%bd%ae>#</a></h2><h3 id=设置集群最大索引数>设置集群最大索引数
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e9%9b%86%e7%be%a4%e6%9c%80%e5%a4%a7%e7%b4%a2%e5%bc%95%e6%95%b0>#</a></h3><p>如果遇到错误：</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>Validation Failed: 1: this action would add [2] total shards, but this cluster currently has [3000]/[3000] maximum shards open;
</code></pre><p>那么导致该问题的原因可能是由于现创建的 index 太多，已经达到了 <code>cluster.max_shards_per_node</code> 的限制，需要计划清除一些无用的 index 或者增加es集群节点 index 限制：</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>PUT /_cluster/settings
{
  &#34;transient&#34;:
  {
    &#34;cluster.max_shards_per_node&#34;:5000
  }
}
</code></pre><p>或者使用 curl 调用集群设置的 api</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -XPUT <span class=nv>$CLUSTER_URL</span>/_cluster/settings -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data-binary <span class=s1>$&#39;{&#34;transient&#34;:{&#34;cluster.max_shards_per_node&#34;:5000}}&#39;</span>
</span></span></code></pre></div><h3 id=设置删除权限>设置删除权限
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e5%88%a0%e9%99%a4%e6%9d%83%e9%99%90>#</a></h3><p>删除权限需要</p><pre tabindex=0><code class=language-elasticsearch data-lang=elasticsearch>PUT /_cluster/settings
{
  &#34;persistent&#34; : {
    &#34;action.destructive_requires_name&#34; : &#34;false&#34;
  }
}
</code></pre><p>或者使用 curl 调用集群设置的 api</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -XPUT <span class=nv>$CLUSTER_URL</span>/_cluster/settings -H <span class=s1>&#39;Content-type: application/json&#39;</span> --data-binary <span class=s1>$&#39;{&#34;persistent&#34;:{&#34;action.destructive_requires_name&#34;:&#34;false&#34;}}&#39;</span>
</span></span></code></pre></div><hr><p><a href=/middleware/mongodb/>» MongoDB</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/middleware/elasticsearch.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#api>API</a><ul><li><a href=#创建索引>创建索引</a></li><li><a href=#查询索引>查询索引</a></li><li><a href=#删除索引>删除索引</a></li><li><a href=#创建文档>创建文档</a></li><li><a href=#查询文档>查询文档</a></li><li><a href=#修改文档>修改文档</a></li><li><a href=#删除文档>删除文档</a></li></ul></li><li><a href=#复杂查询>复杂查询</a><ul><li><a href=#条件查询>条件查询</a></li><li><a href=#多条件查询>多条件查询</a></li><li><a href=#聚合查询>聚合查询</a></li></ul></li><li><a href=#设置>设置</a><ul><li><a href=#设置集群最大索引数>设置集群最大索引数</a></li><li><a href=#设置删除权限>设置删除权限</a></li></ul></li></ul></nav></div></aside></main></body></html>