<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我的博客 / Kubernetes / Kustomize
Kustomize # Kustomize 是一个通过 kustomization 文件 定制 Kubernetes 对象的工具。它提供以下功能特性来管理应用配置文件：
从其他来源生成资源 为资源设置贯穿性（Cross-Cutting）字段 组织和定制资源集合 从 1.14 版本开始，kubectl 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：
kubectl kustomize <kustomization_directory> 要应用这些资源，使用 --kustomize 或 -k 参数来执行 kubectl apply：
kubectl apply -k <kustomization_directory> 生成资源 # ConfigMap 和 Secret 包含其他 Kubernetes 对象（如 Pod）所需要的配置或敏感数据。 ConfigMap 或 Secret 中数据的来源往往是集群外部，例如某个 .properties 文件或者 SSH 密钥文件。 Kustomize 提供 secretGenerator 和 configMapGenerator，可以基于文件或字面值来生成 Secret 和 ConfigMap。
configMapGenerator # 要基于文件来生成 ConfigMap，可以在 configMapGenerator 的 files 列表中添加表项。 下面是一个根据 ."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/kubernetes/kustomize/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content="我的博客 / Kubernetes / Kustomize
Kustomize # Kustomize 是一个通过 kustomization 文件 定制 Kubernetes 对象的工具。它提供以下功能特性来管理应用配置文件：
从其他来源生成资源 为资源设置贯穿性（Cross-Cutting）字段 组织和定制资源集合 从 1.14 版本开始，kubectl 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：
kubectl kustomize <kustomization_directory> 要应用这些资源，使用 --kustomize 或 -k 参数来执行 kubectl apply：
kubectl apply -k <kustomization_directory> 生成资源 # ConfigMap 和 Secret 包含其他 Kubernetes 对象（如 Pod）所需要的配置或敏感数据。 ConfigMap 或 Secret 中数据的来源往往是集群外部，例如某个 .properties 文件或者 SSH 密钥文件。 Kustomize 提供 secretGenerator 和 configMapGenerator，可以基于文件或字面值来生成 Secret 和 ConfigMap。
configMapGenerator # 要基于文件来生成 ConfigMap，可以在 configMapGenerator 的 files 列表中添加表项。 下面是一个根据 ."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="kubernetes"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Kustomize | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/kubernetes/kustomize/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.ffd7553d42e9860dbcfbc6775c0f6c9895736a50f5383929cc725dc0a9b61715.js integrity="sha256-/9dVPULphg28+8Z3XA9smJVzalD1ODkpzHJdwKm2FxU=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Kustomize</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#生成资源>生成资源</a><ul><li><a href=#configmapgenerator>configMapGenerator</a></li><li><a href=#设置贯穿性字段>设置贯穿性字段</a></li><li><a href=#组织和定制资源>组织和定制资源</a></li></ul></li><li><a href=#基准bases与覆盖overlays>基准（Bases）与覆盖（Overlays）</a></li><li><a href=#如何使用-kustomize-来应用查看和删除对象>如何使用 Kustomize 来应用、查看和删除对象</a></li><li><a href=#kustomize-功能特性列表>Kustomize 功能特性列表</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/kubernetes/>Kubernetes</a> / Kustomize</p><h1 id=kustomize>Kustomize
<a class=anchor href=#kustomize>#</a></h1><p>Kustomize 是一个通过
<a href=https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization>kustomization 文件</a> 定制 Kubernetes 对象的工具。它提供以下功能特性来管理应用配置文件：</p><ul><li>从其他来源生成资源</li><li>为资源设置贯穿性（Cross-Cutting）字段</li><li>组织和定制资源集合</li></ul><p>从 1.14 版本开始，<code>kubectl</code> 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize &lt;kustomization_directory&gt;
</span></span></code></pre></div><p>要应用这些资源，使用 <code>--kustomize</code> 或 <code>-k</code> 参数来执行 <code>kubectl apply</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -k &lt;kustomization_directory&gt;
</span></span></code></pre></div><h2 id=生成资源>生成资源
<a class=anchor href=#%e7%94%9f%e6%88%90%e8%b5%84%e6%ba%90>#</a></h2><p>ConfigMap 和 Secret 包含其他 Kubernetes 对象（如 Pod）所需要的配置或敏感数据。 ConfigMap 或 Secret 中数据的来源往往是集群外部，例如某个 <code>.properties</code> 文件或者 SSH 密钥文件。 Kustomize 提供 <code>secretGenerator</code> 和 <code>configMapGenerator</code>，可以基于文件或字面值来生成 Secret 和 ConfigMap。</p><h3 id=configmapgenerator>configMapGenerator
<a class=anchor href=#configmapgenerator>#</a></h3><p>要基于文件来生成 ConfigMap，可以在 <code>configMapGenerator</code> 的 <code>files</code> 列表中添加表项。 下面是一个根据 <code>.properties</code> 文件中的数据条目来生成 ConfigMap 的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 生成一个  application.properties 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;application.properties
</span></span></span><span class=line><span class=cl><span class=s>FOO=Bar
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>configMapGenerator:
</span></span></span><span class=line><span class=cl><span class=s>- name: example-configmap-1
</span></span></span><span class=line><span class=cl><span class=s>  files:
</span></span></span><span class=line><span class=cl><span class=s>  - application.properties
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>所生成的 ConfigMap 可以使用下面的命令来检查：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize ./
</span></span></code></pre></div><p>所生成的 ConfigMap 为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    FOO=Bar    </span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1-8mbdf7882g</span><span class=w>
</span></span></span></code></pre></div><p>要从 env 文件生成 ConfigMap，请在 <code>configMapGenerator</code> 中的 <code>envs</code> 列表中添加一个条目。 下面是一个用来自 <code>.env</code> 文件的数据生成 ConfigMap 的例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个 .env 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;.env
</span></span></span><span class=line><span class=cl><span class=s>FOO=Bar
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>configMapGenerator:
</span></span></span><span class=line><span class=cl><span class=s>- name: example-configmap-1
</span></span></span><span class=line><span class=cl><span class=s>  envs:
</span></span></span><span class=line><span class=cl><span class=s>  - .env
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>可以使用以下命令检查生成的 ConfigMap：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize ./
</span></span></code></pre></div><p>生成的 ConfigMap 为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>FOO</span><span class=p>:</span><span class=w> </span><span class=l>Bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1-42cfbf598f</span><span class=w>
</span></span></span></code></pre></div><p><strong>说明：</strong>：</p><p><code>.env</code> 文件中的每个变量在生成的 ConfigMap 中成为一个单独的键。这与之前的示例不同， 前一个示例将一个名为 <code>application.properties</code> 的文件（及其所有条目）嵌入到同一个键的值中。</p><p>ConfigMap 也可基于字面的键值偶对来生成。要基于键值偶对来生成 ConfigMap， 在 <code>configMapGenerator</code> 的 <code>literals</code> 列表中添加表项。下面是一个例子， 展示如何使用键值偶对中的数据条目来生成 ConfigMap 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>configMapGenerator:
</span></span></span><span class=line><span class=cl><span class=s>- name: example-configmap-2
</span></span></span><span class=line><span class=cl><span class=s>  literals:
</span></span></span><span class=line><span class=cl><span class=s>  - FOO=Bar
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>可以用下面的命令检查所生成的 ConfigMap：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize ./
</span></span></code></pre></div><p>所生成的 ConfigMap 为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>FOO</span><span class=p>:</span><span class=w> </span><span class=l>Bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-2-g2hdhfc6tk</span><span class=w>
</span></span></span></code></pre></div><p>要在 Deployment 中使用生成的 ConfigMap，使用 configMapGenerator 的名称对其进行引用。 Kustomize 将自动使用生成的名称替换该名称。</p><p>这是使用生成的 ConfigMap 的 deployment 示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 创建一个 application.properties 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cat &lt;&lt;EOF &gt;application.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>FOO=Bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cat &lt;&lt;EOF &gt;deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cat &lt;&lt;EOF &gt;./kustomization.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>configMapGenerator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>application.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span></code></pre></div><p>生成 ConfigMap 和 Deployment：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl kustomize ./
</span></span></code></pre></div><p>生成的 Deployment 将通过名称引用生成的 ConfigMap：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    FOO=Bar    </span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1-g4hk9g2ff8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-configmap-1-g4hk9g2ff8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span></code></pre></div><h4 id=secretgenerator>secretGenerator
<a class=anchor href=#secretgenerator>#</a></h4><p>你可以基于文件或者键值偶对来生成 Secret。要使用文件内容来生成 Secret， 在 <code>secretGenerator</code> 下面的 <code>files</code> 列表中添加表项。使用和 <code>configMapGenerator</code> 基本一致。</p><h3 id=设置贯穿性字段>设置贯穿性字段
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e8%b4%af%e7%a9%bf%e6%80%a7%e5%ad%97%e6%ae%b5>#</a></h3><p>在项目中为所有 Kubernetes 对象设置贯穿性字段是一种常见操作。 贯穿性字段的一些使用场景如下：</p><ul><li>为所有资源设置相同的名字空间</li><li>为所有对象添加相同的前缀或后缀</li><li>为对象添加相同的标签集合</li><li>为对象添加相同的注解集合</li></ul><p>下面是一个例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个 deployment.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-deployment
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: nginx
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namespace: my-namespace
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: dev-
</span></span></span><span class=line><span class=cl><span class=s>nameSuffix: &#34;-001&#34;
</span></span></span><span class=line><span class=cl><span class=s>commonLabels:
</span></span></span><span class=line><span class=cl><span class=s>  app: bingo
</span></span></span><span class=line><span class=cl><span class=s>commonAnnotations:
</span></span></span><span class=line><span class=cl><span class=s>  oncallPager: 800-555-1212
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行 <code>kubectl kustomize ./</code> 查看这些字段都被设置到 Deployment 资源上：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>oncallPager</span><span class=p>:</span><span class=w> </span><span class=m>800-555-1212</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>bingo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev-nginx-deployment-001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>bingo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oncallPager</span><span class=p>:</span><span class=w> </span><span class=m>800-555-1212</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>bingo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></div><h3 id=组织和定制资源>组织和定制资源
<a class=anchor href=#%e7%bb%84%e7%bb%87%e5%92%8c%e5%ae%9a%e5%88%b6%e8%b5%84%e6%ba%90>#</a></h3><p>一种常见的做法是在项目中构造资源集合并将其放到同一个文件或目录中管理。 Kustomize 提供基于不同文件来组织资源并向其应用补丁或者其他定制的能力。</p><h4 id=组织>组织
<a class=anchor href=#%e7%bb%84%e7%bb%87>#</a></h4><p>Kustomize 支持组合不同的资源。<code>kustomization.yaml</code> 文件的 <code>resources</code> 字段定义配置中要包含的资源列表。 你可以将 <code>resources</code> 列表中的路径设置为资源配置文件的路径。 下面是由 Deployment 和 Service 构成的 NGINX 应用的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建 deployment.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 service.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; service.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 kustomization.yaml 来组织以上两个资源</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>- service.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p><code>kubectl kustomize ./</code> 所得到的资源中既包含 Deployment 也包含 Service 对象。</p><h4 id=定制>定制
<a class=anchor href=#%e5%ae%9a%e5%88%b6>#</a></h4><p>补丁文件（Patches）可以用来对资源执行不同的定制。 Kustomize 通过 <code>patchesStrategicMerge</code> 和 <code>patchesJson6902</code> 支持不同的打补丁机制。 <code>patchesStrategicMerge</code> 的内容是一个文件路径的列表，其中每个文件都应可解析为
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md>策略性合并补丁（Strategic Merge Patch）</a>。 补丁文件中的名称必须与已经加载的资源的名称匹配。 建议构造规模较小的、仅做一件事情的补丁。 例如，构造一个补丁来增加 Deployment 的副本个数；构造另外一个补丁来设置内存限制。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建 deployment.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成一个补丁 increase_replicas.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; increase_replicas.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成另一个补丁 set_memory.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; set_memory.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        resources:
</span></span></span><span class=line><span class=cl><span class=s>          limits:
</span></span></span><span class=line><span class=cl><span class=s>            memory: 512Mi
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>patchesStrategicMerge:
</span></span></span><span class=line><span class=cl><span class=s>- increase_replicas.yaml
</span></span></span><span class=line><span class=cl><span class=s>- set_memory.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行 <code>kubectl kustomize ./</code> 来查看 Deployment：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span></code></pre></div><p>并非所有资源或者字段都支持策略性合并补丁。为了支持对任何资源的任何字段进行修改， Kustomize 提供通过 <code>patchesJson6902</code> 来应用
<a href=https://tools.ietf.org/html/rfc6902>JSON 补丁</a>的能力。 为了给 JSON 补丁找到正确的资源，需要在 <code>kustomization.yaml</code> 文件中指定资源的组（group）、 版本（version）、类别（kind）和名称（name）。 例如，为某 Deployment 对象增加副本个数的操作也可以通过 <code>patchesJson6902</code> 来完成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个 deployment.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个 JSON 补丁文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; patch.yaml
</span></span></span><span class=line><span class=cl><span class=s>- op: replace
</span></span></span><span class=line><span class=cl><span class=s>  path: /spec/replicas
</span></span></span><span class=line><span class=cl><span class=s>  value: 3
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个 kustomization.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>patchesJson6902:
</span></span></span><span class=line><span class=cl><span class=s>- target:
</span></span></span><span class=line><span class=cl><span class=s>    group: apps
</span></span></span><span class=line><span class=cl><span class=s>    version: v1
</span></span></span><span class=line><span class=cl><span class=s>    kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>    name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  path: patch.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行 <code>kubectl kustomize ./</code> 以查看 <code>replicas</code> 字段被更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>除了补丁之外，Kustomize 还提供定制容器镜像或者将其他对象的字段值注入到容器中的能力，并且不需要创建补丁。 例如，你可以通过在 <code>kustomization.yaml</code> 文件的 <code>images</code> 字段设置新的镜像来更改容器中使用的镜像。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>images:
</span></span></span><span class=line><span class=cl><span class=s>- name: nginx
</span></span></span><span class=line><span class=cl><span class=s>  newName: my.image.registry/nginx
</span></span></span><span class=line><span class=cl><span class=s>  newTag: 1.4.0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行 <code>kubectl kustomize ./</code> 以查看所使用的镜像已被更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>my.image.registry/nginx:1.4.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>有些时候，Pod 中运行的应用可能需要使用来自其他对象的配置值。 例如，某 Deployment 对象的 Pod 需要从环境变量或命令行参数中读取读取 Service 的名称。 由于在 <code>kustomization.yaml</code> 文件中添加 <code>namePrefix</code> 或 <code>nameSuffix</code> 时 Service 名称可能发生变化，建议不要在命令参数中硬编码 Service 名称。 对于这种使用场景，Kustomize 可以通过 <code>vars</code> 将 Service 名称注入到容器中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个 deployment.yaml 文件（引用此处的文档分隔符）</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;&#39;EOF&#39; &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        command: [&#34;start&#34;, &#34;--host&#34;, &#34;$(MY_SERVICE_NAME)&#34;]
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个 service.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; service.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: dev-
</span></span></span><span class=line><span class=cl><span class=s>nameSuffix: &#34;-001&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>- service.yaml
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>vars:
</span></span></span><span class=line><span class=cl><span class=s>- name: MY_SERVICE_NAME
</span></span></span><span class=line><span class=cl><span class=s>  objref:
</span></span></span><span class=line><span class=cl><span class=s>    kind: Service
</span></span></span><span class=line><span class=cl><span class=s>    name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行 <code>kubectl kustomize ./</code> 以查看注入到容器中的 Service 名称是 <code>dev-my-nginx-001</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev-my-nginx-001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>dev-my-nginx-001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-nginx</span><span class=w>
</span></span></span></code></pre></div><h2 id=基准bases与覆盖overlays>基准（Bases）与覆盖（Overlays）
<a class=anchor href=#%e5%9f%ba%e5%87%86bases%e4%b8%8e%e8%a6%86%e7%9b%96overlays>#</a></h2><p>Kustomize 中有 <strong>基准（bases）</strong> 和 <strong>覆盖（overlays）</strong> 的概念区分。 <strong>基准</strong> 是包含 <code>kustomization.yaml</code> 文件的一个目录，其中包含一组资源及其相关的定制。 基准可以是本地目录或者来自远程仓库的目录，只要其中存在 <code>kustomization.yaml</code> 文件即可。 <strong>覆盖</strong> 也是一个目录，其中包含将其他 kustomization 目录当做 <code>bases</code> 来引用的 <code>kustomization.yaml</code> 文件。 <strong>基准</strong>不了解覆盖的存在，且可被多个覆盖所使用。 覆盖则可以有多个基准，且可针对所有基准中的资源执行组织操作，还可以在其上执行定制。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个包含基准的目录</span>
</span></span><span class=line><span class=cl>mkdir base
</span></span><span class=line><span class=cl><span class=c1># 创建 base/deployment.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; base/deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 base/service.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; base/service.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 base/kustomization.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; base/kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>- service.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>此基准可在多个覆盖中使用。你可以在不同的覆盖中添加不同的 <code>namePrefix</code> 或其他贯穿性字段。 下面是两个使用同一基准的覆盖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir dev
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; dev/kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- ../base
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: dev-
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir prod
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; prod/kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- ../base
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: prod-
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h2 id=如何使用-kustomize-来应用查看和删除对象>如何使用 Kustomize 来应用、查看和删除对象
<a class=anchor href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8-kustomize-%e6%9d%a5%e5%ba%94%e7%94%a8%e6%9f%a5%e7%9c%8b%e5%92%8c%e5%88%a0%e9%99%a4%e5%af%b9%e8%b1%a1>#</a></h2><p>在 <code>kubectl</code> 命令中使用 <code>--kustomize</code> 或 <code>-k</code> 参数来识别被 <code>kustomization.yaml</code> 所管理的资源。 注意 <code>-k</code> 要指向一个 kustomization 目录。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -k &lt;kustomization 目录&gt;/
</span></span></code></pre></div><p>假定使用下面的 <code>kustomization.yaml</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建 deployment.yaml 文件</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        run: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 kustomization.yaml</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: dev-
</span></span></span><span class=line><span class=cl><span class=s>commonLabels:
</span></span></span><span class=line><span class=cl><span class=s>  app: my-nginx
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- deployment.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>执行下面的命令来应用 Deployment 对象 <code>dev-my-nginx</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; kubectl apply -k ./
</span></span><span class=line><span class=cl>deployment.apps/dev-my-nginx created
</span></span></code></pre></div><p>运行下面的命令之一来查看 Deployment 对象 <code>dev-my-nginx</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get -k ./
</span></span><span class=line><span class=cl>kubectl describe -k ./
</span></span></code></pre></div><p>执行下面的命令来比较 Deployment 对象 <code>dev-my-nginx</code> 与清单被应用之后集群将处于的状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl diff -k ./
</span></span></code></pre></div><p>执行下面的命令删除 Deployment 对象 <code>dev-my-nginx</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>&gt; kubectl delete -k ./
</span></span><span class=line><span class=cl>deployment.apps <span class=s2>&#34;dev-my-nginx&#34;</span> deleted
</span></span></code></pre></div><h2 id=kustomize-功能特性列表>Kustomize 功能特性列表
<a class=anchor href=#kustomize-%e5%8a%9f%e8%83%bd%e7%89%b9%e6%80%a7%e5%88%97%e8%a1%a8>#</a></h2><table><thead><tr><th>字段</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>namespace</td><td>string</td><td>为所有资源添加名字空间</td></tr><tr><td>namePrefix</td><td>string</td><td>此字段的值将被添加到所有资源名称前面</td></tr><tr><td>nameSuffix</td><td>string</td><td>此字段的值将被添加到所有资源名称后面</td></tr><tr><td>commonLabels</td><td>map[string]string</td><td>要添加到所有资源和选择算符的标签</td></tr><tr><td>commonAnnotations</td><td>map[string]string</td><td>要添加到所有资源的注解</td></tr><tr><td>resources</td><td>[]string</td><td>列表中的每个条目都必须能够解析为现有的资源配置文件</td></tr><tr><td>configMapGenerator</td><td>[]
<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/configmapargs.go#L7>ConfigMapArgs</a></td><td>列表中的每个条目都会生成一个 ConfigMap</td></tr><tr><td>secretGenerator</td><td>[]SecretArgs[]
<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/secretargs.go#L7>SecretArgs</a></td><td>列表中的每个条目都会生成一个 Secret</td></tr><tr><td>generatorOptions</td><td><a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/generatoroptions.go#L7>GeneratorOptions</a></td><td>更改所有 ConfigMap 和 Secret 生成器的行为</td></tr><tr><td>bases</td><td>[]string</td><td>列表中每个条目都应能解析为一个包含 kustomization.yaml 文件的目录</td></tr><tr><td>patchesStrategicMerge</td><td>[]string</td><td>列表中每个条目都能解析为某 Kubernetes 对象的策略性合并补丁</td></tr><tr><td>patchesJson6902</td><td>[]Patch[]
<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/patch.go#L10>Patch</a></td><td>列表中每个条目都能解析为一个 Kubernetes 对象和一个 JSON 补丁</td></tr><tr><td>vars</td><td>[]
<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/var.go#L19>Var</a></td><td>每个条目用来从某资源的字段来析取文字</td></tr><tr><td>images</td><td>[]Image[]
<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/image.go#L8>images</a></td><td>每个条目都用来更改镜像的名称、标记与/或摘要，不必生成补丁</td></tr><tr><td>configurations</td><td>[]string</td><td>列表中每个条目都应能解析为一个包含
<a href=https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs>Kustomize 转换器配置</a> 的文件</td></tr><tr><td>crds</td><td>[]string</td><td>列表中每个条目都应能够解析为 Kubernetes 类别的 OpenAPI 定义文件</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><hr><p><a href=/kubernetes/kubevirt-practice/>« Kubevirt 实践</a></p><p><a href=/kubernetes/liveness-readiness-probe/>» Kubernetes 0-1 Pod中的livenessProbe和readinessProbe解读</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/kubernetes/kustomize.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#生成资源>生成资源</a><ul><li><a href=#configmapgenerator>configMapGenerator</a></li><li><a href=#设置贯穿性字段>设置贯穿性字段</a></li><li><a href=#组织和定制资源>组织和定制资源</a></li></ul></li><li><a href=#基准bases与覆盖overlays>基准（Bases）与覆盖（Overlays）</a></li><li><a href=#如何使用-kustomize-来应用查看和删除对象>如何使用 Kustomize 来应用、查看和删除对象</a></li><li><a href=#kustomize-功能特性列表>Kustomize 功能特性列表</a></li></ul></nav></div></aside></main></body></html>