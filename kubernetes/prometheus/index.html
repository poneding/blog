<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我的博客 / Kubernetes / Prometheus
Prometheus # Intro # 是一个面向云原生应用程序的开源的监控&报警工具。
开源：继Kubernetes之后的第二个CNCF开源项目，Go语言开发 监控：通过HTTP服务定时从配置的目标收集指标数据，识别数据展示规则，展示监控系统和服务指标数据 报警：监控到的指标数据达到某一设定好的条件时，触发报警机制 时间序列数据库： 时间序列是由唯一的指标名称（Metrics）和一组标签（key=value）的形式组成 PromeQL：基于Prometheus时间序列数据库的一个灵活的查询语言 Prometheus的监控对象 # 资源监控：
服务器的资源使用情况，在Kubernetes集群中，则可以做到对Kubernetes Node、 Deployment 、Pod的资源利用以及apiserver，controller-manager，etcd等组件的监控。
应用监控：
业务应用暴露端口供Prometheus调用实现监测，比如实时的用户在线人数，数据库的当前连接数等。
Prometheus优势 # 支持机器资源和动态配置的应用监控； 多维数据收集和查询； 服务独立，少依赖。 Prometheus组件 # Prometheus Server：采集监控数据，存储时序指标，提供数据查询； Prometheus Client SDK：对接开发工具包，提供自定义的指标数据等； Push Gateway：推送指标数据的网关组件； Third-part Exporter：外部指标采集系统，暴露接口供Prometheus采集； AlertManager：指标数据的分析告警管理器； Architecture overview # 上图来源于官网：
处理流程： 配置资源目标或应用抓取； 抓取资源或应用指标数据； 制定报警规则，推送报警； 灵活查询语言，结合Grafana展示 Installation & Start Up # 1. 以服务进程运行Prometheus # ​ 在ubuntu系统上安装Prometheus，一般有两种方式
第一种，安装命令如下：
wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz tar xvfz prometheus-2.13.1.linux-amd64.tar.gz # 启动Prometheus cd prometheus-2."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/kubernetes/prometheus/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content="我的博客 / Kubernetes / Prometheus
Prometheus # Intro # 是一个面向云原生应用程序的开源的监控&报警工具。
开源：继Kubernetes之后的第二个CNCF开源项目，Go语言开发 监控：通过HTTP服务定时从配置的目标收集指标数据，识别数据展示规则，展示监控系统和服务指标数据 报警：监控到的指标数据达到某一设定好的条件时，触发报警机制 时间序列数据库： 时间序列是由唯一的指标名称（Metrics）和一组标签（key=value）的形式组成 PromeQL：基于Prometheus时间序列数据库的一个灵活的查询语言 Prometheus的监控对象 # 资源监控：
服务器的资源使用情况，在Kubernetes集群中，则可以做到对Kubernetes Node、 Deployment 、Pod的资源利用以及apiserver，controller-manager，etcd等组件的监控。
应用监控：
业务应用暴露端口供Prometheus调用实现监测，比如实时的用户在线人数，数据库的当前连接数等。
Prometheus优势 # 支持机器资源和动态配置的应用监控； 多维数据收集和查询； 服务独立，少依赖。 Prometheus组件 # Prometheus Server：采集监控数据，存储时序指标，提供数据查询； Prometheus Client SDK：对接开发工具包，提供自定义的指标数据等； Push Gateway：推送指标数据的网关组件； Third-part Exporter：外部指标采集系统，暴露接口供Prometheus采集； AlertManager：指标数据的分析告警管理器； Architecture overview # 上图来源于官网：
处理流程： 配置资源目标或应用抓取； 抓取资源或应用指标数据； 制定报警规则，推送报警； 灵活查询语言，结合Grafana展示 Installation & Start Up # 1. 以服务进程运行Prometheus # ​ 在ubuntu系统上安装Prometheus，一般有两种方式
第一种，安装命令如下：
wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz tar xvfz prometheus-2.13.1.linux-amd64.tar.gz # 启动Prometheus cd prometheus-2."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="kubernetes"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Prometheus | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/kubernetes/prometheus/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.9a4e139e0d8feaf510bf71d73a0aec5d39827736ac52bd00d9005a09fd84a9fc.js integrity="sha256-mk4Tng2P6vUQv3HXOgrsXTmCdzasUr0A2QBaCf2Eqfw=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Prometheus</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#prometheus的监控对象>Prometheus的监控对象</a></li><li><a href=#prometheus优势>Prometheus优势</a></li><li><a href=#prometheus组件>Prometheus组件</a></li></ul></li><li><a href=#architecture-overview>Architecture overview</a></li><li><a href=#installation--start-up>Installation & Start Up</a><ul><li><a href=#1-以服务进程运行prometheus>1. 以服务进程运行Prometheus</a></li><li><a href=#2docker启动prometheus>2.Docker启动Prometheus</a></li><li><a href=#3-kubernetes运行prometheus>3. Kubernetes运行Prometheus</a></li><li><a href=#4官方kubernets运行prometheus>4.官方kubernets运行Prometheus</a></li><li><a href=#5kubernetes部署prometheusgrafana>5.Kubernetes部署Prometheus+Grafana</a></li></ul></li><li><a href=#configuring-prometheus>Configuring Prometheus</a></li><li><a href=#concepts>Concepts</a><ul><li><a href=#metrics>Metrics</a></li></ul></li><li><a href=#存储>存储</a><ul><li><a href=#本地存储>本地存储</a></li><li><a href=#远程存储>远程存储</a></li></ul></li><li><a href=#联邦集群>联邦集群</a><ul><li><a href=#使用场景>使用场景</a></li><li><a href=#分层联邦>分层联邦</a></li><li><a href=#跨服务联邦>跨服务联邦</a></li><li><a href=#配置联邦>配置联邦</a></li></ul></li><li><a href=#monitor-app>Monitor App</a><ul><li><a href=#mssql>MSSQL</a></li></ul></li><li><a href=#solved>solved</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/kubernetes/>Kubernetes</a> / Prometheus</p><h1 id=prometheus>Prometheus
<a class=anchor href=#prometheus>#</a></h1><h2 id=intro>Intro
<a class=anchor href=#intro>#</a></h2><p>是一个面向云原生应用程序的开源的<strong>监控</strong>&<strong>报警</strong>工具。</p><blockquote><ul><li>开源：继Kubernetes之后的第二个CNCF开源项目，Go语言开发</li><li>监控：通过HTTP服务定时从配置的目标收集指标数据，识别数据展示规则，展示监控系统和服务指标数据</li><li>报警：监控到的指标数据达到某一设定好的条件时，触发报警机制</li><li>时间序列数据库： 时间序列是由唯一的指标名称（Metrics）和一组标签（key=value）的形式组成</li><li>PromeQL：基于Prometheus时间序列数据库的一个灵活的查询语言</li></ul></blockquote><h3 id=prometheus的监控对象>Prometheus的监控对象
<a class=anchor href=#prometheus%e7%9a%84%e7%9b%91%e6%8e%a7%e5%af%b9%e8%b1%a1>#</a></h3><ul><li><p><strong>资源监控</strong>：</p><p>服务器的资源使用情况，在Kubernetes集群中，则可以做到对Kubernetes Node、 Deployment 、Pod的资源利用以及apiserver，controller-manager，etcd等组件的监控。</p></li><li><p><strong>应用监控</strong>：</p><p>业务应用暴露端口供Prometheus调用实现监测，比如实时的用户在线人数，数据库的当前连接数等。</p></li></ul><h3 id=prometheus优势>Prometheus优势
<a class=anchor href=#prometheus%e4%bc%98%e5%8a%bf>#</a></h3><ul><li>支持机器资源和动态配置的应用监控；</li><li>多维数据收集和查询；</li><li>服务独立，少依赖。</li></ul><h3 id=prometheus组件>Prometheus组件
<a class=anchor href=#prometheus%e7%bb%84%e4%bb%b6>#</a></h3><ul><li><strong>Prometheus Server</strong>：采集监控数据，存储时序指标，提供数据查询；</li><li><strong>Prometheus Client SDK</strong>：对接开发工具包，提供自定义的指标数据等；</li><li><strong>Push Gateway</strong>：推送指标数据的网关组件；</li><li><strong>Third-part Exporter</strong>：外部指标采集系统，暴露接口供Prometheus采集；</li><li><strong>AlertManager</strong>：指标数据的分析告警管理器；</li></ul><h2 id=architecture-overview>Architecture overview
<a class=anchor href=#architecture-overview>#</a></h2><p><img src=https://fs.poneding.com/images/architecture.png alt="Prometheus architecture"></p><p><em>上图来源于官网</em>：</p><ul><li><strong>处理流程</strong>：<ol><li>配置资源目标或应用抓取；</li><li>抓取资源或应用指标数据；</li><li>制定报警规则，推送报警；</li><li>灵活查询语言，结合Grafana展示</li></ol></li></ul><h2 id=installation--start-up>Installation & Start Up
<a class=anchor href=#installation--start-up>#</a></h2><h3 id=1-以服务进程运行prometheus>1. 以服务进程运行Prometheus
<a class=anchor href=#1-%e4%bb%a5%e6%9c%8d%e5%8a%a1%e8%bf%9b%e7%a8%8b%e8%bf%90%e8%a1%8cprometheus>#</a></h3><p>​ 在ubuntu系统上安装Prometheus，一般有两种方式</p><ul><li><p>第一种，安装命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://github.com/prometheus/prometheus/releases/download/v2.13.1/prometheus-2.13.1.linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar xvfz prometheus-2.13.1.linux-amd64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动Prometheus</span>
</span></span><span style=display:flex><span>cd prometheus-2.13.1.linux-amd64
</span></span><span style=display:flex><span>./prometheus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止Prometheus</span>
</span></span><span style=display:flex><span>ps -ef | grep prometheus <span style=color:#75715e># 定位Prometheus进程的pid</span>
</span></span><span style=display:flex><span>kill -s <span style=color:#ae81ff>9</span> <span style=color:#f92672>[</span>pid<span style=color:#f92672>]</span>
</span></span></code></pre></div></li><li><p>第二种，安装命令如下（ubuntu系统）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://s3-eu-west-1.amazonaws.com/deb.robustperception.io/41EFC99D.gpg | sudo apt-key add -
</span></span><span style=display:flex><span>sudo apt-get update -y
</span></span><span style=display:flex><span>sudo apt-get install prometheus prometheus-node-exporter prometheus-pushgateway prometheus-alertmanager -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动Prometheus</span>
</span></span><span style=display:flex><span>sudo systemctl start prometheus
</span></span><span style=display:flex><span>sudo systemctl enable prometheus
</span></span><span style=display:flex><span>sudo systemctl status prometheus
</span></span></code></pre></div></li></ul><h4 id=service-proxy><strong>Service Proxy</strong>
<a class=anchor href=#service-proxy>#</a></h4><p>默认Prometheus的访问方式是http://{ip/domain-name}:9090，而服务器一般的是不会暴露9090端口的，而是暴露80端口，其他端口以nginx代理访问。</p><p>下面的步骤便是将http://{ip/domain-name}:9090代理为http://{ip/domain-name}/prometheus</p><ul><li><p>​ <strong>Step 1 配置prometheus</strong>：</p><ul><li><p>配置&ndash;web.external-url</p><p><strong>如果是第一种方式安装的Prometheus</strong>，则启动Prometheus的命令行需要附带&ndash;web.external-url=prometheus，完整命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./prometheus --web.external-url<span style=color:#f92672>=</span>prometheus
</span></span></code></pre></div><p><strong>如果是第二种方式安装的Prometheus</strong>，则需要在/etc/default/prometheus文件在<code>ARGS=""</code>中添加参数<code>--web.external-url=prometheus</code>，添加完之后，文件应该是像下面这样的：</p><p><img src=https://fs.poneding.com/images/image-20191115102431554.png alt=image-20191115102431554></p></li><li><p>重启prometheus</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart prometheus
</span></span></code></pre></div><p>重启之后，http://{ip/domain-name}:9090/prometheus可以访问。</p></li></ul></li><li><p>​ <strong>Step 2 配置nginx</strong>：</p><p>默认服务器已经安装了nginx。</p><ul><li><p>nginx.conf文件，注释掉以下行：</p><p><code>#include /etc/nginx/sites-enabled/*;</code></p></li><li><p>执行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/nginx/conf.d/prometheus.conf
</span></span></code></pre></div><p>在文件中写入以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    location /prometheus <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        proxy_set_header Host $http_host;
</span></span><span style=display:flex><span>        proxy_redirect off;
</span></span><span style=display:flex><span>        proxy_pass   http://172.31.23.19:9090/prometheus;
</span></span><span style=display:flex><span>        break;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></li><li><p>重启nginx</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart nginx.service
</span></span></code></pre></div><p>重启之后，http://{ip/domain-name}/prometheus可以访问。</p></li></ul></li></ul><h4 id=停止prometheus>停止Prometheus
<a class=anchor href=#%e5%81%9c%e6%ad%a2prometheus>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl stop prometheus
</span></span></code></pre></div><h3 id=2docker启动prometheus>2.Docker启动Prometheus
<a class=anchor href=#2docker%e5%90%af%e5%8a%a8prometheus>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --name prometheus -d -p 127.0.0.1:9090:9090 prom/prometheus
</span></span></code></pre></div><h3 id=3-kubernetes运行prometheus>3. Kubernetes运行Prometheus
<a class=anchor href=#3-kubernetes%e8%bf%90%e8%a1%8cprometheus>#</a></h3><h4 id=configmap>ConfigMap
<a class=anchor href=#configmap>#</a></h4><p>Prometheus的配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus-config</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ns-prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prometheus.yml</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    global: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      scrape_interval: 15s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      scrape_timeout: 15s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    scrape_configs:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - job_name: &#39;prometheus&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      static_configs:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - targets: [&#39;localhost:9090&#39;]</span>    
</span></span></code></pre></div><h4 id=deployment>Deployment
<a class=anchor href=#deployment>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>app/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ns-prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>prom/prometheus</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--config.file=/etc/prometheus/prometheus.yml&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--storage.tsdb.path=/prometheus&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--storage.tsdb.retention=7d&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--web.enable-admin-api&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--web.enable-lifecycle&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/prometheus&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>subPath</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/etc/prometheus&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>1000m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>2Gi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>1000m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>2Gi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus-config</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>prometheus</span>
</span></span></code></pre></div><h4 id=persistentvolumeclaim>PersistentVolumeClaim
<a class=anchor href=#persistentvolumeclaim>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ns-prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#e6db74>&#34;rook-ceph-block&#34;</span>
</span></span></code></pre></div><h4 id=serviceaccount>ServiceAccount
<a class=anchor href=#serviceaccount>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ns-prometheus</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>nodes</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>services</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>endpoints</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>pods</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>nodes/proxy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>watch</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>configmaps</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>nodes/metrics</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>nonResourceURLs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>/metrics</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kube-ops</span>
</span></span></code></pre></div><h4 id=service>Service
<a class=anchor href=#service>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>ns-prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>http</span>
</span></span></code></pre></div><h4 id=apply>Apply
<a class=anchor href=#apply>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get svc -o wide -n ns-prometheus
</span></span></code></pre></div><h3 id=4官方kubernets运行prometheus>4.官方kubernets运行Prometheus
<a class=anchor href=#4%e5%ae%98%e6%96%b9kubernets%e8%bf%90%e8%a1%8cprometheus>#</a></h3><p>参考：
<a href=https://github.com/coreos/kube-prometheus>https://github.com/coreos/kube-prometheus</a></p><h3 id=5kubernetes部署prometheusgrafana>5.Kubernetes部署Prometheus+Grafana
<a class=anchor href=#5kubernetes%e9%83%a8%e7%bd%b2prometheusgrafana>#</a></h3><ul><li>下载相关k8s资源文件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/coreos/kube-prometheus.git
</span></span></code></pre></div><ul><li><p>修改文件kube-prometheus/manifests/prometheus-prometheus.yaml，做这一步的目的是为prometheus的访问分配子路径，访问方式为http(s)://xxx/prometheus</p><p>在prometheus.spec下添加</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>externalUrl</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#f92672>routePrefix</span>: <span style=color:#ae81ff>prometheus</span>
</span></span></code></pre></div><ul><li><p>修改文件kube-prometheus/manifests/grafana-deployment.yaml，做这一步的目的是为grafana的访问分配子路径，访问方式为：http(s)://xxx/grafana</p><p>在deployment.spec.template.spec.container[0]下添加</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GF_SERVER_ROOT_URL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;http://localhost:3000/grafana&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GF_SERVER_SERVE_FROM_SUB_PATH</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><ul><li>Apply k8s资源</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 可能需要运行多次以下命令，确保k8s资源都创建</span>
</span></span><span style=display:flex><span>kubectl create -f manifests/setup -f manifests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># !如果要删除以上创建的k8s资源，运行以下命令</span>
</span></span><span style=display:flex><span>kubectl delete --ignore-not-found<span style=color:#f92672>=</span>true -f manifests/ -f manifests/setup
</span></span></code></pre></div><ul><li>Ingress转发</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apiVersion: extensions/v1beta1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: prometheus
</span></span><span style=display:flex><span>  namespace: monitoring
</span></span><span style=display:flex><span>spec: 
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: dp.example.tech
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - path: /prometheus
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          serviceName: prometheus-k8s
</span></span><span style=display:flex><span>          servicePort: <span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>      - path: /grafana
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          serviceName: grafana
</span></span><span style=display:flex><span>          servicePort: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>      - path: /alertmanager
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          serviceName: alertmanager-main
</span></span><span style=display:flex><span>          servicePort: <span style=color:#ae81ff>9093</span>
</span></span></code></pre></div><ul><li><ul><li></li></ul></li></ul><h2 id=configuring-prometheus>Configuring Prometheus
<a class=anchor href=#configuring-prometheus>#</a></h2><p>​ 配置文件为prometheus.yml，文件格式为yaml。</p><h2 id=concepts>Concepts
<a class=anchor href=#concepts>#</a></h2><h3 id=metrics>Metrics
<a class=anchor href=#metrics>#</a></h3><h2 id=存储>存储
<a class=anchor href=#%e5%ad%98%e5%82%a8>#</a></h2><p>Prometheus 2.x 默认将时间序列数据库保存在本地磁盘中，同时也可以将数据保存到任意第三方的存储服务中。</p><h3 id=本地存储>本地存储
<a class=anchor href=#%e6%9c%ac%e5%9c%b0%e5%ad%98%e5%82%a8>#</a></h3><p>Prometheus 采用自定义的存储格式将样本数据保存在本地磁盘当中。</p><h4 id=存储格式>存储格式
<a class=anchor href=#%e5%ad%98%e5%82%a8%e6%a0%bc%e5%bc%8f>#</a></h4><p>Prometheus 按照两个小时为一个时间窗口，将两小时内产生的数据存储在一个块（Block）中。每个块都是一个单独的目录，里面含该时间窗口内的所有样本数据（chunks），元数据文件（meta.json）以及索引文件（index）。其中索引文件会将指标名称和标签索引到样板数据的时间序列中。此期间如果通过 API 删除时间序列，删除记录会保存在单独的逻辑文件 <code>tombstone</code> 当中。</p><p>当前样本数据所在的块会被直接保存在内存中，不会持久化到磁盘中。为了确保 Prometheus 发生崩溃或重启时能够恢复数据，Prometheus 启动时会通过预写日志（write-ahead-log(WAL)）重新记录，从而恢复数据。预写日志文件保存在 <code>wal</code> 目录中，每个文件大小为 <code>128MB</code>。wal 文件包括还没有被压缩的原始数据，所以比常规的块文件大得多。一般情况下，Prometheus 会保留三个 wal 文件，但如果有些高负载服务器需要保存两个小时以上的原始数据，wal 文件的数量就会大于 3 个。</p><p>Prometheus保存块数据的目录结构如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>rometheus 提供了几个参数来修改本地存储的配置，最主要的有：
</span></span><span style=display:flex><span>启动参数
</span></span><span style=display:flex><span>默认值
</span></span><span style=display:flex><span>含义
</span></span><span style=display:flex><span>--storage.tsdb.path
</span></span><span style=display:flex><span>/data
</span></span><span style=display:flex><span>数据存储路径
</span></span><span style=display:flex><span>--storage.tsdb.retention.time
</span></span><span style=display:flex><span>15d
</span></span><span style=display:flex><span>样本数据在存储中保存的时间。超过该时间限制的数据就会被删除。
</span></span><span style=display:flex><span>--storage.tsdb.retention.size
</span></span><span style=display:flex><span>0
</span></span><span style=display:flex><span>每个块的最大字节数（不包括 wal 文件）。如果超过限制，最早的样本数据会被优先删除。支持的单位有 KB, MB, GB, PB，例如：“512MB”。该参数只是试验性的，可能会在未来的版本中被移除。
</span></span><span style=display:flex><span>--storage.tsdb.retention
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>该参数从 2.7 版本开始已经被弃用，使用 --storage.tsdb.retention.time 参数替代
</span></span><span style=display:flex><span>在一般情况下，Prometheus 中存储的每一个样本大概占用1-2字节大小。如果需要对 Prometheus Server 的本地磁盘空间做容量规划时，可以通过以下公式计算：./data 
</span></span><span style=display:flex><span>   |- 01BKGV7JBM69T2G1BGBGM6KB12 # 块
</span></span><span style=display:flex><span>      |- meta.json  # 元数据
</span></span><span style=display:flex><span>      |- wal        # 写入日志
</span></span><span style=display:flex><span>        |- 000002
</span></span><span style=display:flex><span>        |- 000001
</span></span><span style=display:flex><span>   |- 01BKGTZQ1SYQJTR4PB43C8PD98  # 块
</span></span><span style=display:flex><span>      |- meta.json  #元数据
</span></span><span style=display:flex><span>      |- index   # 索引文件
</span></span><span style=display:flex><span>      |- chunks  # 样本数据
</span></span><span style=display:flex><span>        |- 000001
</span></span><span style=display:flex><span>      |- tombstones # 逻辑数据
</span></span><span style=display:flex><span>   |- 01BKGTZQ1HHWHV8FBJXW1Y3W0K
</span></span><span style=display:flex><span>      |- meta.json
</span></span><span style=display:flex><span>      |- wal
</span></span><span style=display:flex><span>        |-000001
</span></span></code></pre></div><p>最初两个小时的块最终会在后台被压缩成更长的块。</p><blockquote><p><strong>[info] 注意</strong>：</p><p>本地存储不可复制，无法构建集群，如果本地磁盘或节点出现故障，存储将无法扩展和迁移。因此我们只能把本地存储视为近期数据的短暂滑动窗口。如果你对数据持久化的要求不是很严格，可以使用本地磁盘存储多达数年的数据。</p></blockquote><p>关于存储格式的详细信息，请参考
<a href=https://github.com/prometheus/tsdb/blob/master/docs/format/README.md>TSDB 格式</a></p><h4 id=本地存储配置>本地存储配置
<a class=anchor href=#%e6%9c%ac%e5%9c%b0%e5%ad%98%e5%82%a8%e9%85%8d%e7%bd%ae>#</a></h4><p>rometheus 提供了几个参数来修改本地存储的配置，最主要的有：</p><table><thead><tr><th>启动参数</th><th>默认值</th><th>含义</th></tr></thead><tbody><tr><td>&ndash;storage.tsdb.path</td><td>/data</td><td>数据存储路径</td></tr><tr><td>&ndash;storage.tsdb.retention.time</td><td>15d</td><td>样本数据在存储中保存的时间。超过该时间限制的数据就会被删除。</td></tr><tr><td>&ndash;storage.tsdb.retention.size</td><td>0</td><td>每个块的最大字节数（不包括 wal 文件）。如果超过限制，最早的样本数据会被优先删除。支持的单位有 KB, MB, GB, PB，例如：“512MB”。该参数只是试验性的，可能会在未来的版本中被移除。</td></tr><tr><td>&ndash;storage.tsdb.retention</td><td></td><td>该参数从 2.7 版本开始已经被弃用，使用 &ndash;storage.tsdb.retention.time 参数替代</td></tr></tbody></table><p>在一般情况下，Prometheus 中存储的每一个样本大概占用1-2字节大小。如果需要对 Prometheus Server 的本地磁盘空间做容量规划时，可以通过以下公式计算：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample
</span></span></code></pre></div><p>从上面公式中可以看出在保留时间（retention_time_seconds）和样本大小（bytes_per_sample）不变的情况下，如果想减少本地磁盘的容量需求，只能通过减少每秒获取样本数（ingested_samples_per_second）的方式。因此有两种手段，一是减少时间序列的数量，二是增加采集样本的时间间隔。考虑到 Prometheus 会对时间序列进行压缩效率，减少时间序列的数量效果更明显。</p><p>如果你的本地存储出现故障，最好的办法是停止运行 Prometheus 并删除整个存储目录。因为 Prometheus 的本地存储不支持非 POSIX 兼容的文件系统，一旦发生损坏，将无法恢复。NFS 只有部分兼容 POSIX，大部分实现都不兼容 POSIX。</p><p>除了删除整个目录之外，你也可以尝试删除个别块目录来解决问题。删除每个块目录将会丢失大约两个小时时间窗口的样本数据。所以，<strong>Prometheus 的本地存储并不能实现长期的持久化存储。</strong>：</p><p>如果同时指定了样本数据在存储中保存的时间和大小，则哪一个参数的限制先触发，就执行哪个参数的策略。</p><h3 id=远程存储>远程存储
<a class=anchor href=#%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8>#</a></h3><p>Prometheus 的本地存储无法持久化数据，无法灵活扩展。为了保持Prometheus的简单性，Prometheus并没有尝试在自身中解决以上问题，而是通过定义两个标准接口（remote_write/remote_read），让用户可以基于这两个接口对接将数据保存到任意第三方的存储服务中，这种方式在 Promthues 中称为 Remote Storage。</p><p>Prometheus 可以通过两种方式来集成远程存储。</p><h4 id=remote-write>Remote Write
<a class=anchor href=#remote-write>#</a></h4><p>用户可以在 Prometheus 配置文件中指定 Remote Write（远程写）的 URL 地址，一旦设置了该配置项，Prometheus 将采集到的样本数据通过 HTTP 的形式发送给适配器（Adaptor）。而用户则可以在适配器中对接外部任意的服务。外部服务可以是真正的存储系统，公有云的存储服务，也可以是消息队列等任意形式。</p><p><img src=https://fs.poneding.com/images/IA5eOL.jpg alt=img></p><h4 id=remote-read>Remote Read
<a class=anchor href=#remote-read>#</a></h4><p>如下图所示，Promthues 的 Remote Read（远程读）也通过了一个适配器实现。在远程读的流程当中，当用户发起查询请求后，Promthues 将向 remote_read 中配置的 URL 发起查询请求（matchers,ranges），<code>Adaptor</code> 根据请求条件从第三方存储服务中获取响应的数据。同时将数据转换为 Promthues 的原始样本数据返回给 Prometheus Server。</p><p>当获取到样本数据后，Promthues 在本地使用 PromQL 对样本数据进行二次处理。</p><blockquote><p><strong>[info] 注意</strong>：</p><p>启用远程读设置后，Prometheus 仅从远程存储读取一组时序样本数据（根据标签选择器和时间范围），对于规则文件的处理，以及 Metadata API 的处理都只基于 Prometheus 本地存储完成。这也就意味着远程读在扩展性上有一定的限制，因为所有的样本数据都要首先加载到 Prometheus Server，然后再进行处理。所以 Prometheus 暂时不支持完全分布式处理。</p></blockquote><p><img src=https://fs.poneding.com/images/0irUuL.jpg alt=image></p><p>远程读和远程写协议都使用了基于 HTTP 的 snappy 压缩协议的缓冲区编码，目前还不稳定，在以后的版本中可能会被替换成基于 HTTP/2 的 <code>gRPC</code> 协议，前提是 Prometheus 和远程存储之间的所有通信都支持 HTTP/2。</p><h4 id=配置文件>配置文件
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6>#</a></h4><p>想知道如何在 Prometheus 中添加远程存储的配置，请参考前面的章节：
<a href=https://www.yangcs.net/prometheus/3-prometheus/configuration.html#remote_write>配置远程写</a> 和
<a href=https://www.yangcs.net/prometheus/3-prometheus/configuration.html#remote_read>配置远程读</a>。</p><p>关于请求与响应消息的详细信息，可以查看远程存储相关协议的 proto 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> prometheus;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> go_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prompb&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;types.proto&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;gogoproto/gogo.proto&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>WriteRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> prometheus.TimeSeries timeseries <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> [(gogoproto.nullable) <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>];<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>ReadRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> Query queries <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>ReadResponse</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e>// In same order as the request&#39;s queries.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>repeated</span> QueryResult results <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Query</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int64</span> start_timestamp_ms <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int64</span> end_timestamp_ms <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> prometheus.LabelMatcher matchers <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  prometheus.ReadHints hints <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>QueryResult</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e>// Samples within a time series must be ordered by time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>repeated</span> prometheus.TimeSeries timeseries <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h4 id=支持的远程存储>支持的远程存储
<a class=anchor href=#%e6%94%af%e6%8c%81%e7%9a%84%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8>#</a></h4><p>目前 Prometheus 社区也提供了部分对于第三方数据库的 Remote Storage 支持：</p><table><thead><tr><th>存储服务</th><th>支持模式</th></tr></thead><tbody><tr><td><a href=https://github.com/solarwinds/prometheus2appoptics>AppOptics</a></td><td>write</td></tr><tr><td><a href=https://github.com/ChronixDB/chronix.ingester>Chronix</a></td><td>write</td></tr><tr><td><a href=https://github.com/cortexproject/cortex>Cortex</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/crate/crate_adapter>CrateDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/infonova/prometheusbeat>Elasticsearch</a></td><td>write</td></tr><tr><td><a href=https://gnocchi.xyz/prometheus.html>Gnocchi</a></td><td>write</td></tr><tr><td><a href=https://github.com/prometheus/prometheus/tree/master/documentation/examples/remote_storage/remote_storage_adapter>Graphite</a></td><td>write</td></tr><tr><td><a href=https://docs.influxdata.com/influxdb/latest/supported_protocols/prometheus>InfluxDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/circonus-labs/irondb-prometheus-adapter>IRONdb</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/Telefonica/prometheus-kafka-adapter>Kafka</a></td><td>write</td></tr><tr><td><a href=https://m3db.github.io/m3/integrations/prometheus>M3DB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/prometheus/prometheus/tree/master/documentation/examples/remote_storage/remote_storage_adapter>OpenTSDB</a></td><td>write</td></tr><tr><td><a href=https://github.com/timescale/prometheus-postgresql-adapter>PostgreSQL/TimescaleDB</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/signalfx/metricproxy#prometheus>SignalFx</a></td><td>write</td></tr><tr><td><a href=https://github.com/lukemonahan/splunk_modinput_prometheus#prometheus-remote-write>Splunk</a></td><td>write</td></tr><tr><td><a href=https://github.com/bragfoo/TiPrometheus>TiKV</a></td><td>read/write</td></tr><tr><td><a href=https://github.com/VictoriaMetrics/VictoriaMetrics>VictoriaMetrics</a></td><td>write</td></tr><tr><td><a href=https://github.com/wavefrontHQ/prometheus-storage-adapter>Wavefront</a></td><td>write</td></tr></tbody></table><h2 id=联邦集群>联邦集群
<a class=anchor href=#%e8%81%94%e9%82%a6%e9%9b%86%e7%be%a4>#</a></h2><p>联邦使得一个 Prometheus 服务器可以从另一个 Prometheus 服务器提取选定的时序。</p><h3 id=使用场景>使用场景
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h3><p>Prometheus 联邦有不同的使用场景。通常，联邦被用来实现可扩展的 Prometheus 监控设置，或者将相关的指标从一个服务的 Prometheus 拉取到另一个 Prometheus 中。</p><h3 id=分层联邦>分层联邦
<a class=anchor href=#%e5%88%86%e5%b1%82%e8%81%94%e9%82%a6>#</a></h3><p>分层联邦允许 Prometheus 能够扩展到十几个数据中心和上百万的节点。在此场景下，联邦拓扑类似一个树形拓扑结构，上层的 Prometheus 服务器从大量的下层 Prometheus 服务器中收集和汇聚的时序数据。</p><p>例如，一个联邦设置可能由多个数据中心中的 Prometheus 服务器和一套全局 Prometheus 服务器组成。每个数据中心中部署的 Prometheus 服务器负责收集本区域内细粒度的数据（实例级别），全局 Prometheus 服务器从这些下层 Prometheus 服务器中收集和汇聚数据（任务级别），并存储聚合后的数据。这样就提供了一个聚合的全局视角和详细的本地视角。</p><h3 id=跨服务联邦>跨服务联邦
<a class=anchor href=#%e8%b7%a8%e6%9c%8d%e5%8a%a1%e8%81%94%e9%82%a6>#</a></h3><p>在跨服务联邦中，一个服务的 Prometheus 服务器被配置来提取来自其他服务的 Prometheus 服务器的指定的数据，以便在一个 Prometheus 服务器中对两个数据集启用告警和查询。</p><p>例如，一个运行多种服务的集群调度器可以暴露在集群上运行的服务实例的资源使用信息（例如内存和 CPU 使用率）。另一方面，运行在集群上的服务只需要暴露指定应用程序级别的服务指标。通常，这两种指标集分别被不同的 Prometheus 服务器抓取。利用联邦，监控服务级别指标的 Prometheus 服务器也可以从集群中 Prometheus 服务器拉取其特定服务的集群资源使用率指标，以便可以在该 Prometheus 服务器中使用这两组指标集。</p><h3 id=配置联邦>配置联邦
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e8%81%94%e9%82%a6>#</a></h3><p>在 Prometheus 服务器中，<code>/federate</code> 节点允许获取服务中被选中的时间序列集合的值。至少一个 <code>match[]</code> URL 参数必须被指定为要暴露的序列。每个 <code>match[]</code> 变量需要被指定为一个
<a href=https://prometheus.io/docs/prometheus/latest/querying/basics/#instant-vector-selectors>不变的维度选择器</a>像 <code>up</code> 或者 <code>{job="api-server"}</code>。如果有多个 <code>match[]</code> 参数，则所有符合的时序数据的集合都会被选择。</p><p>从一个 Prometheus 服务器联邦指标到另一个 Prometheus 服务器，配置你的目标 Prometheus 服务器从源服务器的 <code>/federate</code> 节点抓取指标数据，同时也使用 <code>honor_lables</code> 抓取选项（不重写源 Prometheus 服务暴露的标签）并且传递需要的 <code>match[]</code> 参数。例如，下面的 <code>scrape_configs</code> 联邦 <code>source-prometheus-{1,2,3}:9090</code> 三台 Prometheus 服务器，上层 Prometheus 抓取并汇总他们暴露的任何带 <code>job="prometheus"</code> 标签的序列或名称以 <code>job:</code> 开头的指标。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;federate&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>15s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>honor_labels</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metrics_path</span>: <span style=color:#e6db74>&#39;/federate&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#39;match[]&#39;</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;{job=&#34;prometheus&#34;}&#39;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;{__name__=~&#34;job:.*&#34;}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;source-prometheus-1:9090&#39;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;source-prometheus-2:9090&#39;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;source-prometheus-3:9090&#39;</span>
</span></span></code></pre></div><h2 id=monitor-app>Monitor App
<a class=anchor href=#monitor-app>#</a></h2><h3 id=mssql>MSSQL
<a class=anchor href=#mssql>#</a></h3><p><a href=https://prometheus.io/docs/instrumenting/exporters/>参考</a></p><ul><li><p>监控Mssql应用</p><p>在一台安装了Docker的服务器上运行mssql-exporter</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export MSSQL_PASS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xxx&#39;</span>
</span></span><span style=display:flex><span>sudo docker run -e SERVER<span style=color:#f92672>=</span>db-dev-ms01.example.com -e USERNAME<span style=color:#f92672>=</span>starlightdba -e PASSWORD<span style=color:#f92672>=</span>$DEV_MSSQL_PASS -e DEBUG<span style=color:#f92672>=</span>app --rm -d -p 4000:4000 --name dev-mssql awaragi/prometheus-mssql-exporter
</span></span></code></pre></div><blockquote><p>注意：Mssql账号需要有管理员权限。</p></blockquote><p>prometheus.yaml新增监控 的配置</p><ul><li>监控Mssql服务器</li></ul><h2 id=solved>solved
<a class=anchor href=#solved>#</a></h2><hr><p><a href=/kubernetes/prometheus-collect-kong-metrics/>« Prometheus-监控Kong完整操作</a></p><p><a href=/kubernetes/pvc-expansion/>» PVC 扩容</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/kubernetes/prometheus.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#prometheus的监控对象>Prometheus的监控对象</a></li><li><a href=#prometheus优势>Prometheus优势</a></li><li><a href=#prometheus组件>Prometheus组件</a></li></ul></li><li><a href=#architecture-overview>Architecture overview</a></li><li><a href=#installation--start-up>Installation & Start Up</a><ul><li><a href=#1-以服务进程运行prometheus>1. 以服务进程运行Prometheus</a></li><li><a href=#2docker启动prometheus>2.Docker启动Prometheus</a></li><li><a href=#3-kubernetes运行prometheus>3. Kubernetes运行Prometheus</a></li><li><a href=#4官方kubernets运行prometheus>4.官方kubernets运行Prometheus</a></li><li><a href=#5kubernetes部署prometheusgrafana>5.Kubernetes部署Prometheus+Grafana</a></li></ul></li><li><a href=#configuring-prometheus>Configuring Prometheus</a></li><li><a href=#concepts>Concepts</a><ul><li><a href=#metrics>Metrics</a></li></ul></li><li><a href=#存储>存储</a><ul><li><a href=#本地存储>本地存储</a></li><li><a href=#远程存储>远程存储</a></li></ul></li><li><a href=#联邦集群>联邦集群</a><ul><li><a href=#使用场景>使用场景</a></li><li><a href=#分层联邦>分层联邦</a></li><li><a href=#跨服务联邦>跨服务联邦</a></li><li><a href=#配置联邦>配置联邦</a></li></ul></li><li><a href=#monitor-app>Monitor App</a><ul><li><a href=#mssql>MSSQL</a></li></ul></li><li><a href=#solved>solved</a></li></ul></nav></div></aside></main></body></html>