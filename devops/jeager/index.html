<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="🏠 首页 / DevOps / Jaeger
Jaeger # 前言 # 微服务之间的调用关系错综复杂，当你在京东下单时，应用背后的服务调用链可能超你想象。调用链的追踪是微服务绕不过去的技术栈，
简介 # 关于 # Jaeger，受Dapper和OpenZipkin启发，由Uber开源的一个分布式跟踪系统，用于基于微服务分布式系统的监控和排错，包括：
分布式上下文传递 分布式事务监控 问题根由分析 服务依赖分析 性能、延迟优化 功能 # 兼容OpenTracing数据模型和工具库 对每个服务、端点使用一致的抽样概率 支持多样的后端数据库：Cassandra，Elasticsearch，Memory 追踪数据拓扑图形展示 基础概念 # Span：
跨度，是跨服务的一次调用。包含名称，开始时间和截止时间，Span之间可以并列，也可以嵌套。
Trace：
是一次完成的分布式调用链，包含多个Span
技术规格 # 后端Go语言实现 前端React/Javascript 支持的数据库：Cassandra3.4+，Elasticsearch5.x+，Kafka&mldr; 组件介绍 # jaeger-client：
jaeger客户端，可以使用多种主流语言实现OpenTracing协议，将调用链数据收集到agent。
jaeger-agent：
jaeger的代理程序，将收集到的client调用链数据上报到collector。
jaeger-collector：
jaeger调用链数据收集器，对收集到的调用链数据进行校验，处理，存储到后端数据库。
jaeger-query：
jaeger调用链数据查询服务，有独立UI。
OpenTracing # 分布式的追踪系统其实不止Jaeger一种，但是它们的核心原理都大相径庭，都是从入侵到代码中埋点，然后像追踪系统上报数据信息，最终我们在追踪系统得到数据，从而实现追踪分析。
为了兼容统一各追踪系统API，OpenTracing规范诞生了，它与平台无关，与厂商无关。有了它的存在，你可以方便的切换你想使用的追踪系统。
安装 # Docker # docker run -d --name jaeger \ -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \ -p 5775:5775/udp \ -p 6831:6831/udp \ -p 6832:6832/udp \ -p 5778:5778 \ -p 16686:16686 \ -p 14268:14268 \ -p 14250:14250 \ -p 9411:9411 \ jaegertracing/all-in-one:1."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/devops/jeager/"><meta property="og:site_name" content="秋河落叶"><meta property="og:title" content="秋河落叶"><meta property="og:description" content="🏠 首页 / DevOps / Jaeger
Jaeger # 前言 # 微服务之间的调用关系错综复杂，当你在京东下单时，应用背后的服务调用链可能超你想象。调用链的追踪是微服务绕不过去的技术栈，
简介 # 关于 # Jaeger，受Dapper和OpenZipkin启发，由Uber开源的一个分布式跟踪系统，用于基于微服务分布式系统的监控和排错，包括：
分布式上下文传递 分布式事务监控 问题根由分析 服务依赖分析 性能、延迟优化 功能 # 兼容OpenTracing数据模型和工具库 对每个服务、端点使用一致的抽样概率 支持多样的后端数据库：Cassandra，Elasticsearch，Memory 追踪数据拓扑图形展示 基础概念 # Span：
跨度，是跨服务的一次调用。包含名称，开始时间和截止时间，Span之间可以并列，也可以嵌套。
Trace：
是一次完成的分布式调用链，包含多个Span
技术规格 # 后端Go语言实现 前端React/Javascript 支持的数据库：Cassandra3.4+，Elasticsearch5.x+，Kafka… 组件介绍 # jaeger-client：
jaeger客户端，可以使用多种主流语言实现OpenTracing协议，将调用链数据收集到agent。
jaeger-agent：
jaeger的代理程序，将收集到的client调用链数据上报到collector。
jaeger-collector：
jaeger调用链数据收集器，对收集到的调用链数据进行校验，处理，存储到后端数据库。
jaeger-query：
jaeger调用链数据查询服务，有独立UI。
OpenTracing # 分布式的追踪系统其实不止Jaeger一种，但是它们的核心原理都大相径庭，都是从入侵到代码中埋点，然后像追踪系统上报数据信息，最终我们在追踪系统得到数据，从而实现追踪分析。
为了兼容统一各追踪系统API，OpenTracing规范诞生了，它与平台无关，与厂商无关。有了它的存在，你可以方便的切换你想使用的追踪系统。
安装 # Docker # docker run -d --name jaeger \ -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \ -p 5775:5775/udp \ -p 6831:6831/udp \ -p 6832:6832/udp \ -p 5778:5778 \ -p 16686:16686 \ -p 14268:14268 \ -p 14250:14250 \ -p 9411:9411 \ jaegertracing/all-in-one:1."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="devops"><meta property="article:modified_time" content="2024-06-13T15:37:18+08:00"><title>Jeager | 秋河落叶</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/devops/jeager/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.05ffbe93c512990e701a7d5032cfd5143357cbf6803139653a08b719da6afe9c.js integrity="sha256-Bf++k8USmQ5wGn1QMs/VFDNXy/aAMTllOgi3Gdpq/pw=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script><link rel=stylesheet href=/css/syntax.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>秋河落叶</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><p>🦉 集中起来的意志可以击穿顽石。</p><hr><ul><li><p><a href=/><strong>🏠 首页</strong></a></p></li><li><p><strong>📌 置顶文章</strong></p><ul><li><a href=/git/common-usage/>Git 常用</a></li><li><a href=/kubernetes/kubeadm-install-k8s-docker/>安装 Kubernetes (Docker)</a></li></ul></li><li><p><strong>📌 置顶分类</strong></p><ul><li><a href=/go/>Golang 编程</a></li><li><a href=/kubernetes/>Kubernetes</a></li><li><a href=/rust/>Rust 编程</a></li><li><a href=/git/>Git</a></li></ul></li></ul><hr><ul><li><strong>🗃️ 开源项目</strong><ul><li><a href=https://github.com/ketches/registry-proxy>registry-proxy</a></li><li><a href=https://github.com/poneding/mdi>mdi</a></li></ul></li></ul><hr><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>🐙 GitHub</a></li><li><a href=mailto:poneding@gmail.com target=_blank rel=noopener>📬 邮箱</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Jeager</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#简介>简介</a><ul><li><a href=#关于>关于</a></li><li><a href=#功能>功能</a></li></ul></li><li><a href=#基础概念>基础概念</a><ul><li><a href=#技术规格>技术规格</a></li><li><a href=#组件介绍>组件介绍</a></li></ul></li><li><a href=#opentracing>OpenTracing</a></li><li><a href=#安装>安装</a><ul><li><a href=#docker>Docker</a></li><li><a href=#kubernetes>Kubernetes</a></li></ul></li><li><a href=#示例>示例</a></li><li><a href=#使用>使用</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>🏠 首页</a> /
<a href=/devops/>DevOps</a> / Jaeger</p><h1 id=jaeger>Jaeger
<a class=anchor href=#jaeger>#</a></h1><p><img src=https://fs.poneding.com/images/jaeger-logo.a7093b12.svg alt=presentation></p><h2 id=前言>前言
<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h2><p>微服务之间的调用关系错综复杂，当你在京东下单时，应用背后的服务调用链可能超你想象。调用链的追踪是微服务绕不过去的技术栈，</p><h2 id=简介>简介
<a class=anchor href=#%e7%ae%80%e4%bb%8b>#</a></h2><h3 id=关于>关于
<a class=anchor href=#%e5%85%b3%e4%ba%8e>#</a></h3><p>Jaeger，受Dapper和OpenZipkin启发，由Uber开源的一个分布式跟踪系统，用于基于微服务分布式系统的监控和排错，包括：</p><ul><li>分布式上下文传递</li><li>分布式事务监控</li><li>问题根由分析</li><li>服务依赖分析</li><li>性能、延迟优化</li></ul><h3 id=功能>功能
<a class=anchor href=#%e5%8a%9f%e8%83%bd>#</a></h3><ul><li>兼容OpenTracing数据模型和工具库</li><li>对每个服务、端点使用一致的抽样概率</li><li>支持多样的后端数据库：Cassandra，Elasticsearch，Memory</li><li>追踪数据拓扑图形展示</li></ul><h2 id=基础概念>基础概念
<a class=anchor href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5>#</a></h2><p><img src=https://fs.poneding.com/images/spans-traces.png alt="Traces And Spans"></p><ul><li><p><strong>Span</strong>：</p><p>跨度，是跨服务的一次调用。包含名称，开始时间和截止时间，Span之间可以并列，也可以嵌套。</p></li><li><p><strong>Trace</strong>：</p><p>是一次完成的分布式调用链，包含多个Span</p></li></ul><h3 id=技术规格>技术规格
<a class=anchor href=#%e6%8a%80%e6%9c%af%e8%a7%84%e6%a0%bc>#</a></h3><ul><li>后端Go语言实现</li><li>前端React/Javascript</li><li>支持的数据库：Cassandra3.4+，Elasticsearch5.x+，Kafka&mldr;</li></ul><h3 id=组件介绍>组件介绍
<a class=anchor href=#%e7%bb%84%e4%bb%b6%e4%bb%8b%e7%bb%8d>#</a></h3><p><img src=https://fs.poneding.com/images/architecture-v1.png alt=Architecture></p><ul><li><p><strong>jaeger-client</strong>：</p><p>jaeger客户端，可以使用多种主流语言实现OpenTracing协议，将调用链数据收集到agent。</p></li><li><p><strong>jaeger-agent</strong>：</p><p>jaeger的代理程序，将收集到的client调用链数据上报到collector。</p></li><li><p><strong>jaeger-collector</strong>：</p><p>jaeger调用链数据收集器，对收集到的调用链数据进行校验，处理，存储到后端数据库。</p></li><li><p><strong>jaeger-query</strong>：</p><p>jaeger调用链数据查询服务，有独立UI。</p></li></ul><h2 id=opentracing>OpenTracing
<a class=anchor href=#opentracing>#</a></h2><p>分布式的追踪系统其实不止Jaeger一种，但是它们的核心原理都大相径庭，都是从入侵到代码中埋点，然后像追踪系统上报数据信息，最终我们在追踪系统得到数据，从而实现追踪分析。</p><p>为了兼容统一各追踪系统API，OpenTracing规范诞生了，它与平台无关，与厂商无关。有了它的存在，你可以方便的切换你想使用的追踪系统。</p><h2 id=安装>安装
<a class=anchor href=#%e5%ae%89%e8%a3%85>#</a></h2><h3 id=docker>Docker
<a class=anchor href=#docker>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d --name jaeger <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -e <span class=nv>COLLECTOR_ZIPKIN_HTTP_PORT</span><span class=o>=</span><span class=m>9411</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 5775:5775/udp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 6831:6831/udp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 6832:6832/udp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 5778:5778 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 16686:16686 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 14268:14268 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 14250:14250 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p 9411:9411 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  jaegertracing/all-in-one:1.20
</span></span></code></pre></div><h3 id=kubernetes>Kubernetes
<a class=anchor href=#kubernetes>#</a></h3><p><strong>开发环境</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml
</span></span></code></pre></div><blockquote><p>可能需要将文件下载下来，修改Deployment版本。</p></blockquote><p><strong>生产环境</strong>：</p><blockquote><p>├── install-jaeger.sh
├── jaeger-agent.yaml
├── jaeger-cassandra.yaml
├── jaeger-collector.yaml
├── jaeger-configmap.yaml
├── jaeger-persistent.yaml
├── jaeger-query.yaml
└── uninstall-jaeger.sh</p></blockquote><h2 id=示例>示例
<a class=anchor href=#%e7%a4%ba%e4%be%8b>#</a></h2><p><strong>DotNet Demo</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet add package Jaeger --version 0.4.2
</span></span><span class=line><span class=cl>dotnet add package OpenTracing.Contrib.NetCore --version 0.6.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>ConfigureServices</span><span class=p>(</span><span class=n>IServiceCollection</span> <span class=n>services</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddOpenTracing</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>httpOption</span> <span class=p>=</span> <span class=k>new</span> <span class=n>HttpHandlerDiagnosticOptions</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>httpOption</span><span class=p>.</span><span class=n>IgnorePatterns</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>req</span> <span class=p>=&gt;</span> <span class=n>req</span><span class=p>.</span><span class=n>RequestUri</span><span class=p>.</span><span class=n>AbsolutePath</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;/api/traces&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>(</span><span class=n>Options</span><span class=p>.</span><span class=n>Create</span><span class=p>(</span><span class=n>httpOption</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>&lt;</span><span class=n>ITracer</span><span class=p>&gt;(</span><span class=n>serviceProvider</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>serviceName</span> <span class=p>=</span> <span class=n>serviceProvider</span><span class=p>.</span><span class=n>GetRequiredService</span><span class=p>&lt;</span><span class=n>IWebHostEnvironment</span><span class=p>&gt;().</span><span class=n>ApplicationName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ILoggerFactory</span> <span class=n>loggerFactory</span> <span class=p>=</span> <span class=n>serviceProvider</span><span class=p>.</span><span class=n>GetRequiredService</span><span class=p>&lt;</span><span class=n>ILoggerFactory</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>Configuration</span><span class=p>.</span><span class=n>SenderConfiguration</span> <span class=n>senderConfiguration</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Configuration</span><span class=p>.</span><span class=n>SenderConfiguration</span><span class=p>(</span><span class=n>loggerFactory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>WithSender</span><span class=p>(</span><span class=k>new</span> <span class=n>UdpSender</span><span class=p>(</span><span class=s>&#34;jaeger-agent&#34;</span><span class=p>,</span> <span class=m>6831</span><span class=p>,</span> <span class=m>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>tracer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Tracer</span><span class=p>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>WithSampler</span><span class=p>(</span><span class=k>new</span> <span class=n>ConstSampler</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>WithReporter</span><span class=p>(</span><span class=k>new</span> <span class=n>RemoteReporter</span><span class=p>.</span><span class=n>Builder</span><span class=p>().</span><span class=n>WithSender</span><span class=p>(</span><span class=n>senderConfiguration</span><span class=p>.</span><span class=n>GetSender</span><span class=p>()).</span><span class=n>Build</span><span class=p>())</span>
</span></span><span class=line><span class=cl>             <span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>GlobalTracer</span><span class=p>.</span><span class=n>Register</span><span class=p>(</span><span class=n>tracer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tracer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Golang Demo</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get github.com/uber/jaeger-client-go
</span></span><span class=line><span class=cl>go get github.com/opentracing/opentracing-go
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>closer</span> <span class=o>:=</span> <span class=nf>initJaegerTracer</span><span class=p>(</span><span class=s>&#34;jaeger-api-go&#34;</span><span class=p>,</span> <span class=s>&#34;jaeger-agent.example.dev:6831&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>closer</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>InitGlobalTracer</span><span class=p>(</span><span class=nx>tracer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/api/values&#34;</span><span class=p>,</span> <span class=nf>TraceHandler</span><span class=p>(</span><span class=nx>valuesHandler</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8082&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>initJaegerTracer</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>,</span> <span class=nx>jaegerAgentAddr</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>opentracing</span><span class=p>.</span><span class=nx>Tracer</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Closer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>cfg</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sampler</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>config</span><span class=p>.</span><span class=nx>SamplerConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>Type</span><span class=p>:</span>  <span class=nx>jaeger</span><span class=p>.</span><span class=nx>SamplerTypeConst</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>Param</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Reporter</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>config</span><span class=p>.</span><span class=nx>ReporterConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>LogSpans</span><span class=p>:</span>           <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>LocalAgentHostPort</span><span class=p>:</span> <span class=nx>jaegerAgentAddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>closer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nf>Logger</span><span class=p>(</span><span class=nx>jaeger</span><span class=p>.</span><span class=nx>StdLogger</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ERROR: Could not initialize jaeger tracer: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>closer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>valuesHandler</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;hello from jaeger-go.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TraceHandler</span><span class=p>(</span><span class=nx>handler</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>))</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>spanName</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl>  <span class=nx>spanCtx</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>GlobalTracer</span><span class=p>().</span><span class=nf>Extract</span><span class=p>(</span><span class=nx>opentracing</span><span class=p>.</span><span class=nx>HTTPHeaders</span><span class=p>,</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>HTTPHeadersCarrier</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>span</span> <span class=o>:=</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>GlobalTracer</span><span class=p>().</span><span class=nf>StartSpan</span><span class=p>(</span><span class=nx>spanName</span><span class=p>,</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>ChildOf</span><span class=p>(</span><span class=nx>spanCtx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>span</span><span class=p>.</span><span class=nf>SetTag</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>ext</span><span class=p>.</span><span class=nx>Component</span><span class=p>),</span> <span class=nx>spanName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>span</span><span class=p>.</span><span class=nf>Finish</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nf>handler</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jaeger_tracer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/opentracing/opentracing-go/ext&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/opentracing/opentracing-go&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/uber/jaeger-client-go&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/uber/jaeger-client-go/config&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TraceHandler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>OriginalHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>handler</span> <span class=nx>TraceHandler</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//spanName := runtime.FuncForPC(reflect.ValueOf(handler.OriginalHandler).Pointer()).Name()
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>spanName</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl> <span class=nx>spanCtx</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>GlobalTracer</span><span class=p>().</span><span class=nf>Extract</span><span class=p>(</span><span class=nx>opentracing</span><span class=p>.</span><span class=nx>HTTPHeaders</span><span class=p>,</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>HTTPHeadersCarrier</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=nx>span</span> <span class=o>:=</span> <span class=nx>opentracing</span><span class=p>.</span><span class=nf>GlobalTracer</span><span class=p>().</span><span class=nf>StartSpan</span><span class=p>(</span><span class=nx>spanName</span><span class=p>,</span><span class=nx>opentracing</span><span class=p>.</span><span class=nf>ChildOf</span><span class=p>(</span><span class=nx>spanCtx</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=nx>span</span><span class=p>.</span><span class=nf>SetTag</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>ext</span><span class=p>.</span><span class=nx>Component</span><span class=p>),</span> <span class=nx>spanName</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>span</span><span class=p>.</span><span class=nf>Finish</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>handler</span><span class=p>.</span><span class=nx>OriginalHandler</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>InitJaegerTracer</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>,</span> <span class=nx>jaegerAgentAddr</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>opentracing</span><span class=p>.</span><span class=nx>Tracer</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Closer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>cfg</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ServiceName</span><span class=p>:</span> <span class=nx>serviceName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sampler</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>config</span><span class=p>.</span><span class=nx>SamplerConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>Type</span><span class=p>:</span>  <span class=nx>jaeger</span><span class=p>.</span><span class=nx>SamplerTypeConst</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>Param</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Reporter</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>config</span><span class=p>.</span><span class=nx>ReporterConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>LogSpans</span><span class=p>:</span>           <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>LocalAgentHostPort</span><span class=p>:</span> <span class=nx>jaegerAgentAddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>closer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>NewTracer</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nf>Logger</span><span class=p>(</span><span class=nx>jaeger</span><span class=p>.</span><span class=nx>StdLogger</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ERROR: Could not initialize jaeger tracer: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>closer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TracerHandler</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>jaeger_tracer</span><span class=p>.</span><span class=nx>TraceHandler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>OriginalHandler</span><span class=p>:</span> <span class=nx>handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h2><hr><p><a href=/devops/grafana/>« Grafana</a></p><p><a href=/devops/nginx/>» nginx</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/5faa4f1be5d4525c49e513962394eae7c15fb6f2 title='最后修改者 poneding | 2024/06/13' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/13</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/devops/jeager.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#简介>简介</a><ul><li><a href=#关于>关于</a></li><li><a href=#功能>功能</a></li></ul></li><li><a href=#基础概念>基础概念</a><ul><li><a href=#技术规格>技术规格</a></li><li><a href=#组件介绍>组件介绍</a></li></ul></li><li><a href=#opentracing>OpenTracing</a></li><li><a href=#安装>安装</a><ul><li><a href=#docker>Docker</a></li><li><a href=#kubernetes>Kubernetes</a></li></ul></li><li><a href=#示例>示例</a></li><li><a href=#使用>使用</a></li></ul></nav></div></aside></main></body></html>