<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我的博客 / Kubernetes / 使用 nfs 持久化存储
使用 nfs 持久化存储 # 一般云平台都会提供云存储服务，如 AWS EBS 服务，K8s 可以直接使用云存储服务创建 PV 和 PVC 作为 Volume 的存储后端。假设你没有使用到云存储，那么 NFS 可能会适合你。
NFS（Network File System），网络文件系统，允许计算机之间共享存储资源，这里也就不具体介绍了。
部署 nfs # 以下命令需要root权限，示例中机器IP为192.168.115.137。
安装 nfs： # Ubuntu & Debian apt install nfs-kernel-server -y # CentOS yum install nfs-util -y 创建共享目录： mkdir /nfs/data -p 修改 nfs 的默认配置，在文末添加配置： vim /etc/exports /nfs/data *(rw,sync,no_root_squash) 其中：
/nfs/data：共享目录 *：对所有开放访问，可以配置成网段，IP，域名等 rw：读写权限 sync：文件同时写入磁盘和内存 no_root_squash：当登录 NFS 主机使用共享目录的使用者是 root 时，其权限将被转换成为匿名使用者，通常它的 UID 与 GID，都会变成 nobody 身份 重启 rpc，nfs 需要向 rpc 注册： systemctl restart rpcbind."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/kubernetes/nfs-as-pvc/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content="我的博客 / Kubernetes / 使用 nfs 持久化存储
使用 nfs 持久化存储 # 一般云平台都会提供云存储服务，如 AWS EBS 服务，K8s 可以直接使用云存储服务创建 PV 和 PVC 作为 Volume 的存储后端。假设你没有使用到云存储，那么 NFS 可能会适合你。
NFS（Network File System），网络文件系统，允许计算机之间共享存储资源，这里也就不具体介绍了。
部署 nfs # 以下命令需要root权限，示例中机器IP为192.168.115.137。
安装 nfs： # Ubuntu & Debian apt install nfs-kernel-server -y # CentOS yum install nfs-util -y 创建共享目录： mkdir /nfs/data -p 修改 nfs 的默认配置，在文末添加配置： vim /etc/exports /nfs/data *(rw,sync,no_root_squash) 其中：
/nfs/data：共享目录 *：对所有开放访问，可以配置成网段，IP，域名等 rw：读写权限 sync：文件同时写入磁盘和内存 no_root_squash：当登录 NFS 主机使用共享目录的使用者是 root 时，其权限将被转换成为匿名使用者，通常它的 UID 与 GID，都会变成 nobody 身份 重启 rpc，nfs 需要向 rpc 注册： systemctl restart rpcbind."><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="kubernetes"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Nfs as Pvc | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/kubernetes/nfs-as-pvc/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.9a4e139e0d8feaf510bf71d73a0aec5d39827736ac52bd00d9005a09fd84a9fc.js integrity="sha256-mk4Tng2P6vUQv3HXOgrsXTmCdzasUr0A2QBaCf2Eqfw=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Nfs as Pvc</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#部署-nfs>部署 nfs</a></li><li><a href=#创建-pv>创建 PV</a><ul><li><a href=#accessmodes-访问模式>AccessModes 访问模式</a></li><li><a href=#persistentvolumereclaimpolicy-回收策略>PersistentVolumeReclaimPolicy 回收策略</a></li><li><a href=#status>Status</a></li></ul></li><li><a href=#创建-pvc>创建 PVC</a></li><li><a href=#volume-使用-pvc>Volume 使用 PVC</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/kubernetes/>Kubernetes</a> / 使用 nfs 持久化存储</p><h1 id=使用-nfs-持久化存储>使用 nfs 持久化存储
<a class=anchor href=#%e4%bd%bf%e7%94%a8-nfs-%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8>#</a></h1><p>一般云平台都会提供云存储服务，如 AWS EBS 服务，K8s 可以直接使用云存储服务创建 PV 和 PVC 作为 Volume 的存储后端。假设你没有使用到云存储，那么 NFS 可能会适合你。</p><p>NFS（Network File System），网络文件系统，允许计算机之间共享存储资源，这里也就不具体介绍了。</p><h2 id=部署-nfs>部署 nfs
<a class=anchor href=#%e9%83%a8%e7%bd%b2-nfs>#</a></h2><p>以下命令需要root权限，示例中机器IP为<code>192.168.115.137</code>。</p><ol><li><strong>安装 nfs</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Ubuntu &amp; Debian</span>
</span></span><span style=display:flex><span>apt install nfs-kernel-server -y
</span></span><span style=display:flex><span><span style=color:#75715e># CentOS</span>
</span></span><span style=display:flex><span>yum install nfs-util -y
</span></span></code></pre></div><ol start=2><li><strong>创建共享目录</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir /nfs/data -p
</span></span></code></pre></div><ol start=3><li><strong>修改 nfs 的默认配置，在文末添加配置</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vim /etc/exports
</span></span><span style=display:flex><span>/nfs/data  *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>其中：</p><ul><li>/nfs/data：共享目录</li><li>*：对所有开放访问，可以配置成网段，IP，域名等</li><li>rw：读写权限</li><li>sync：文件同时写入磁盘和内存</li><li>no_root_squash：当登录 NFS 主机使用共享目录的使用者是 root 时，其权限将被转换成为匿名使用者，通常它的 UID 与 GID，都会变成 nobody 身份</li></ul><ol start=4><li><strong>重启 rpc，nfs 需要向 rpc 注册</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart rpcbind.service
</span></span><span style=display:flex><span>systemctl enable rpcbind.service
</span></span></code></pre></div><ol start=5><li><strong>重启 nfs 服务</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart nfs-kernel-server.service
</span></span><span style=display:flex><span>systemctl enable nfs-kernel-server.service
</span></span></code></pre></div><ol start=6><li><strong>挂载共享，在 fstab 文件中添加配置</strong>：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vim /etc/fstab
</span></span><span style=display:flex><span>192.168.115.137:/nfs/data /nfs/data               nfs    rw,tcp,soft  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=创建-pv>创建 PV
<a class=anchor href=#%e5%88%9b%e5%bb%ba-pv>#</a></h2><p>PersistentVolume 作为 K8s 的存储资源，我们需要为它定义 apacity（存储能力），accessModes（访问模式）persistentVolumeReclaimPolicy（回收策略），存储媒介等信息。</p><p>下面定义了一个 pv 资源，文件名为 pv1.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>1Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolumeReclaimPolicy</span>: <span style=color:#ae81ff>Recycle</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nfs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/nfs/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.115.137</span>
</span></span></code></pre></div><p>需要对 AccessModes 和 PersistentVolumeReclaimPolicy 做简单的枚举介绍：</p><h3 id=accessmodes-访问模式>AccessModes 访问模式
<a class=anchor href=#accessmodes-%e8%ae%bf%e9%97%ae%e6%a8%a1%e5%bc%8f>#</a></h3><p>设置对 PV 存储资源的访问权限：</p><ul><li><p>ReadWriteOnce（RWO）：读写权限，只能被单个实例挂载</p></li><li><p>ReadOnlyMany（ROX）：只读权限，可以被多个实例挂载</p></li><li><p>ReadWriteMany（RWX）：读写权限，可以被多个实例挂载</p></li></ul><h3 id=persistentvolumereclaimpolicy-回收策略>PersistentVolumeReclaimPolicy 回收策略
<a class=anchor href=#persistentvolumereclaimpolicy-%e5%9b%9e%e6%94%b6%e7%ad%96%e7%95%a5>#</a></h3><p>当挂载实例被删除时，设置对 PV 存储资源的回收策略：</p><ul><li>Retain：保留</li><li>Recycle：清除</li><li>Delete：删除，一般用于云存储服务删除对应的资源，如 AWS 的 EBS</li></ul><p>现在创建 pv:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f pv1.yaml
</span></span></code></pre></div><p>查看 pv，可以看到当前 pv1 的 STATUS 为 Available:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pv
</span></span><span style=display:flex><span>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
</span></span><span style=display:flex><span>pv1    1Gi        RWO            Recycle          Available                                   48s
</span></span></code></pre></div><p>这里也需要对 PV 的状态作下简单介绍：</p><h3 id=status>Status
<a class=anchor href=#status>#</a></h3><p>PV 的生命周期包含了四个阶段：</p><ul><li><p>Avaliable：当前未绑定 PVC，处于可用状态</p></li><li><p>Bound：已经被 PVC 绑定，不可用</p></li><li><p>Released：之前被 PVC 绑定，PVC 删除时，PV 会被重新声明，很短暂的一段时间内处于 Released 状态</p></li><li><p>Failed：PV 自动回收失败</p></li></ul><h2 id=创建-pvc>创建 PVC
<a class=anchor href=#%e5%88%9b%e5%bb%ba-pvc>#</a></h2><p>下面定义了一个 pvc 资源，文件名为 pvc1.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pvc1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>1Gi  </span>
</span></span></code></pre></div><p>现在创建 pvc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f pvc1.yaml
</span></span></code></pre></div><p>查看 PVC，可以看到 pvc1 已经处于 Bound 的状态，说明它已经绑定上了一个 PV，而我们目前只创建了一个名为 pv1 的 PV</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span style=display:flex><span>pvc1   Bound    pv1      1Gi        RWO                           3s
</span></span></code></pre></div><p>再次查看 PV，看看是不是被 pvc1 绑定了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM          STORAGECLASS   REASON   AGE
</span></span><span style=display:flex><span>pv1    1Gi        RWO            Recycle          Bound    default/pvc1                           2m
</span></span></code></pre></div><p>确实如我们所想，pv1 被 pvc1 绑定，并且 pv1 的状态也更新成了 Bound。其实这是集群自动为我们的 PVC 寻找到的符合条件的 PV：</p><ul><li>当前状态处于 Avaliable 的 PV</li><li>PV 容量 >= PVC 申请容量</li><li>pvc 和 pv 的 AccessMode 需要一致</li></ul><p>当然，我们也可以通过标签选择器为 PVC 指定绑定的 PV。</p><p>定义 PV：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pv1</span>
</span></span><span style=display:flex><span>...<span style=color:#ae81ff>.</span>
</span></span></code></pre></div><p>定义 PVC：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pv1</span>
</span></span><span style=display:flex><span>...      
</span></span></code></pre></div><h2 id=volume-使用-pvc>Volume 使用 PVC
<a class=anchor href=#volume-%e4%bd%bf%e7%94%a8-pvc>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>www</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>pvc1</span>
</span></span><span style=display:flex><span>...          
</span></span></code></pre></div><hr><p><a href=/kubernetes/metallb/>« Kubernetes 0-1 K8s自建LoadBalancer</a></p><p><a href=/kubernetes/pod-understood/>» Kubernetes 0-1 了解 Pod</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/kubernetes/nfs-as-pvc.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#部署-nfs>部署 nfs</a></li><li><a href=#创建-pv>创建 PV</a><ul><li><a href=#accessmodes-访问模式>AccessModes 访问模式</a></li><li><a href=#persistentvolumereclaimpolicy-回收策略>PersistentVolumeReclaimPolicy 回收策略</a></li><li><a href=#status>Status</a></li></ul></li><li><a href=#创建-pvc>创建 PVC</a></li><li><a href=#volume-使用-pvc>Volume 使用 PVC</a></li></ul></nav></div></aside></main></body></html>