<!doctype html><html lang=cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我的博客 / Golang 编程 / Golang
Golang # 资料 # Go 安全指南 Go 语言编程规范 Golang channel # golang 实现并发是通过通信共享内存，channel 是 go 语言中goroutine 的通信管道，通过 channel 将值从一个 goroutine 发送到另一个 goroutine。
语法 # 创建 channel：
使用 make() 函数创建：
ch := make(chan int) 默认创建一个无缓存 channel。
发送数据到 channel：
ch <- x 从 channel 读取数据：
x := <-ch 关闭 channel：
使用 close() 函数关闭：
close(ch) 当你的程序不再需要往 channel 中发送数据时，可以关闭 channel。
如果往已经关闭的 channal 发送数据，程序发生异常。
无缓冲 channel # 如果当前没有一个 goroutine 对无缓冲 channel 接收数据，那么无缓冲 channel 会阻止发送数据。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.poneding.com/go/go/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="我的博客"><meta property="og:description" content="我的博客 / Golang 编程 / Golang
Golang # 资料 # Go 安全指南 Go 语言编程规范 Golang channel # golang 实现并发是通过通信共享内存，channel 是 go 语言中goroutine 的通信管道，通过 channel 将值从一个 goroutine 发送到另一个 goroutine。
语法 # 创建 channel：
使用 make() 函数创建：
ch := make(chan int) 默认创建一个无缓存 channel。
发送数据到 channel：
ch <- x 从 channel 读取数据：
x := <-ch 关闭 channel：
使用 close() 函数关闭：
close(ch) 当你的程序不再需要往 channel 中发送数据时，可以关闭 channel。
如果往已经关闭的 channal 发送数据，程序发生异常。
无缓冲 channel # 如果当前没有一个 goroutine 对无缓冲 channel 接收数据，那么无缓冲 channel 会阻止发送数据。"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="go"><meta property="article:modified_time" content="2024-06-12T20:56:33+08:00"><title>Go | 我的博客</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/logo.png><link rel=canonical href=https://blog.poneding.com/go/go/><link rel=stylesheet href=/book.min.4964903a822a7acb10dac6d1ab524833c97fb5f99b141976bcb8a47d539be9c0.css integrity="sha256-SWSQOoIqessQ2sbRq1JIM8l/tfmbFBl2vLikfVOb6cA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/cn.search.min.ffd7553d42e9860dbcfbc6775c0f6c9895736a50f5383929cc725dc0a9b61715.js integrity="sha256-/9dVPULphg28+8Z3XA9smJVzalD1ODkpzHJdwKm2FxU=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>我的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://github.com/poneding target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Go</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#资料>资料</a></li><li><a href=#golang-channel>Golang channel</a><ul><li><a href=#语法>语法</a></li><li><a href=#无缓冲-channel>无缓冲 channel</a></li><li><a href=#有缓冲-channel>有缓冲 channel</a></li><li><a href=#无缓冲-channel-与有缓冲-channel的区别>无缓冲 channel 与有缓冲 channel的区别</a></li></ul></li><li><a href=#读取文件>读取文件</a><ul><li><a href=#一次性全读>一次性全读</a></li><li><a href=#按行读取>按行读取</a></li></ul></li><li><a href=#优雅退出>优雅退出</a><ul><li><a href=#不处理优雅退出>不处理优雅退出</a></li><li><a href=#优雅退出-1with-context>优雅退出 1（with context）</a></li><li><a href=#优雅退出-2without-context>优雅退出 2（without context）</a></li></ul></li><li><a href=#函数式选项模式>函数式选项模式</a></li><li><a href=#调用-api>调用 API</a><ul><li><a href=#get>Get</a></li><li><a href=#post>Post</a></li></ul></li><li><a href=#调用-jenkins-api>调用 Jenkins API</a></li><li><a href=#位运算>位运算</a></li><li><a href=#实现简易网络连接客户端>实现简易网络连接客户端</a></li><li><a href=#git>git</a></li><li><a href=#elasticsearch>elasticsearch</a></li></ul></nav></aside></header><article class="markdown book-article"><p><a href=/>我的博客</a> /
<a href=/go/>Golang 编程</a> / Golang</p><h1 id=golang>Golang
<a class=anchor href=#golang>#</a></h1><h2 id=资料>资料
<a class=anchor href=#%e8%b5%84%e6%96%99>#</a></h2><ul><li><a href=https://github.com/Tencent/secguide/blob/main/Go%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97.md>Go 安全指南</a></li><li><a href=https://github.com/xxjwxc/uber_go_guide_cn>Go 语言编程规范</a></li></ul><h2 id=golang-channel>Golang channel
<a class=anchor href=#golang-channel>#</a></h2><p>golang 实现并发是通过通信共享内存，channel 是 go 语言中goroutine 的通信管道，通过 channel 将值从一个 goroutine 发送到另一个 goroutine。</p><h3 id=语法>语法
<a class=anchor href=#%e8%af%ad%e6%b3%95>#</a></h3><p><strong>创建 channel</strong>：</p><p>使用 <code>make()</code> 函数创建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span></code></pre></div><blockquote><p>默认创建一个无缓存 channel。</p></blockquote><p><strong>发送数据到 channel</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>x</span>
</span></span></code></pre></div><p><strong>从 channel 读取数据</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>x</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span>
</span></span></code></pre></div><p><strong>关闭 channel</strong>：</p><p>使用 <code>close()</code> 函数关闭：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>close</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
</span></span></code></pre></div><blockquote><p>当你的程序不再需要往 channel 中发送数据时，可以关闭 channel。</p><p>如果往已经关闭的 channal 发送数据，程序发生异常。</p></blockquote><h3 id=无缓冲-channel>无缓冲 channel
<a class=anchor href=#%e6%97%a0%e7%bc%93%e5%86%b2-channel>#</a></h3><p>如果当前没有一个 goroutine 对无缓冲 channel 接收数据，那么无缓冲 channel 会阻止发送数据。</p><h3 id=有缓冲-channel>有缓冲 channel
<a class=anchor href=#%e6%9c%89%e7%bc%93%e5%86%b2-channel>#</a></h3><p>类似队列机制，创建时需要设定缓冲大小。</p><p><strong>创建一个有缓冲 channel</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span> <span class=nx>ch</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span></code></pre></div><blockquote><p>在有 goroutine 接收 channel 数据之前，可以先向 channel 中发送10个数据。</p></blockquote><h3 id=无缓冲-channel-与有缓冲-channel的区别>无缓冲 channel 与有缓冲 channel的区别
<a class=anchor href=#%e6%97%a0%e7%bc%93%e5%86%b2-channel-%e4%b8%8e%e6%9c%89%e7%bc%93%e5%86%b2-channel%e7%9a%84%e5%8c%ba%e5%88%ab>#</a></h3><p>现在，你可能想知道何时使用这两种类型。 这完全取决于你希望 goroutine 之间的通信如何进行。 无缓冲 channel 同步通信。 它们保证每次发送数据时，程序都会被阻止，直到有人从 channel 中读取数据。</p><p>相反，有缓冲 channel 将发送和接收操作解耦。 它们不会阻止程序，但你必须小心使用，因为可能最终会导致死锁（如前文所述）。 使用无缓冲 channel 时，可以控制可并发运行的 goroutine 的数量。 例如，你可能要对 API 进行调用，并且想要控制每秒执行的调用次数。 否则，你可能会被阻止。</p><h2 id=读取文件>读取文件
<a class=anchor href=#%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6>#</a></h2><h3 id=一次性全读>一次性全读
<a class=anchor href=#%e4%b8%80%e6%ac%a1%e6%80%a7%e5%85%a8%e8%af%bb>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>bytes</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=s>&#34;/Users/dp/tmp/0811/03/file.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;read file error.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>bytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=按行读取>按行读取
<a class=anchor href=#%e6%8c%89%e8%a1%8c%e8%af%bb%e5%8f%96>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;bufio&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>f</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;C:/Users/dp/go/src/0811/03/file.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;read file error.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>r</span> <span class=o>:=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>line</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>eof</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>ReadLine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>eof</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>break</span> <span class=c1>// read last line.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>line</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=优雅退出>优雅退出
<a class=anchor href=#%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba>#</a></h2><h3 id=不处理优雅退出>不处理优雅退出
<a class=anchor href=#%e4%b8%8d%e5%a4%84%e7%90%86%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;Welcome Gin Server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>server</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Addr</span><span class=p>:</span>    <span class=s>&#34;:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Handler</span><span class=p>:</span> <span class=nx>router</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>quit</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;-</span><span class=nx>quit</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;receive interrupt signal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Server Close:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server closed under request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Server closed unexpect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=优雅退出-1with-context>优雅退出 1（with context）
<a class=anchor href=#%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba-1with-context>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>// Create context that listens for the interrupt signal from the OS.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>stop</span> <span class=o>:=</span> <span class=nx>signal</span><span class=p>.</span><span class=nf>NotifyContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nf>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;Welcome Gin Server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>srv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Addr</span><span class=p>:</span>    <span class=s>&#34;:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Handler</span><span class=p>:</span> <span class=nx>router</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Initializing the server in a goroutine so that
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// it won&#39;t block the graceful shutdown handling below
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listen: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Listen for the interrupt signal.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Restore default behavior on the interrupt signal and notify user of shutdown.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nf>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;shutting down gracefully, press Ctrl+C again to force&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// The context is used to inform the server it has 5 seconds to finish
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// the request it is currently handling
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Server forced to shutdown: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=优雅退出-2without-context>优雅退出 2（without context）
<a class=anchor href=#%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba-2without-context>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>router</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;Welcome Gin Server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>srv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Addr</span><span class=p>:</span>    <span class=s>&#34;:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Handler</span><span class=p>:</span> <span class=nx>router</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Initializing the server in a goroutine so that
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// it won&#39;t block the graceful shutdown handling below
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listen: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Wait for interrupt signal to gracefully shutdown the server with
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// a timeout of 5 seconds.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=c1>// kill (no param) default send syscall.SIGTERM
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// kill -2 is syscall.SIGINT
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// kill -9 is syscall.SIGKILL but can&#39;t be catch, so don&#39;t need add it
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>quit</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=o>&lt;-</span><span class=nx>quit</span>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Shutting down server...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// The context is used to inform the server it has 5 seconds to finish
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// the request it is currently handling
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Server forced to shutdown: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=函数式选项模式>函数式选项模式
<a class=anchor href=#%e5%87%bd%e6%95%b0%e5%bc%8f%e9%80%89%e9%a1%b9%e6%a8%a1%e5%bc%8f>#</a></h2><p>函数式选项模式：Functional Options Pattern，是 Golang 中一种常用的设计模式，用于解决构造函数参数过多的问题。</p><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nf>NewServer</span><span class=p>(</span><span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=nf>SetHost</span><span class=p>(</span><span class=s>&#34;localhost&#34;</span><span class=p>),</span> <span class=nf>SetPort</span><span class=p>(</span><span class=mi>8081</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>Label</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=nx>Host</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=nx>Port</span>  <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewServer</span><span class=p>(</span><span class=nx>label</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>))</span> <span class=o>*</span><span class=nx>Server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Label</span><span class=p>:</span> <span class=nx>label</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>opt</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Option</span> <span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>SetHost</span><span class=p>(</span><span class=nx>host</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>Host</span> <span class=p>=</span> <span class=nx>host</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>SetPort</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int32</span><span class=p>)</span> <span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>Port</span> <span class=p>=</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=调用-api>调用 API
<a class=anchor href=#%e8%b0%83%e7%94%a8-api>#</a></h2><p>使用 Golang 调用 API 代码示例：</p><h3 id=get>Get
<a class=anchor href=#get>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetApi</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;https://baidu.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=post>Post
<a class=anchor href=#post>#</a></h3><p><strong>1 简单 Post</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>PostApi1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>json</span> <span class=o>:=</span> <span class=s>`{&#34;id&#34;:&#34;u-001&#34;,&#34;name&#34;:&#34;Jay&#34;,&#34;age&#34;:18}`</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Post</span><span class=p>(</span><span class=s>&#34;https://example.com/user&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>,</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>json</span><span class=p>)))</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2 附带 Header</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>PostApi2</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>// 1. json
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>//json := `{&#34;id&#34;:&#34;u-001&#34;,&#34;name&#34;:&#34;Jay&#34;,&#34;age&#34;:18}`
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>//req, _ := http.NewRequest(http.MethodPost, &#34;https://example.com/user&#34;, bytes.NewBuffer([]byte(json)))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=c1>// 2. map
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>reqBody</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;id&#34;</span><span class=p>:</span>   <span class=s>&#34;u-001&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;Jay&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;age&#34;</span><span class=p>:</span>  <span class=s>&#34;18&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>,</span> <span class=s>&#34;https://example.com/user&#34;</span><span class=p>,</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>reqBody</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;My_Custom_Header&#34;</span><span class=p>,</span> <span class=s>&#34;Value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>client</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>3 构造请求对象</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=kt>string</span> <span class=s>`json:&#34;id&#34;`</span>
</span></span><span class=line><span class=cl> <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl> <span class=nx>Age</span>  <span class=kt>int</span>    <span class=s>`json:&#34;age&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>PostApi3</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Id</span><span class=p>:</span>   <span class=s>&#34;u-001&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Jay&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span><span class=p>:</span>  <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>buf</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>buf</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Post</span><span class=p>(</span><span class=s>&#34;https://example.com/user&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>,</span> <span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>4 OAuth2</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// go get golang.org/x/oauth2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>getAccessToken</span><span class=p>()</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kd>var</span> <span class=nx>authCfg</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>clientcredentials</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ClientID</span><span class=p>:</span>     <span class=s>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ClientSecret</span><span class=p>:</span> <span class=s>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>TokenURL</span><span class=p>:</span>     <span class=s>&#34;https://example.com/connect/token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>EndpointParams</span><span class=p>:</span> <span class=nx>url</span><span class=p>.</span><span class=nx>Values</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;grant_type&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s>&#34;client_credentials&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>token</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>authCfg</span><span class=p>.</span><span class=nf>TokenSource</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()).</span><span class=nf>Token</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;get access token failed. ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>token</span><span class=p>.</span><span class=nx>AccessToken</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>OAuth2Api</span><span class=p>(){</span>
</span></span><span class=line><span class=cl> <span class=nx>json</span> <span class=o>:=</span> <span class=s>`{&#34;id&#34;:&#34;u-001&#34;,&#34;name&#34;:&#34;Jay&#34;,&#34;age&#34;:18}`</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>,</span> <span class=s>&#34;https://example.com/user&#34;</span><span class=p>,</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>json</span><span class=p>)))</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Bearer&#34;</span><span class=p>,</span> <span class=nf>getAccessToken</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>client</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>5 上传文件</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>FileApi</span><span class=p>(){</span>
</span></span><span class=line><span class=cl> <span class=nx>file</span><span class=p>,</span><span class=nx>err</span><span class=o>:=</span><span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;hello.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=kd>var</span> <span class=nx>reqBody</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl> <span class=nx>multiPartWriter</span><span class=o>:=</span><span class=nx>multipart</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>reqBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fileWriter</span><span class=p>,</span><span class=nx>err</span><span class=o>:=</span><span class=nx>multiPartWriter</span><span class=p>.</span><span class=nf>CreateFormFile</span><span class=p>(</span><span class=s>&#34;file_field&#34;</span><span class=p>,</span><span class=s>&#34;hello.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>_</span><span class=p>,</span><span class=nx>err</span><span class=p>=</span><span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>fileWriter</span><span class=p>,</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>fieldWriter</span><span class=p>,</span><span class=nx>err</span><span class=o>:=</span><span class=nx>multiPartWriter</span><span class=p>.</span><span class=nf>CreateFormField</span><span class=p>(</span><span class=s>&#34;normal_field&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>_</span><span class=p>,</span><span class=nx>err</span><span class=p>=</span><span class=nx>fieldWriter</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>multiPartWriter</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>,</span><span class=nx>err</span><span class=o>:=</span><span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>,</span><span class=s>&#34;http://example.com/file&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=nx>reqBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=nx>multiPartWriter</span><span class=p>.</span><span class=nf>FormDataContentType</span><span class=p>())</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nx>client</span><span class=o>:=</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span><span class=nx>err</span><span class=o>:=</span><span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span><span class=o>!=</span><span class=kc>nil</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Status: %s\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %d\n&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;StatusCode: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=调用-jenkins-api>调用 Jenkins API
<a class=anchor href=#%e8%b0%83%e7%94%a8-jenkins-api>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>JenkinsConfig</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>User</span>  <span class=kt>string</span> <span class=s>`json:&#34;user&#34;`</span>
</span></span><span class=line><span class=cl> <span class=nx>Token</span> <span class=kt>string</span> <span class=s>`json:&#34;token&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>jenkinsConf</span> <span class=o>*</span><span class=nx>JenkinsConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>jenkinsConf</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>JenkinsConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>:</span> <span class=s>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Token</span><span class=p>:</span> <span class=s>&#34;xxxxxx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>job</span> <span class=o>:=</span> <span class=s>&#34;jenkins-job-1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nf>disableJenkins</span><span class=p>(</span><span class=nx>job</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>disableJenkins</span><span class=p>(</span><span class=nx>job</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>// disabled jenkins job
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;https://jenkins.example.com/job/%s/disable&#34;</span><span class=p>,</span> <span class=nx>job</span><span class=p>),</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;new jenkins request failed: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>r</span><span class=p>.</span><span class=nf>SetBasicAuth</span><span class=p>(</span><span class=nx>jenkinsConf</span><span class=p>.</span><span class=nx>User</span><span class=p>,</span> <span class=nx>jenkinsConf</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;request failed: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Healthf</span><span class=p>(</span><span class=s>&#34;disable jenkins job [%s] successfully&#34;</span><span class=p>,</span> <span class=nx>job</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Warnf</span><span class=p>(</span><span class=s>&#34;disable jenkins job [%s] status [%d]&#34;</span><span class=p>,</span> <span class=nx>job</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=位运算>位运算
<a class=anchor href=#%e4%bd%8d%e8%bf%90%e7%ae%97>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> 位运算符：
</span></span></span><span class=line><span class=cl><span class=cm>  将数值，转为二进制后，按位操作
</span></span></span><span class=line><span class=cl><span class=cm> 按位&amp;：
</span></span></span><span class=line><span class=cl><span class=cm>  对应位的值如果都为 1 才为 1，有一个为 0 就为 0
</span></span></span><span class=line><span class=cl><span class=cm> 按位|：
</span></span></span><span class=line><span class=cl><span class=cm>  对应位的值如果都是 0 才为 0，有一个为 1 就为 1
</span></span></span><span class=line><span class=cl><span class=cm> 异或^：
</span></span></span><span class=line><span class=cl><span class=cm>  二元：a^b
</span></span></span><span class=line><span class=cl><span class=cm>   对应位的值不同为 1，相同为 0
</span></span></span><span class=line><span class=cl><span class=cm>  一元：^a
</span></span></span><span class=line><span class=cl><span class=cm>   按位取反：
</span></span></span><span class=line><span class=cl><span class=cm>    1---&gt;0
</span></span></span><span class=line><span class=cl><span class=cm>    0---&gt;1
</span></span></span><span class=line><span class=cl><span class=cm> 位清空：&amp;^
</span></span></span><span class=line><span class=cl><span class=cm>   对于 a &amp;^ b
</span></span></span><span class=line><span class=cl><span class=cm>    对于 b 上的每个数值
</span></span></span><span class=line><span class=cl><span class=cm>    如果为 0，则取 a 对应位上的数值
</span></span></span><span class=line><span class=cl><span class=cm>    如果为 1，则结果位就取 0
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm> 位移运算符：
</span></span></span><span class=line><span class=cl><span class=cm> &lt;&lt;：按位左移，将 a 转为二进制，向左移动 b 位
</span></span></span><span class=line><span class=cl><span class=cm>  a &lt;&lt; b
</span></span></span><span class=line><span class=cl><span class=cm> &gt;&gt;: 按位右移，将 a 转为二进制，向右移动 b 位
</span></span></span><span class=line><span class=cl><span class=cm>  a &gt;&gt; b
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>a</span> <span class=o>:=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl> <span class=nx>b</span> <span class=o>:=</span> <span class=mi>13</span>
</span></span><span class=line><span class=cl> <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> a: 60 0011 1100
</span></span></span><span class=line><span class=cl><span class=cm> b: 13 0000 1101
</span></span></span><span class=line><span class=cl><span class=cm> &amp;     0000 1100
</span></span></span><span class=line><span class=cl><span class=cm> |     0011 1101
</span></span></span><span class=line><span class=cl><span class=cm> ^   0011 0001
</span></span></span><span class=line><span class=cl><span class=cm> &amp;^    0011 0000
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm> a : 0000 0000 ... 0011 1100
</span></span></span><span class=line><span class=cl><span class=cm> ^   1111 1111 ... 1100 0011
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;a:%d, %b\n&#34;</span><span class=p>,</span><span class=nx>a</span><span class=p>,</span><span class=nx>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;b:%d, %b\n&#34;</span><span class=p>,</span><span class=nx>b</span><span class=p>,</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>res1</span> <span class=o>:=</span> <span class=nx>a</span> <span class=o>&amp;</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res1</span><span class=p>)</span> <span class=c1>// 12
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=nx>res2</span> <span class=o>:=</span> <span class=nx>a</span> <span class=p>|</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res2</span><span class=p>)</span> <span class=c1>// 61
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=nx>res3</span> <span class=o>:=</span> <span class=nx>a</span> <span class=p>^</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res3</span><span class=p>)</span> <span class=c1>// 49
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=nx>res4</span> <span class=o>:=</span> <span class=nx>a</span> <span class=o>&amp;^</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res4</span><span class=p>)</span> <span class=c1>// 48
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=nx>res5</span> <span class=o>:=</span> <span class=p>^</span><span class=nx>a</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>c</span><span class=o>:=</span><span class=mi>8</span>
</span></span><span class=line><span class=cl> <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> c : ... 0000 1000
</span></span></span><span class=line><span class=cl><span class=cm>       0000 100000
</span></span></span><span class=line><span class=cl><span class=cm> &gt;&gt;        0000 10
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl> <span class=nx>res6</span> <span class=o>:=</span> <span class=nx>c</span> <span class=o>&lt;&lt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>res7</span> <span class=o>:=</span> <span class=nx>c</span> <span class=o>&gt;&gt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=实现简易网络连接客户端>实现简易网络连接客户端
<a class=anchor href=#%e5%ae%9e%e7%8e%b0%e7%ae%80%e6%98%93%e7%bd%91%e7%bb%9c%e8%bf%9e%e6%8e%a5%e5%ae%a2%e6%88%b7%e7%ab%af>#</a></h2><p>实现类似 nc 的客户端命令工具：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ nc www.baidu.com <span class=m>80</span>
</span></span><span class=line><span class=cl>GET / HTTP/1.1 
</span></span></code></pre></div><blockquote><p>注意：需要连续两次回车，才会连接</p></blockquote><p>废话少说，上代码：</p><p><em>main.go</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;Usage: nc [host] [port]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>host</span><span class=p>,</span> <span class=nx>port</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=o>+</span><span class=s>&#34;:&#34;</span><span class=o>+</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Stdin</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}()</span>
</span></span><span class=line><span class=cl> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span> <span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go build -o nc main.go
</span></span><span class=line><span class=cl>$ ./nc www.baidu.com <span class=m>80</span>
</span></span><span class=line><span class=cl>GET / HTTP/1.1
</span></span></code></pre></div><h2 id=git>git
<a class=anchor href=#git>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>gitutil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/go-git/go-git/v5&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/go-git/go-git/v5/plumbing&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/go-git/go-git/v5/plumbing/transport/http&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Clone</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>git</span><span class=p>.</span><span class=nf>PlainClone</span><span class=p>(</span><span class=s>&#34;/var/app/ash&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>git</span><span class=p>.</span><span class=nx>CloneOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>URL</span><span class=p>:</span>           <span class=s>&#34;https://github.com/poneding/ash.git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ReferenceName</span><span class=p>:</span> <span class=nx>plumbing</span><span class=p>.</span><span class=nf>NewBranchReferenceName</span><span class=p>(</span><span class=s>&#34;master&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>Auth</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>BasicAuth</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>Username</span><span class=p>:</span> <span class=s>&#34;poneding&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;xxxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>Progress</span><span class=p>:</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=elasticsearch>elasticsearch
<a class=anchor href=#elasticsearch>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>esutil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/elastic/go-elasticsearch/v7&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewESClient2</span><span class=p>(</span><span class=nx>esAddress</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>elasticsearch</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>esAddress</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;Invalid parameters: esAddress.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>esConfig</span> <span class=o>:=</span> <span class=nx>elasticsearch</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span><span class=nx>Addresses</span><span class=p>:</span> <span class=nx>esAddress</span><span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>esClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>elasticsearch</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=nx>esConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;GetESClient ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>esClient</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>QueryLogs2</span><span class=p>(</span><span class=nx>esClient</span> <span class=o>*</span><span class=nx>elasticsearch</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>query</span> <span class=nx>QueryLogModel</span><span class=p>)</span> <span class=p>([]</span><span class=nx>LogModel</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>buf</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>index</span> <span class=o>:=</span> <span class=nx>query</span><span class=p>.</span><span class=nx>App</span> <span class=o>+</span> <span class=s>&#34;-*&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>q</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;query&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>   <span class=s>&#34;match_phrase&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;kubernetes.labels.app&#34;</span><span class=p>:</span> <span class=nx>query</span><span class=p>.</span><span class=nx>App</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>buf</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>q</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;QueryLogs ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>searchRes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>esClient</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithIndex</span><span class=p>(</span><span class=nx>index</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithBody</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>buf</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithQuery</span><span class=p>(</span><span class=nx>query</span><span class=p>.</span><span class=nx>Filter</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithFilterPath</span><span class=p>(</span><span class=s>&#34;hits.hits&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithSize</span><span class=p>(</span><span class=nx>query</span><span class=p>.</span><span class=nx>Size</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithSort</span><span class=p>(</span><span class=s>&#34;@timestamp:desc&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>esClient</span><span class=p>.</span><span class=nx>Search</span><span class=p>.</span><span class=nf>WithSource</span><span class=p>(</span><span class=s>&#34;@timestamp&#34;</span><span class=p>,</span><span class=s>&#34;level&#34;</span><span class=p>,</span><span class=s>&#34;log&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>defer</span> <span class=nx>searchRes</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>searchRes</span><span class=p>.</span><span class=nf>IsError</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;QueryLogs ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;es.Search ERROR:&#34;</span><span class=p>,</span> <span class=nx>searchRes</span><span class=p>.</span><span class=nf>Status</span><span class=p>(),</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()},</span> <span class=s>&#34; &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>searchRes</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>r</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;QueryLogs ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>res</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogModel</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>hit</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>[</span><span class=s>&#34;hits&#34;</span><span class=p>].(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})[</span><span class=s>&#34;hits&#34;</span><span class=p>].([]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span> <span class=o>:=</span> <span class=nx>hit</span><span class=p>.(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})[</span><span class=s>&#34;_source&#34;</span><span class=p>].(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=nx>logModel</span> <span class=o>:=</span> <span class=nx>LogModel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>source</span><span class=p>[</span><span class=s>&#34;@timestamp&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>),</span>
</span></span><span class=line><span class=cl>   <span class=nx>Log</span><span class=p>:</span>       <span class=nx>source</span><span class=p>[</span><span class=s>&#34;log&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>level</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>source</span><span class=p>[</span><span class=s>&#34;level&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>logModel</span><span class=p>.</span><span class=nx>Level</span> <span class=p>=</span> <span class=nx>level</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>source</span><span class=p>[</span><span class=s>&#34;msg&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>logModel</span><span class=p>.</span><span class=nx>Log</span> <span class=p>=</span> <span class=nx>log</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>logModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>es</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;github.com/olivere/elastic/v7&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;reflect&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewESClient</span><span class=p>(</span><span class=nx>esAddresses</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>elastic</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>elastic</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=nx>elastic</span><span class=p>.</span><span class=nf>SetSniff</span><span class=p>(</span><span class=kc>false</span><span class=p>),</span> <span class=nx>elastic</span><span class=p>.</span><span class=nf>SetURL</span><span class=p>(</span><span class=nx>esAddresses</span><span class=o>...</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;NewESClient ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>client</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>QueryLogs</span><span class=p>(</span><span class=nx>esClient</span> <span class=o>*</span><span class=nx>elastic</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>queryModel</span> <span class=nx>QueryLogModel</span><span class=p>)</span> <span class=p>([]</span><span class=nx>LogModel</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>res</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogModel</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>boolQuery</span> <span class=o>:=</span> <span class=nx>elastic</span><span class=p>.</span><span class=nf>NewBoolQuery</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=nx>index</span> <span class=o>:=</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>App</span> <span class=o>+</span> <span class=s>&#34;-*&#34;</span>
</span></span><span class=line><span class=cl> <span class=nx>query</span> <span class=o>:=</span> <span class=nx>esClient</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=nx>index</span><span class=p>).</span><span class=nf>FilterPath</span><span class=p>(</span><span class=s>&#34;hits.hits&#34;</span><span class=p>).</span><span class=nf>Sort</span><span class=p>(</span><span class=s>&#34;@timestamp&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Filter</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>boolQuery</span><span class=p>.</span><span class=nf>Filter</span><span class=p>(</span><span class=nx>elastic</span><span class=p>.</span><span class=nf>NewQueryStringQuery</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Filter</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Level</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>boolQuery</span><span class=p>.</span><span class=nf>Filter</span><span class=p>(</span><span class=nx>elastic</span><span class=p>.</span><span class=nf>NewMatchPhraseQuery</span><span class=p>(</span><span class=s>&#34;level&#34;</span><span class=p>,</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>Level</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>Page</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queryModel</span><span class=p>.</span><span class=nx>Page</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>Size</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queryModel</span><span class=p>.</span><span class=nx>Size</span> <span class=p>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>query</span> <span class=p>=</span> <span class=nx>query</span><span class=p>.</span><span class=nf>From</span><span class=p>((</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Page</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>).</span><span class=nf>Size</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>Size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>StartAt</span> <span class=o>==</span> <span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queryModel</span><span class=p>.</span><span class=nx>StartAt</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=o>-</span><span class=mi>15</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>).</span><span class=nf>UTC</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>queryModel</span><span class=p>.</span><span class=nx>EndAt</span> <span class=o>==</span> <span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queryModel</span><span class=p>.</span><span class=nx>EndAt</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UTC</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=nx>boolQuery</span><span class=p>.</span><span class=nf>Filter</span><span class=p>(</span><span class=nx>elastic</span><span class=p>.</span><span class=nf>NewRangeQuery</span><span class=p>(</span><span class=s>&#34;@timestamp&#34;</span><span class=p>).</span><span class=nf>Gte</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>StartAt</span><span class=p>).</span><span class=nf>Lte</span><span class=p>(</span><span class=nx>queryModel</span><span class=p>.</span><span class=nx>EndAt</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=nx>query</span> <span class=p>=</span> <span class=nx>query</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>boolQuery</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>queryRes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>query</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;QueryLogs ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>queryRes</span><span class=p>.</span><span class=nf>Each</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>LogModel</span><span class=p>{}))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.(</span><span class=nx>LogModel</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>res</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>LogModel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Level</span><span class=p>:</span>     <span class=nx>t</span><span class=p>.</span><span class=nx>Level</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Msg storing source log here.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Log</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Msg</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Log</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>App</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Kubernetes</span><span class=p>.</span><span class=nx>Labels</span><span class=p>.</span><span class=nx>App</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>QueryErrorLogs</span><span class=p>(</span><span class=nx>esClient</span> <span class=o>*</span><span class=nx>elastic</span><span class=p>.</span><span class=nx>Client</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>query</span> <span class=o>:=</span> <span class=nx>esClient</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=s>&#34;dev-core-*&#34;</span><span class=p>).</span><span class=nf>FilterPath</span><span class=p>(</span><span class=s>&#34;hits.hits&#34;</span><span class=p>).</span><span class=nf>Sort</span><span class=p>(</span><span class=s>&#34;@timestamp&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>).</span><span class=nf>Size</span><span class=p>(</span><span class=mi>100</span><span class=p>).</span><span class=nf>Query</span><span class=p>(</span><span class=nx>elastic</span><span class=p>.</span><span class=nf>NewMatchPhraseQuery</span><span class=p>(</span><span class=s>&#34;level&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>queryRes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>query</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;QueryLogs ERROR: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>queryRes</span><span class=p>.</span><span class=nf>Each</span><span class=p>(</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>LogModel</span><span class=p>{}))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.(</span><span class=nx>LogModel</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>Log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><p><a href=/go/go-testing/>« testing</a></p><p><a href=/go/gopkg-errors/>» gopkg-errors.md</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/poneding/blog/commit/d558b4f864a8b9cf1df3c1afab2835a56d2f733c title='最后修改者 poneding | 2024/06/12' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt>
<span>2024/06/12</span></a></div><div><a class="flex align-center" href=https://github.com/poneding/blog/edit/master/content/go/go.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=poneding/blog data-repo-id=R_kgDOMITIHg data-category=General data-category-id=DIC_kwDOMITIHs4CgB4x data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#资料>资料</a></li><li><a href=#golang-channel>Golang channel</a><ul><li><a href=#语法>语法</a></li><li><a href=#无缓冲-channel>无缓冲 channel</a></li><li><a href=#有缓冲-channel>有缓冲 channel</a></li><li><a href=#无缓冲-channel-与有缓冲-channel的区别>无缓冲 channel 与有缓冲 channel的区别</a></li></ul></li><li><a href=#读取文件>读取文件</a><ul><li><a href=#一次性全读>一次性全读</a></li><li><a href=#按行读取>按行读取</a></li></ul></li><li><a href=#优雅退出>优雅退出</a><ul><li><a href=#不处理优雅退出>不处理优雅退出</a></li><li><a href=#优雅退出-1with-context>优雅退出 1（with context）</a></li><li><a href=#优雅退出-2without-context>优雅退出 2（without context）</a></li></ul></li><li><a href=#函数式选项模式>函数式选项模式</a></li><li><a href=#调用-api>调用 API</a><ul><li><a href=#get>Get</a></li><li><a href=#post>Post</a></li></ul></li><li><a href=#调用-jenkins-api>调用 Jenkins API</a></li><li><a href=#位运算>位运算</a></li><li><a href=#实现简易网络连接客户端>实现简易网络连接客户端</a></li><li><a href=#git>git</a></li><li><a href=#elasticsearch>elasticsearch</a></li></ul></nav></div></aside></main></body></html>