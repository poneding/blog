<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ç§‹æ²³è½å¶</title><link>https://blog.poneding.com/aws/</link><description>Recent content on ç§‹æ²³è½å¶</description><generator>Hugo</generator><language>cn</language><atom:link href="https://blog.poneding.com/aws/index.xml" rel="self" type="application/rss+xml"/><item><title/><link>https://blog.poneding.com/aws/build-eks-cluster/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/build-eks-cluster/</guid><description>ğŸ  é¦–é¡µ / AWS / æ­å»ºEKSé›†ç¾¤
æ­å»ºEKSé›†ç¾¤ # å®‰è£…awsï¼Œkubectlå’Œeksctlå‘½ä»¤è¡Œå·¥å…· # å¼•è¨€ # å®‰è£…aws cli å®‰è£…kubectl cli å®‰è£…eksctl cli å®‰è£…aws cli # å‚è€ƒ # https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-install.html
å®‰è£…ç¤ºä¾‹ï¼ˆwindowsï¼‰ # ä¸‹è½½å®‰è£…åŒ…ï¼š https://awscli.amazonaws.com/AWSCLIV2.msi è¿è¡Œä¸‹è½½çš„å®‰è£…åŒ… ç¡®å®å®‰è£…æ˜¯å¦æˆåŠŸ aws --version ä½¿ç”¨Security Credentialsé…ç½®aws cli # è®¿é—®awsæ§åˆ¶å°ï¼šService =&amp;gt; IAM é€‰æ‹©IAM Userï¼Œä½¿ç”¨å­ç”¨æˆ·ï¼Œå¼ºçƒˆä¸å»ºè®®ä½¿ç”¨rootç”¨æˆ· è¿›å…¥ç”¨æˆ·è¯¦æƒ…é¡µé¢ï¼ŒSecurity Credentialsé¡µ åˆ›å»ºAccess Key æ‹·è´Access Key IDå’ŒSecret Access Key ä½¿ç”¨awså‘½ä»¤é…ç½® $ aws configure AWS Access Key ID [None]: ABCDEFGHIAZBERTUCNGG (æ›¿æ¢Access Key ID) AWS Secret Access Key [None]: uMe7fumK1IdDB094q2sGFhM5Bqt3HQRw3IHZzBDTm (æ›¿æ¢Secret Access Key) Default region name [None]: us-east-1 Default output format [None]: json æµ‹è¯•é…ç½®æ˜¯å¦ç”Ÿæ•ˆ aws ec2 describe-vpcs å¸è½½ï¼ˆwindowsï¼‰ # æ§åˆ¶é¢æ¿ =&amp;gt; ç¨‹åºå’ŒåŠŸèƒ½ï¼Œæ‰¾åˆ°aws cliï¼Œå¸è½½å³å¯ã€‚ å®‰è£…kubectl cli # å¦‚æœä½ ç¡®å®æ˜¯ä½¿ç”¨EKSçš„Kubernetesï¼Œå»ºè®®ä½¿ç”¨awsæä¾›çš„kubectlå‘½ä»¤å·¥å…·ã€‚</description></item><item><title/><link>https://blog.poneding.com/aws/cluster-autoscaler/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/cluster-autoscaler/</guid><description>ğŸ  é¦–é¡µ / AWS / Cluster AutoScaler
Cluster AutoScaler # æˆ‘å½“å‰å·²ç»æœ‰äº†ä¸€ä¸ªEKSæœåŠ¡æ­å»ºèµ·æ¥çš„K8sé›†ç¾¤ï¼Œæˆ‘ç°åœ¨å¸Œæœ›æˆ‘çš„é›†ç¾¤æ‹¥æœ‰è‡ªåŠ¨ä¼¸ç¼©ï¼ˆä½“ç°åœ¨èŠ‚ç‚¹çš„æ‰©ç¼©ï¼‰çš„èƒ½åŠ›ã€‚
å½“æˆ‘çš„é›†ç¾¤èµ„æºå……è¶³ï¼Œè€Œæˆ‘éƒ¨ç½²åœ¨é›†ç¾¤ä¸­çš„åº”ç”¨åªä½¿ç”¨åˆ°äº†å¾ˆå°‘é‡çš„èµ„æºï¼Œæˆ‘å¸Œæœ›é›†ç¾¤å›æ”¶èµ„æºä»¥èŠ‚çœè´¹ç”¨ï¼›å½“æˆ‘çš„åº”ç”¨æœåŠ¡è¶Šæ¥è¶Šå¤šï¼Œå½“å‰é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œæˆ‘å¸Œæœ›é›†ç¾¤èƒ½å¢åŠ èŠ‚ç‚¹ï¼Œä»¥æ»¡è¶³åº”ç”¨çš„éƒ¨ç½²æ¡ä»¶ã€‚
é‚£ä¹ˆæœ¬ç¯‡å°±æ˜¯ä»‹ç»å¦‚ä½•é€šè¿‡ä½¿ç”¨Kubernetes Cluster Autoscalerè®©ä½ çš„é›†ç¾¤æ‹¥æœ‰è‡ªåŠ¨ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œè€Œä¸ç”¨ä½ æ—¶åˆ»å…³æ³¨é›†ç¾¤çš„èµ„æºæ˜¯å¦è¿‡äºå®½æ¾æˆ–ç´§å¼ ã€‚
NodeGroupæ·»åŠ Tag # æˆ‘ä»¬åˆ›å»ºEKSæ—¶ï¼Œéœ€è¦å®šä¹‰NodeGroupï¼Œä¸€èˆ¬åœ¨è¿™ä¸ªNodeGroupä¸­å®šä¹‰:
asg_desired_capacityï¼šæœŸæœ›åˆ›å»ºçš„Nodeæ•°é‡ï¼›
asg_max_sizeï¼šæœ€å°Nodeæ•°é‡ï¼Œé»˜è®¤ä¸º1ï¼›
asg_min_sizeï¼šæœ€å¤§Nodeæ•°é‡ã€‚
å®šä¹‰çš„NodeGroupä¼šç”ŸæˆAuto Scaling Groupèµ„æºï¼Œå¹¶ä¸”ç”±Auto Scaling Groupæ¥ç®¡ç†Nodeçš„åˆ›å»ºã€‚
ç°åœ¨éœ€è¦åšçš„å°±æ˜¯ä¸ºä½ çš„Auto Scaling Groupæ·»åŠ Tagã€‚
tagé”®å€¼ï¼š
Tag Key Tag Value k8s.io/cluster-autoscaler/&amp;lt;your_cluster_name&amp;gt; owned k8s.io/cluster-autoscaler/enabled true ç¬¬ä¸€ä¸ªTag Keyä¸­çš„é›†ç¾¤å&amp;lt;your_cluster_name&amp;gt;éœ€è¦æ›¿æ¢ï¼›
Tag Valueçš„å€¼æ˜¯ä»€ä¹ˆä¸é‡è¦ï¼Œä¸»è¦æ˜¯éœ€è¦è¿™ä¸¤ä¸ªTag Keyæ¥è¯†åˆ«æ˜¯å¦å¯¹è¿™ä¸ªé›†ç¾¤å¼€å¯Auto Scalingçš„èƒ½åŠ›ã€‚
æ·»åŠ Policy # åˆ›å»ºIAMç­–ç•¥ï¼Œå°†æ–°åˆ›å»ºçš„ç­–ç•¥Attachåˆ°é›†ç¾¤èŠ‚ç‚¹ç»‘å®šçš„IAM roleä¸Šï¼Œè®©ä½ çš„é›†ç¾¤èŠ‚ç‚¹æ‹¥æœ‰è‡ªåŠ¨ä¼¸ç¼©çš„èƒ½åŠ›ã€‚
IAMç­–ç•¥Jsonå†…å®¹ï¼š
{ &amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;, &amp;#34;Statement&amp;#34;: [ { &amp;#34;Action&amp;#34;: [ &amp;#34;autoscaling:DescribeAutoScalingGroups&amp;#34;, &amp;#34;autoscaling:DescribeAutoScalingInstances&amp;#34;, &amp;#34;autoscaling:DescribeLaunchConfigurations&amp;#34;, &amp;#34;autoscaling:DescribeTags&amp;#34;, &amp;#34;autoscaling:SetDesiredCapacity&amp;#34;, &amp;#34;autoscaling:TerminateInstanceInAutoScalingGroup&amp;#34;, &amp;#34;ec2:DescribeLaunchTemplateVersions&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34; } ] } éƒ¨ç½²Cluster AutoScaler # åœ¨é›†ç¾¤ä¸­éƒ¨ç½²Cluster AutoScalerï¼Œå‡†å¤‡èµ„æºæ¸…å•æ–‡ä»¶cluster-autoscaler.</description></item><item><title/><link>https://blog.poneding.com/aws/create-eks-cluster/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/create-eks-cluster/</guid><description>ğŸ  é¦–é¡µ / AWS / åˆ›å»º EKS é›†ç¾¤
åˆ›å»º EKS é›†ç¾¤ # 1. EKSç®€ä»‹ # Amazon Elastic Kubernetes Service (Amazon EKS) æ˜¯ä¸€é¡¹æ‰˜ç®¡æœåŠ¡ï¼Œå¯è®©æ‚¨åœ¨ AWS ä¸Šè½»æ¾è¿è¡Œ Kubernetesï¼Œè€Œæ— éœ€æ”¯æŒæˆ–ç»´æŠ¤æ‚¨è‡ªå·±çš„ Kubernetes æ§åˆ¶å±‚é¢ã€‚Kubernetes æ˜¯ä¸€ä¸ªç”¨äºå®ç°å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†çš„è‡ªåŠ¨åŒ–çš„å¼€æºç³»ç»Ÿã€‚ï¼ˆè¯¥æ®µä»‹ç»æ¥è‡ªAmazon EKSæ–‡æ¡£ï¼Œæ›´å¤šäº†è§£ https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/what-is-eks.htmlï¼‰
2. eksctlåˆ›å»ºeksé›†ç¾¤ # 2.1 ä»€ä¹ˆæ˜¯eksctl # eksctlæ˜¯ä¸€ç§ç”¨äºåœ¨ Amazon EKS ä¸Šåˆ›å»ºå’Œç®¡ç† Kubernetes é›†ç¾¤çš„ç®€å•å‘½ä»¤è¡Œå®ç”¨ç¨‹åºã€‚eksctl å‘½ä»¤è¡Œå®ç”¨ç¨‹åºæä¾›äº†ä½¿ç”¨å·¥ä½œçº¿ç¨‹èŠ‚ç‚¹ä¸º Amazon EKS åˆ›å»ºæ–°é›†ç¾¤çš„æœ€å¿«ã€æœ€ç®€å•çš„æ–¹å¼ã€‚
eksctlæ›´å¤šäº†è§£ https://eksctl.io
2.2 ä¸ºä»€ä¹ˆç”¨eksctl # åˆ›å»ºEKSé›†ç¾¤å¯ä»¥åœ¨AWSçš„æ§åˆ¶å°åˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨AWSå¼€å‘çš„eksctlå·¥å…·åˆ›å»ºï¼Œä¸ºä»€ä¹ˆé€‰æ‹©ä½¿ç”¨eksctlåˆ›å»ºeksé›†ç¾¤å‘¢ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹åŸå› ï¼š
ç›´æ¥åœ¨AWSçš„æ§åˆ¶å°åˆ›å»ºé›†ç¾¤ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºå„ç§Roleï¼Œä»¥åŠé€‰æ‹©åˆé€‚çš„Subnetï¼ŒSecurity Groupç­‰ç¹æ‚æ“ä½œï¼Œä½ éœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¤šä¸ªé¡µé¢ï¼Œæ“ä½œè¿‡ç¨‹å¯èƒ½ä¹Ÿè¦æ—¶ä¸æ—¶å‚é˜…æ–‡æ¡£ï¼› eksctlåˆ›å»ºEKSé›†ç¾¤åªéœ€è¦ä¸€è¡Œeksctl create cluster &amp;lt;å‚æ•°&amp;gt;å‘½ä»¤å³å¯ï¼Œä¼šè‡ªåŠ¨çš„ç»™ä½ åˆ›å»ºRoleç­‰èµ„æºï¼› eksctlçš„å‘½ä»¤å¯ä»¥è®°å½•åˆ°è„šæœ¬ï¼Œä¾¿äºå¤ç”¨ã€‚ 2.3 å®‰è£…eksctlï¼ˆåŸºäºubuntuï¼‰ # ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½å¹¶æå–æœ€æ–°ç‰ˆæœ¬çš„ eksctlã€‚ curl --silent --location &amp;#34;https://github.com/weaveworks/eksctl/releases/download/latest_release/eksctl_$(uname -s)_amd64.tar.gz&amp;#34; | tar xz -C /tmp å°†æå–çš„äºŒè¿›åˆ¶æ–‡ä»¶ç§»è‡³ /usr/local/binã€‚ sudo mv /tmp/eksctl /usr/local/bin ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•æ‚¨çš„å®‰è£…æ˜¯å¦æˆåŠŸã€‚ eksctl version æ³¨æ„ï¼š</description></item><item><title/><link>https://blog.poneding.com/aws/eks-config-alb-ingress/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/eks-config-alb-ingress/</guid><description>ğŸ  é¦–é¡µ / AWS / EKSé…ç½® ALB Ingress
EKSé…ç½® ALB Ingress # å®˜æ–¹æ–‡æ¡£ï¼š https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/controller/installation/
éƒ¨ç½²Alb Ingress Controller # IAMä¸­åˆ›å»ºPolicyï¼Œç»™é›†ç¾¤çš„NodeèŠ‚ç‚¹çš„Roleæ·»åŠ è¯¥Policyã€‚
Policyçš„JSONé…ç½®å¦‚ä¸‹ï¼š
{ &amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;, &amp;#34;Statement&amp;#34;: [ { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;acm:DescribeCertificate&amp;#34;, &amp;#34;acm:ListCertificates&amp;#34;, &amp;#34;acm:GetCertificate&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;ec2:AuthorizeSecurityGroupIngress&amp;#34;, &amp;#34;ec2:CreateSecurityGroup&amp;#34;, &amp;#34;ec2:CreateTags&amp;#34;, &amp;#34;ec2:DeleteTags&amp;#34;, &amp;#34;ec2:DeleteSecurityGroup&amp;#34;, &amp;#34;ec2:DescribeAccountAttributes&amp;#34;, &amp;#34;ec2:DescribeAddresses&amp;#34;, &amp;#34;ec2:DescribeInstances&amp;#34;, &amp;#34;ec2:DescribeInstanceStatus&amp;#34;, &amp;#34;ec2:DescribeInternetGateways&amp;#34;, &amp;#34;ec2:DescribeNetworkInterfaces&amp;#34;, &amp;#34;ec2:DescribeSecurityGroups&amp;#34;, &amp;#34;ec2:DescribeSubnets&amp;#34;, &amp;#34;ec2:DescribeTags&amp;#34;, &amp;#34;ec2:DescribeVpcs&amp;#34;, &amp;#34;ec2:ModifyInstanceAttribute&amp;#34;, &amp;#34;ec2:ModifyNetworkInterfaceAttribute&amp;#34;, &amp;#34;ec2:RevokeSecurityGroupIngress&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;elasticloadbalancing:AddListenerCertificates&amp;#34;, &amp;#34;elasticloadbalancing:AddTags&amp;#34;, &amp;#34;elasticloadbalancing:CreateListener&amp;#34;, &amp;#34;elasticloadbalancing:CreateLoadBalancer&amp;#34;, &amp;#34;elasticloadbalancing:CreateRule&amp;#34;, &amp;#34;elasticloadbalancing:CreateTargetGroup&amp;#34;, &amp;#34;elasticloadbalancing:DeleteListener&amp;#34;, &amp;#34;elasticloadbalancing:DeleteLoadBalancer&amp;#34;, &amp;#34;elasticloadbalancing:DeleteRule&amp;#34;, &amp;#34;elasticloadbalancing:DeleteTargetGroup&amp;#34;, &amp;#34;elasticloadbalancing:DeregisterTargets&amp;#34;, &amp;#34;elasticloadbalancing:DescribeListenerCertificates&amp;#34;, &amp;#34;elasticloadbalancing:DescribeListeners&amp;#34;, &amp;#34;elasticloadbalancing:DescribeLoadBalancers&amp;#34;, &amp;#34;elasticloadbalancing:DescribeLoadBalancerAttributes&amp;#34;, &amp;#34;elasticloadbalancing:DescribeRules&amp;#34;, &amp;#34;elasticloadbalancing:DescribeSSLPolicies&amp;#34;, &amp;#34;elasticloadbalancing:DescribeTags&amp;#34;, &amp;#34;elasticloadbalancing:DescribeTargetGroups&amp;#34;, &amp;#34;elasticloadbalancing:DescribeTargetGroupAttributes&amp;#34;, &amp;#34;elasticloadbalancing:DescribeTargetHealth&amp;#34;, &amp;#34;elasticloadbalancing:ModifyListener&amp;#34;, &amp;#34;elasticloadbalancing:ModifyLoadBalancerAttributes&amp;#34;, &amp;#34;elasticloadbalancing:ModifyRule&amp;#34;, &amp;#34;elasticloadbalancing:ModifyTargetGroup&amp;#34;, &amp;#34;elasticloadbalancing:ModifyTargetGroupAttributes&amp;#34;, &amp;#34;elasticloadbalancing:RegisterTargets&amp;#34;, &amp;#34;elasticloadbalancing:RemoveListenerCertificates&amp;#34;, &amp;#34;elasticloadbalancing:RemoveTags&amp;#34;, &amp;#34;elasticloadbalancing:SetIpAddressType&amp;#34;, &amp;#34;elasticloadbalancing:SetSecurityGroups&amp;#34;, &amp;#34;elasticloadbalancing:SetSubnets&amp;#34;, &amp;#34;elasticloadbalancing:SetWebACL&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;iam:CreateServiceLinkedRole&amp;#34;, &amp;#34;iam:GetServerCertificate&amp;#34;, &amp;#34;iam:ListServerCertificates&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;cognito-idp:DescribeUserPoolClient&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;waf-regional:GetWebACLForResource&amp;#34;, &amp;#34;waf-regional:GetWebACL&amp;#34;, &amp;#34;waf-regional:AssociateWebACL&amp;#34;, &amp;#34;waf-regional:DisassociateWebACL&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;tag:GetResources&amp;#34;, &amp;#34;tag:TagResources&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;waf:GetWebACL&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;shield:DescribeProtection&amp;#34;, &amp;#34;shield:GetSubscriptionState&amp;#34;, &amp;#34;shield:DeleteProtection&amp;#34;, &amp;#34;shield:CreateProtection&amp;#34;, &amp;#34;shield:DescribeSubscription&amp;#34;, &amp;#34;shield:ListProtections&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; } ] } ä¸‹è½½alb-ingress-controller.</description></item><item><title/><link>https://blog.poneding.com/aws/eks-details/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/eks-details/</guid><description>ğŸ  é¦–é¡µ / AWS / EKSå°ç»†èŠ‚æ±‡æ€»
EKSå°ç»†èŠ‚æ±‡æ€» # å¦‚æœalbçš„ingressä½¿ç”¨äº†è‡ªå®šä¹‰çš„security groupï¼Œé‚£ä¹ˆéœ€è¦å°†è¯¥å®‰å…¨ç»„åŠ å…¥åˆ°worker
Â« EKSé…ç½® ALB Ingress
Â» EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆä¸€ï¼‰</description></item><item><title/><link>https://blog.poneding.com/aws/eks-intergrate-gitlab-auto-release-01/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/eks-intergrate-gitlab-auto-release-01/</guid><description>ğŸ  é¦–é¡µ / AWS / EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆä¸€ï¼‰
EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆä¸€ï¼‰ # ç³»åˆ—ä»‹ç»å¦‚ä½•ä½¿ç”¨Gitlab CI/CDè‡ªåŠ¨éƒ¨ç½²åº”ç”¨åˆ°EKSï¼ˆK8sï¼‰é›†ç¾¤ä¸­ã€‚æœ¬ç¯‡ä»‹ç»å¦‚ä½•åœ¨EKSï¼ˆK8sï¼‰é›†ç¾¤ä¸­ä¸ºGitlabçš„CI/CDåˆ›å»ºGitlab Runnerã€‚
Gitlabæ·»åŠ K8sé›†ç¾¤ # æ·»åŠ æ–¹å¼ # ç¬¬ä¸€ç§æ–¹å¼ï¼ŒåŸºäºå•ä¸ªä»“åº“æ·»åŠ K8sé›†ç¾¤ï¼š
è¿›å…¥Gitlabä»“åº“ï¼Œä¾æ¬¡ä»å·¦è¾¹èœå•æ Operations =&amp;gt; Kubernetesè¿›å…¥æ·»åŠ é¡µé¢ï¼Œç‚¹å‡»Add Kubernetes clusteræŒ‰é’®ã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„K8sé›†ç¾¤åªå¯¹è¯¥é¡¹ç›®ä»“åº“æœ‰æ•ˆã€‚
ç¬¬äºŒç§æ–¹å¼ï¼ŒåŸºäºGroupæ·»åŠ K8sé›†ç¾¤ï¼š
è¿›å…¥Gitlabä¸»é¡µï¼Œä¾æ¬¡ä»ä¸Šè¾¹èœå•æ Groups =&amp;gt; Your groupsï¼Œé€‰æ‹©Groupè¿›å…¥é¡µé¢ï¼Œç„¶åä¾æ¬¡ä»å·¦è¾¹èœå•æ Kuberentesè¿›å…¥æ·»åŠ é¡µé¢ï¼Œç‚¹å‡»Add Kubernetes clusterã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„K8sé›†ç¾¤å¯¹è¯¥Groupä¸‹çš„é¡¹ç›®ä»“åº“æœ‰æ•ˆã€‚
ç¬¬ä¸‰ç§æ–¹å¼ï¼ŒåŸºäºå…¨å±€æ·»åŠ K8sé›†ç¾¤ï¼š
è¿™ç§æ–¹å¼éœ€è¦ç”¨åˆ°gitlabçš„rootæƒé™ã€‚è¿›å…¥Gitlabä¸»é¡µï¼Œä»ä¸Šè¾¹èœå•æ Admin Area(æ‰³æ‰‹å›¾æ ‡) è¿›å…¥é¡µé¢ï¼Œç„¶åä¾æ¬¡ä»å·¦è¾¹èœå•æ Kuberentesè¿›å…¥æ·»åŠ é¡µé¢ï¼Œç‚¹å‡»Add Kubernetes clusterã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„K8sé›†ç¾¤å¯¹æ‰€æœ‰é¡¹ç›®ä»“åº“æœ‰æ•ˆã€‚
æ·»åŠ æ­¥éª¤ # æ·»åŠ å·²æœ‰çš„K8sé›†ç¾¤ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è·å–åˆ°å¯¹åº”çš„å€¼å¡«å…¥è¡¨å•å³å¯ã€‚
Cluster Nameï¼š è¿™ä¸ªå¯ä»¥è‡ªå®šä¹‰ï¼Œèƒ½è‡ªè¡ŒåŒºåˆ†å°±è¡Œã€‚
API URLï¼š è¿è¡Œä»¥ä¸‹å‘½ä»¤å¾—åˆ°è¾“å‡ºå€¼ï¼š
kubectl cluster-info | grep &amp;#39;Kubernetes master&amp;#39; | awk &amp;#39;/http/ {print $NF}&amp;#39; CA Certificateï¼š è¿è¡Œä»¥ä¸‹å‘½ä»¤å¾—åˆ°è¾“å‡ºå€¼ï¼š
kubectl get secret $(kubectl get secret | grep default-token | awk &amp;#39;{print $1}&amp;#39;) -o jsonpath=&amp;#34;{[&amp;#39;data&amp;#39;][&amp;#39;ca\.</description></item><item><title/><link>https://blog.poneding.com/aws/eks-intergrate-gitlab-auto-release-02/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/eks-intergrate-gitlab-auto-release-02/</guid><description>ğŸ  é¦–é¡µ / AWS / EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆäºŒï¼‰
EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆäºŒï¼‰ # ç³»åˆ—ä»‹ç»å¦‚ä½•ä½¿ç”¨Gitlab CI/CDè‡ªåŠ¨éƒ¨ç½²åº”ç”¨åˆ°EKSï¼ˆK8sï¼‰é›†ç¾¤ä¸­ã€‚æœ¬ç¯‡ä»‹ç»å¦‚ä½•ä¸ºRunnré•œåƒçš„åˆ¶ä½œã€‚
ä¸Šæ–‡ä¸­åˆ›å»ºçš„Gitlab Runnerä¼šæŒç»­å­˜æ´»åœ¨EKSé›†ç¾¤ä¸­ï¼Œä½†æ˜¯å®ƒä¸åšå…·ä½“çš„Pipelineä»»åŠ¡ï¼Œå½“æœ‰Pipelineä»»åŠ¡æ¥ä¸´æ—¶ï¼Œç”±å®ƒæ¥åˆ›å»ºä¸´æ—¶çš„Runneræ¥æ‰§è¡Œã€‚è€Œä¸´æ—¶æ‹†åŠŸåˆ›å»ºçš„Runnerä½¿ç”¨ä»€ä¹ˆå®¹å™¨ç¯å¢ƒä»¥åŠå…·ä½“æ‰§è¡Œä»€ä¹ˆä»»åŠ¡æ˜¯ç”±ä»“åº“ç›®å½•ä¸‹.gitlab-ci.ymlæ–‡ä»¶å®šä¹‰çš„ã€‚
åˆ¶ä½œTemp Runneré•œåƒ # æˆ‘ä»¬åˆ¶ä½œè¿™ä¸ªé•œåƒçš„ç›®çš„æ˜¯ä¸ºäº†èƒ½è®©é•œåƒè¿è¡Œèµ·æ¥åï¼Œå¯ä»¥å®Œæˆæˆ‘ä»¬çš„è‡ªåŠ¨å‘å¸ƒä»»åŠ¡ã€‚æ¯”å¦‚åœ¨å®¹å™¨temp-runnerå®¹å™¨éœ€è¦å°†æˆ‘ä»¬çš„ä»£ç buildæˆåº”ç”¨é•œåƒï¼Œç„¶åå°†åº”ç”¨é•œåƒå‘å¸ƒåˆ°EKSé›†ç¾¤ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®¹å™¨ä¸­æˆ‘ä»¬å°±å¿…é¡»å¯ä»¥ä½¿ç”¨docker buildåŠŸèƒ½ä»¥åŠkubectl applyåŠŸèƒ½ã€‚
æŒ‰ç…§ä»¥ä¸Šçš„éœ€è¦ï¼Œæˆ‘ä»¬åˆ¶ä½œçš„é•œåƒè‡³å°‘éœ€è¦å®‰è£…å¥½docker ä»¥åŠkubectlã€‚
Dockerfileå¦‚ä¸‹ï¼š
FROM docker:18 RUN apk add --no-cache curl jq python3 git tar tree &amp;amp;&amp;amp; \ curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl &amp;amp;&amp;amp; chmod +x ./kubectl &amp;amp;&amp;amp; mv ./kubectl /usr/local/bin/kubectl ç›´æ¥ä½¿ç”¨dockeré•œåƒä½œä¸ºåŸºç¡€é•œåƒï¼Œç„¶åå®‰è£…kubectl
ä½¿ç”¨å‘½ä»¤åˆ¶ä½œå¹¶æ¨é€é•œåƒåˆ°dockerhubï¼ˆå®é™…æˆ‘çš„é•œåƒæ¨åŠ¨åˆ°äº†ECRï¼‰
docker build . -t gitlab-runner-base:latest --rm --no-cache docker push gitlab-runner-base:latest ä»“åº“é…ç½® # é¡¹ç›®ä»“åº“æ ¹ç›®å½•ä¸‹æ–°å¢.gitlab-ci.ymlæ–‡ä»¶ï¼Œç„¶åæ–‡ä»¶å†…å®¹
Â« EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆä¸€ï¼‰
Â» EKS-ä½¿ç”¨EFS</description></item><item><title/><link>https://blog.poneding.com/aws/eks-use-efs/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/eks-use-efs/</guid><description>ğŸ  é¦–é¡µ / AWS / EKS-ä½¿ç”¨EFS
EKS-ä½¿ç”¨EFS # åˆ›å»ºEFS
aws efs create-file-system \ --performance-mode generalPurpose \ --throughput-mode bursting \ --encrypted \ --tags Key=Name,Value=&amp;lt;fs-name&amp;gt; Key=creator,Value=dp Key=env:dev,Value=1 # ä¸Šé¢çš„å‘½ä»¤ä¼šå¾—åˆ°fs-id aws efs create-mount-target \ --file-system-id &amp;lt;fs-id&amp;gt; \ --subnet-id subnet-08d7609e614373fb8 \ --security-groups sg-0af0f0e8705380529 aws efs create-mount-target \ --file-system-id &amp;lt;fs-id&amp;gt; \ --subnet-id subnet-09c0707ea8ad281bb \ --security-groups sg-0af0f0e8705380529 aws efs create-mount-target \ --file-system-id &amp;lt;fs-id&amp;gt; \ --subnet-id subnet-063a8f10feb97868d \ --security-groups sg-0af0f0e8705380529 Â« EKSå®è·µ é›†æˆGitlabè‡ªåŠ¨å‘å¸ƒï¼ˆäºŒï¼‰
Â» Gitlab &amp;amp; EKS</description></item><item><title/><link>https://blog.poneding.com/aws/gitlab-eks/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/gitlab-eks/</guid><description>ğŸ  é¦–é¡µ / AWS / Gitlab &amp;amp; EKS
Gitlab &amp;amp; EKS # åˆ›å»ºIAM User&amp;amp;Group # Userï¼šgitlab-ciï¼Œä¿å­˜ç”Ÿæˆçš„Access key IDå’ŒSecret Access Keyï¼Œåé¢ä¼šç”¨åˆ°
Groupï¼šGitlab.CIï¼Œæ·»åŠ Policyå¦‚ä¸‹ï¼š
Policy Name AmazonEKSWorkerNodePolicy AmazonEC2ContainerRegistryFullAccess AmazonEC2ContainerRegistryReadOnly AmazonEC2ContainerServiceFullAccess AmazonEKS_CNI_Policy å°†user gitlab-ciæ·»åŠ åˆ°Group Gitlab.CI
å°†IAM Useræ·»åŠ åˆ°ConfigMap # kubectl edit cm aws-auth -n kube-system åœ¨mapUsersé”®è¿½åŠ ï¼š
- &amp;#34;groups&amp;#34;: - &amp;#34;system:masters&amp;#34; &amp;#34;userarn&amp;#34;: &amp;#34;arn:aws:iam::xxxxxxx:user/gitlab-ci&amp;#34; &amp;#34;username&amp;#34;: &amp;#34;gitlab-ci&amp;#34; Gitlabä»“åº“è®¾ç½® # Setting =&amp;gt; CI/CD =&amp;gt; Variablesï¼Œæ·»åŠ å˜é‡ï¼š
AWS_ACCESS_KEY_IDï¼š&amp;lt;gitlab-ciç”¨æˆ·çš„Access key ID&amp;gt; AWS_SECRET_ACCESS_KEYï¼š&amp;lt;gitlab-ciç”¨æˆ·çš„Secret Access Key&amp;gt; Gitlabä»“åº“.gitlab-ci.yml # Â« EKS-ä½¿ç”¨EFS
Â» K8s éƒ¨ç½² Kong æœåŠ¡</description></item><item><title/><link>https://blog.poneding.com/aws/k8s-deploy-kong/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/k8s-deploy-kong/</guid><description>ğŸ  é¦–é¡µ / AWS / K8s éƒ¨ç½² Kong æœåŠ¡
K8s éƒ¨ç½² Kong æœåŠ¡ # æœ¬ç¯‡åªæ¶‰åŠ Kong æœåŠ¡åœ¨ K8s é›†ç¾¤çš„éƒ¨ç½²æ“ä½œï¼Œä¸æ¶‰åŠæ¦‚å¿µçŸ¥è¯†ã€‚
æå‰å‡†å¤‡ # K8s é›†ç¾¤ï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ˜¯ AWS EKS é›†ç¾¤æœåŠ¡ ä¸€å°å¯ä»¥è¿æ¥ K8s é›†ç¾¤çš„æœåŠ¡å™¨ï¼Œå·²ç»å®‰è£… kubectl å’Œ docker ç­‰åŸºç¡€åº”ç”¨ï¼Œä¹‹åç§°ä¹‹ä¸ºæ“ä½œæœºå™¨ Postgres æ•°æ®åº“ï¼Œä½œä¸º Kong æœåŠ¡çš„åç«¯æ•°æ®åº“ åˆå§‹åŒ–æ•°æ®åº“ # ä½¿ç”¨ Postgres ä½œä¸º Kong æœåŠ¡çš„åç«¯æ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦æå‰åšæ•°æ®åº“çš„åˆå§‹åŒ–ï¼Œå‡†å¤‡ Kong æœåŠ¡éœ€è¦çš„æ•°æ®è¡¨ç­‰ã€‚è¿™é‡Œä½¿ç”¨ K8s-Job æ¥å®ç°æ•°æ®åº“çš„åˆå§‹åŒ–å·¥ä½œã€‚
kong-migrations-job.yamlï¼š
apiVersion: batch/v1 kind: Job metadata: name: kong-migrations namespace: kong spec: template: metadata: name: kong-migrations spec: containers: - command: - /bin/sh - -c - kong migrations bootstrap env: - name: KONG_PG_PASSWORD value: &amp;#34;kong&amp;#34; - name: KONG_PG_HOST value: &amp;#34;postgres/postgres&amp;#34; - name: KONG_PG_PORT value: &amp;#34;5432&amp;#34; image: kong:1.</description></item><item><title/><link>https://blog.poneding.com/aws/k8s-deploy-konga/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/k8s-deploy-konga/</guid><description>ğŸ  é¦–é¡µ / AWS / K8s éƒ¨ç½² konga
K8s éƒ¨ç½² konga # æœ¬ç¯‡åªæ¶‰åŠ konga çš„éƒ¨ç½²æ“ä½œï¼Œä¸æ¶‰åŠæ¦‚å¿µçŸ¥è¯†ã€‚
æå‰å‡†å¤‡ # K8s é›†ç¾¤ï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ˜¯ AWS EKS é›†ç¾¤æœåŠ¡ ä¸€å°å¯ä»¥è¿æ¥ K8s é›†ç¾¤çš„æœåŠ¡å™¨ï¼Œå·²ç»å®‰è£… kubectl å’Œ docker ç­‰åŸºç¡€åº”ç”¨ï¼Œä¹‹åç§°ä¹‹ä¸ºæ“ä½œæœºå™¨ Postgresæ•°æ®åº“ ï¼æ³¨æ„ï¼šè¯¥æ•°æ®åº“ä½¿ç”¨ 9.5 ç‰ˆæœ¬ï¼Œå…¶ä»–æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®åº“åœ¨åˆå§‹åŒ– konga æ•°æ®åº“æ—¶ä¼šæŠ¥å¦‚ä¸‹é”™ï¼š
error: Failed to prepare database: error: column r.consrc does not exist è¿™æ˜¯éƒ¨ç½² konga è¸©è¿‡çš„å‘ä¹‹ä¸€ã€‚
ç¡®ä¿ K8s é›†ç¾¤ä¸­å·²ç»åˆ›å»ºäº† nginx-ingressï¼Œnginx-ingress ç”¨äºæ ¹æ®å®šåˆ¶çš„ Ruleï¼ˆå¦‚åæ–‡ kong-ingress çš„é…ç½®ï¼‰å°†æµé‡è½¬å‘è‡³ K8s é›†ç¾¤çš„ Service ä¸­å»ã€‚ åˆ›å»º nginx-ingress æŒ‡ä»¤ï¼ˆå¯å‚ç…§ https://kubernetes.github.io/ingress-nginx/deploy/ï¼‰æ­¥éª¤å¦‚ä¸‹ï¼š
Step 1. æ‰§è¡Œä»¥ä¸‹å¼ºåˆ¶å‘½ä»¤
kubectl apply -f https://raw.</description></item><item><title/><link>https://blog.poneding.com/aws/k8s-deploy-postgres/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/k8s-deploy-postgres/</guid><description>ğŸ  é¦–é¡µ / AWS / K8s éƒ¨ç½² Postgres
K8s éƒ¨ç½² Postgres # æœ¬ç¯‡åªæ¶‰åŠ Postgres çš„éƒ¨ç½²æ“ä½œï¼Œä¸æ¶‰åŠæ¦‚å¿µçŸ¥è¯†ã€‚
ç‰¹åˆ«è¯´æ˜ï¼šPostgres ç›¸å¯¹äºæ™®é€šçš„ç¨‹åºåº”ç”¨è€Œè¨€ï¼Œå±äºæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œå› ä¸ºå®ƒå­˜å‚¨çš„æ•°æ®æ˜¯éœ€è¦æŒä¹…ä¿å­˜çš„ï¼Œè¿™ç‚¹å†³å®šäº†æˆ‘ä»¬é€‰æ‹© K8s-StatefulSet çš„éƒ¨ç½²è€Œé K8s-Deploymentã€‚
æå‰å‡†å¤‡ # K8s é›†ç¾¤ï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ˜¯AWS EKSé›†ç¾¤æœåŠ¡ ä¸€å°å¯ä»¥è¿æ¥ K8s é›†ç¾¤çš„æœåŠ¡å™¨ï¼Œå·²ç»å®‰è£… kubectl å’Œ docker ç­‰åŸºç¡€åº”ç”¨ K8sèµ„æºæ–‡ä»¶ # postgres-namespace.yamlï¼š
apiVersion: v1 kind: Namespace metadata: name: postgres postgres-config.yamlï¼š
apiVersion: v1 kind: ConfigMap metadata: name: postgres-config namespace: postgres labels: app: postgres data: POSTGRES_DB: master POSTGRES_USER: dba POSTGRES_PASSWORD: pg_pass è¿™é‡Œçš„æ•°æ®åº“å¯†ç æ¶‰åŠåˆ°ä¿¡æ¯æ•æ„Ÿï¼Œæ›´å»ºè®®ä½¿ç”¨ Secret èµ„æºè€Œé ConfigMapï¼Œè¿™é‡Œå°±å·æ‡’äº†ã€‚
postgres-statefulset.yamlï¼š
apiVersion: apps/v1 kind: StatefulSet metadata: name: postgres namespace: postgres spec: serviceName: &amp;#34;postgres&amp;#34; replicas: 1 selector: matchLabels: app: postgres template: metadata: labels: app: postgres spec: containers: - name: postgres image: postgres:9.</description></item><item><title/><link>https://blog.poneding.com/aws/terraform-remanage-resource/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://blog.poneding.com/aws/terraform-remanage-resource/</guid><description>ğŸ  é¦–é¡µ / AWS / Terraform é‡æ–°ç®¡ç†èµ„æº
Terraform é‡æ–°ç®¡ç†èµ„æº # çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä½ å¯èƒ½ä¼šæœ‰ç‚¹æ‡µï¼Œæˆ‘å…ˆæ¥è§£é‡Šä¸‹ã€‚
åœ¨ä½¿ç”¨Terraformç®¡ç†AWSçš„VPC-Subnetèµ„æºæ—¶ï¼ˆä¸‹é¢æ˜¯å®šä¹‰èµ„æºçš„ä»£ç æ¸…å•ï¼‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä¿®æ”¹aws_subnet.eks-private-subnet-1èµ„æºçš„cidr_blockæ—¶ï¼Œå‡è®¾æˆ‘ä¿®æ”¹æˆäº†172.28.2.0/24ï¼Œè¿™æ—¶å€™æ—§çš„
resource &amp;#34;aws_subnet&amp;#34; &amp;#34;eks-private-subnet-1&amp;#34; { vpc_id = &amp;#34;${var.vpc_id}&amp;#34; cidr_block = &amp;#34;172.28.1.0/24&amp;#34; map_public_ip_on_launch = &amp;#34;false&amp;#34; availability_zone = &amp;#34;${var.region}a&amp;#34; tags = merge( {Name = &amp;#34;${var.cluster_name}-private-subnet-1a&amp;#34;}, &amp;#34;${local.cluster_private_subnet_tags}&amp;#34;) } Â« K8s éƒ¨ç½² Postgres</description></item></channel></rss>